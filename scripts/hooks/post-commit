#!/bin/bash
# Auto-update CHANGES.md on every commit
# This hook is called after a successful commit

REPO_ROOT=$(git rev-parse --show-toplevel)
CHANGES_FILE="$REPO_ROOT/CHANGES.md"

# Get commit info
COMMIT_HASH=$(git rev-parse --short HEAD)
COMMIT_DATE=$(git log -1 --format=%ci)
COMMIT_MSG=$(git log -1 --format=%s)
COMMIT_BODY=$(git log -1 --format=%b)
AUTHOR=$(git log -1 --format=%an)
FILES_CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | head -20)
FILES_COUNT=$(git diff-tree --no-commit-id --name-only -r HEAD | wc -l | tr -d ' ')

# Format the entry
ENTRY="### ${COMMIT_DATE:0:10} - \`${COMMIT_HASH}\`

**${COMMIT_MSG}**

"

# Add body if exists
if [ -n "$COMMIT_BODY" ]; then
    ENTRY+="${COMMIT_BODY}

"
fi

# Add files changed
ENTRY+="<details>
<summary>Files changed (${FILES_COUNT})</summary>

\`\`\`
${FILES_CHANGED}
\`\`\`
</details>

---

"

# Append to CHANGES.md (after the AUTO-GENERATED marker)
if grep -q "AUTO-GENERATED BELOW" "$CHANGES_FILE"; then
    # Create temp file with new entry inserted after marker
    awk -v entry="$ENTRY" '
        /AUTO-GENERATED BELOW/ {
            print
            print ""
            print entry
            next
        }
        {print}
    ' "$CHANGES_FILE" > "$CHANGES_FILE.tmp"
    mv "$CHANGES_FILE.tmp" "$CHANGES_FILE"
else
    # If marker not found, append to end
    echo "$ENTRY" >> "$CHANGES_FILE"
fi

# Stage the updated CHANGES.md (will be included in next commit)
# Note: We don't commit here to avoid infinite loop
git add "$CHANGES_FILE" 2>/dev/null || true

echo "üìù CHANGES.md updated with commit ${COMMIT_HASH}"
