#!/bin/bash
# Auto-update CHANGES.md on every commit

REPO_ROOT=$(git rev-parse --show-toplevel)
CHANGES_FILE="$REPO_ROOT/CHANGES.md"

# Get commit info
COMMIT_HASH=$(git rev-parse --short HEAD)
COMMIT_DATE=$(git log -1 --format=%cd --date=short)
COMMIT_TIME=$(git log -1 --format=%cd --date=format:'%H:%M')
COMMIT_MSG=$(git log -1 --format=%s)
FILES_COUNT=$(git diff-tree --no-commit-id --name-only -r HEAD | wc -l | tr -d ' ')

# Create entry
TEMP_ENTRY=$(mktemp)
echo "### ${COMMIT_DATE} ${COMMIT_TIME} - \`${COMMIT_HASH}\`" > "$TEMP_ENTRY"
echo "" >> "$TEMP_ENTRY"
echo "**${COMMIT_MSG}**" >> "$TEMP_ENTRY"
echo "" >> "$TEMP_ENTRY"
echo "Files changed: ${FILES_COUNT}" >> "$TEMP_ENTRY"
echo "" >> "$TEMP_ENTRY"
echo "<details>" >> "$TEMP_ENTRY"
echo "<summary>Show files</summary>" >> "$TEMP_ENTRY"
echo "" >> "$TEMP_ENTRY"
echo '```' >> "$TEMP_ENTRY"
git diff-tree --no-commit-id --name-only -r HEAD | head -30 >> "$TEMP_ENTRY"
echo '```' >> "$TEMP_ENTRY"
echo "</details>" >> "$TEMP_ENTRY"
echo "" >> "$TEMP_ENTRY"
echo "---" >> "$TEMP_ENTRY"
echo "" >> "$TEMP_ENTRY"

# Check if CHANGES.md exists
if [ -f "$CHANGES_FILE" ] && grep -q "AUTO-GENERATED BELOW" "$CHANGES_FILE"; then
    # Get line number of marker
    MARKER_LINE=$(grep -n "AUTO-GENERATED BELOW" "$CHANGES_FILE" | cut -d: -f1)

    # Create new file: header + marker + new entry + old entries
    TEMP_FILE=$(mktemp)
    head -n "$MARKER_LINE" "$CHANGES_FILE" > "$TEMP_FILE"
    echo "" >> "$TEMP_FILE"
    cat "$TEMP_ENTRY" >> "$TEMP_FILE"

    # Append old entries (everything after marker line)
    tail -n +$((MARKER_LINE + 1)) "$CHANGES_FILE" >> "$TEMP_FILE"

    mv "$TEMP_FILE" "$CHANGES_FILE"
else
    # Create new file
    echo "# Change Log (Auto-Updated)" > "$CHANGES_FILE"
    echo "" >> "$CHANGES_FILE"
    echo "<!-- AUTO-GENERATED BELOW -->" >> "$CHANGES_FILE"
    echo "" >> "$CHANGES_FILE"
    cat "$TEMP_ENTRY" >> "$CHANGES_FILE"
fi

rm -f "$TEMP_ENTRY"

# Stage updated file
git add "$CHANGES_FILE" 2>/dev/null || true

echo "üìù CHANGES.md updated with commit ${COMMIT_HASH}"
