name: Deploy to Modal (Production)

on:
  push:
    branches: [ main ]
    paths:
      - 'modal_scanner.py'
      - 'modal_api*.py'
      - 'src/**'
      - 'requirements.txt'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy to Modal
    runs-on: ubuntu-latest
    # Only deploy on main branch or manual trigger
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Modal
      run: |
        python -m pip install --upgrade pip
        pip install modal

    - name: Configure Modal credentials
      env:
        MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
        MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
      run: |
        modal token set --token-id "$MODAL_TOKEN_ID" --token-secret "$MODAL_TOKEN_SECRET"

    - name: Deploy API to Modal
      run: |
        echo "Deploying StockStory API..."
        modal deploy modal_api_v2.py
        echo "‚úÖ API deployed successfully"

    - name: Deploy Scanner to Modal
      run: |
        echo "Deploying StockStory Scanner..."
        modal deploy modal_scanner.py
        echo "‚úÖ Scanner deployed successfully"

    - name: Verify deployment
      run: |
        echo "Verifying deployment..."
        sleep 5  # Wait for apps to register
        echo "Checking deployed apps..."
        modal app list
        echo ""
        echo "Verifying stockstory-api..."
        modal app list | grep -q "stockstory-api" && echo "‚úÖ API found" || echo "‚ö†Ô∏è API not found in list yet"
        echo "Verifying stockstory-scanner..."
        modal app list | grep -q "stockstory-scanner" && echo "‚úÖ Scanner found" || echo "‚ö†Ô∏è Scanner not found in list yet"
        echo "‚úÖ Deployment commands completed successfully"

    - name: Run health check
      run: |
        sleep 10  # Wait for deployment to stabilize
        curl -f https://zhuanleee--stockstory-api-create-fastapi-app.modal.run/health || echo "‚ö†Ô∏è Health check failed"

    - name: Deployment summary
      if: success()
      run: |
        echo "üöÄ Deployment successful!"
        echo "API: https://zhuanleee--stockstory-api-create-fastapi-app.modal.run"
        echo "Dashboard: https://zhuanleee--stockstory-api-create-fastapi-app.modal.run/admin/dashboard"
        echo "Docs: https://zhuanleee--stockstory-api-create-fastapi-app.modal.run/docs"

    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Deployment failed!"
        echo "Check logs for details"
