name: Check Modal Secrets

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  check-secrets:
    name: Verify Modal Configuration
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Modal
      run: |
        python -m pip install --upgrade pip
        pip install modal

    - name: Configure Modal credentials
      env:
        MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
        MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
      run: |
        modal token set --token-id "$MODAL_TOKEN_ID" --token-secret "$MODAL_TOKEN_SECRET"

    - name: List Modal secrets
      run: |
        echo "ðŸ“‹ Checking Modal secrets..."
        echo ""
        modal secret list
        echo ""
        echo "Looking for: stock-api-keys"

    - name: Test environment in Modal function
      run: |
        echo "ðŸ§ª Testing environment variables in Modal container..."

        # Create a test function to check env vars
        cat > test_env.py << 'EOF'
        import modal
        import os

        app = modal.App("test-env-check")
        image = modal.Image.debian_slim(python_version="3.11")

        @app.function(
            image=image,
            secrets=[modal.Secret.from_name("stock-api-keys")],
        )
        def check_env():
            """Check what environment variables are available."""
            keys_to_check = [
                'XAI_API_KEY',
                'DEEPSEEK_API_KEY',
                'TELEGRAM_BOT_TOKEN',
                'TELEGRAM_CHAT_ID',
                'POLYGON_API_KEY'
            ]

            print("=" * 70)
            print("ENVIRONMENT VARIABLES IN MODAL CONTAINER")
            print("=" * 70)

            for key in keys_to_check:
                value = os.environ.get(key, '')
                if value:
                    # Mask the value for security
                    masked = value[:4] + '...' + value[-4:] if len(value) > 8 else '***'
                    print(f"âœ“ {key}: {masked} (length: {len(value)})")
                else:
                    print(f"âœ— {key}: NOT SET")

            print("=" * 70)
            return "Check complete"

        @app.local_entrypoint()
        def main():
            check_env.remote()
        EOF

        modal run test_env.py

        echo ""
        echo "âœ… Environment check complete"
