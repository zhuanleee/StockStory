name: Deploy to Modal

on:
  push:
    branches: [main]
    paths:
      - 'modal_scanner.py'
      - 'modal_api.py'
      - 'modal_api_full.py'
      - 'src/**'
      - '.github/workflows/deploy_modal.yml'
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Modal
        run: pip install modal

      - name: Authenticate Modal
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          modal token set \
            --token-id "$MODAL_TOKEN_ID" \
            --token-secret "$MODAL_TOKEN_SECRET"

      - name: Deploy Scanner to Modal
        run: modal deploy modal_scanner.py

      - name: Deploy API to Modal
        run: modal deploy modal_api_full.py

      - name: Deployment complete
        run: |
          echo "‚úÖ Modal deployment complete!"
          echo "üìä Scanner deployed: Daily scans at 6 AM PST"
          echo "üåê API deployed: Dashboard endpoints live"
# Triggering deployment
