<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockStory</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìà</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Base Dark Theme (Enhanced) */
            --bg: #0a0a0f;
            --bg-elevated: #13131a;
            --bg-card: #1a1a24;
            --bg-card-hover: #222230;
            --bg-glass: rgba(26, 26, 36, 0.7);
            --bg-hover: #27272a;
            --border: #2a2a3a;
            --border-subtle: #1f1f2e;

            /* Text (Enhanced Contrast) */
            --text: #ffffff;
            --text-secondary: #e1e1e6;
            --text-muted: #9999a8;
            --text-disabled: #60606f;

            /* Semantic Colors (Enhanced) */
            --green: #10b981;
            --green-light: #34d399;
            --green-bg: rgba(16, 185, 129, 0.1);
            --green-gradient: linear-gradient(135deg, #10b981 0%, #34d399 100%);

            --red: #ef4444;
            --red-light: #f87171;
            --red-bg: rgba(239, 68, 68, 0.1);
            --red-gradient: linear-gradient(135deg, #ef4444 0%, #f87171 100%);

            --blue: #3b82f6;
            --blue-light: #60a5fa;
            --blue-bg: rgba(59, 130, 246, 0.1);
            --blue-gradient: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);

            --purple: #a855f7;
            --purple-light: #c084fc;
            --purple-bg: rgba(168, 85, 247, 0.1);
            --purple-gradient: linear-gradient(135deg, #a855f7 0%, #c084fc 100%);

            --yellow: #f59e0b;
            --yellow-light: #fbbf24;
            --yellow-bg: rgba(234, 179, 8, 0.1);
            --yellow-gradient: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);

            /* Premium Accents */
            --gold: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            --silver: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            --bronze: linear-gradient(135deg, #cd7f32 0%, #e09652 100%);

            /* Advanced Shadow System */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md:
                0 4px 6px -1px rgba(0, 0, 0, 0.4),
                0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg:
                0 10px 15px -3px rgba(0, 0, 0, 0.5),
                0 4px 6px -2px rgba(0, 0, 0, 0.4);
            --shadow-xl:
                0 20px 25px -5px rgba(0, 0, 0, 0.6),
                0 10px 10px -5px rgba(0, 0, 0, 0.5);
            --shadow-glow-blue: 0 0 20px rgba(59, 130, 246, 0.3);
            --shadow-glow-green: 0 0 20px rgba(16, 185, 129, 0.3);
            --shadow-glow-red: 0 0 20px rgba(239, 68, 68, 0.3);

            /* Typography Scale */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-family-mono: 'JetBrains Mono', 'Fira Code', monospace;

            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
            --text-4xl: 2.25rem;

            --font-light: 300;
            --font-normal: 400;
            --font-medium: 500;
            --font-semibold: 600;
            --font-bold: 700;
            --font-extrabold: 800;

            --leading-tight: 1.25;
            --leading-normal: 1.5;
            --leading-relaxed: 1.75;

            --tracking-tight: -0.025em;
            --tracking-normal: 0;
            --tracking-wide: 0.025em;
            --tracking-wider: 0.05em;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .market-pulse {
            display: flex;
            gap: 24px;
            font-size: 0.875rem;
        }

        .pulse-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pulse-label { color: var(--text-muted); }
        .pulse-value { font-weight: 600; }
        .pulse-value.up { color: var(--green); }
        .pulse-value.down { color: var(--red); }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
        }

        .btn-primary {
            background: var(--blue-gradient);
            color: white;
            font-weight: var(--font-semibold);
            box-shadow: var(--shadow-glow-blue);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow:
                0 8px 20px rgba(59, 130, 246, 0.4),
                var(--shadow-md);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        .btn-ghost:hover {
            background: var(--bg-hover);
            color: var(--text);
        }

        .update-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Sync Status */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--bg-hover);
            border-radius: 4px;
            cursor: pointer;
        }

        .sync-status:hover {
            background: var(--bg-card);
        }

        /* Sync Notifications */
        .sync-notification {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            min-width: 280px;
            max-width: 350px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
            transition: opacity 0.3s, transform 0.3s;
        }

        .sync-notification-success {
            border-left: 3px solid var(--green);
        }

        .sync-notification-warning {
            border-left: 3px solid var(--yellow);
        }

        .sync-notification-danger {
            border-left: 3px solid var(--red);
        }

        .sync-notification-info {
            border-left: 3px solid var(--blue);
        }

        .sync-notification-title {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .sync-notification-message {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Tabs */
        .tabs {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
        }

        .tabs-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 4px;
        }

        .tab {
            padding: 12px 20px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
        }

        .tab:hover { color: var(--text); }
        .tab.active {
            color: var(--text);
            border-bottom-color: var(--blue);
        }

        /* Main */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Grid */
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }
        .grid-sidebar { grid-template-columns: 1fr 320px; }

        @media (max-width: 1024px) {
            .grid-2, .grid-3, .grid-4, .grid-5, .grid-sidebar { grid-template-columns: 1fr; }
        }

        /* Cards */
        .card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        /* === PREMIUM COMPONENTS === */

        /* Glassmorphism Cards */
        .card-glass {
            background: var(--bg-glass);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-glass:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
            border-color: var(--border-subtle);
        }

        .card-glass-highlight {
            background: linear-gradient(
                135deg,
                rgba(59, 130, 246, 0.1) 0%,
                rgba(168, 85, 247, 0.1) 100%
            );
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        /* Gradient Buttons */
        .btn-gradient-primary {
            background: var(--blue-gradient);
            border: none;
            color: white;
            font-weight: var(--font-semibold);
            padding: 12px 24px;
            border-radius: 10px;
            box-shadow: var(--shadow-glow-blue);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .btn-gradient-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            transition: left 0.5s;
        }

        .btn-gradient-primary:hover::before {
            left: 100%;
        }

        .btn-gradient-primary:hover {
            transform: translateY(-2px);
            box-shadow:
                0 8px 20px rgba(59, 130, 246, 0.4),
                var(--shadow-md);
        }

        .btn-gradient-primary:active {
            transform: translateY(0);
        }

        .btn-gradient-success {
            background: var(--green-gradient);
            box-shadow: var(--shadow-glow-green);
        }

        .btn-gradient-success:hover {
            box-shadow:
                0 8px 20px rgba(16, 185, 129, 0.4),
                var(--shadow-md);
        }

        .btn-gradient-danger {
            background: var(--red-gradient);
            box-shadow: var(--shadow-glow-red);
        }

        .btn-gradient-danger:hover {
            box-shadow:
                0 8px 20px rgba(239, 68, 68, 0.4),
                var(--shadow-md);
        }

        /* Enhanced Stat Cards */
        .stat-card-modern {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--blue-gradient);
        }

        .stat-card-modern.positive::before {
            background: var(--green-gradient);
        }

        .stat-card-modern.negative::before {
            background: var(--red-gradient);
        }

        .stat-card-modern:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-value-modern {
            font-size: var(--text-4xl);
            font-weight: var(--font-bold);
            background: var(--blue-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .stat-value-modern.positive {
            background: var(--green-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-value-modern.negative {
            background: var(--red-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label-modern {
            font-size: var(--text-sm);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: var(--tracking-wider);
            font-weight: var(--font-medium);
        }

        /* Modern Progress Bars */
        .progress-modern {
            width: 100%;
            height: 8px;
            background: var(--bg-elevated);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-modern-bar {
            height: 100%;
            background: var(--blue-gradient);
            border-radius: 10px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            position: relative;
            overflow: hidden;
        }

        .progress-modern-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer-progress 2s infinite;
        }

        .progress-modern-bar.success {
            background: var(--green-gradient);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .progress-modern-bar.danger {
            background: var(--red-gradient);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        /* Premium Data Tables */
        .table-modern {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 4px;
        }

        .table-modern thead th {
            background: var(--bg-elevated);
            padding: 16px;
            text-align: left;
            font-size: var(--text-xs);
            font-weight: var(--font-semibold);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: var(--tracking-wider);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table-modern tbody tr {
            background: var(--bg-card);
            transition: all 0.2s ease;
        }

        .table-modern tbody tr:hover {
            background: var(--bg-card-hover);
            transform: scale(1.005);
            box-shadow: var(--shadow-md);
        }

        .table-modern tbody td {
            padding: 16px;
            border-top: 1px solid var(--border-subtle);
            border-bottom: 1px solid var(--border-subtle);
        }

        .table-modern tbody td:first-child {
            border-left: 1px solid var(--border-subtle);
            border-top-left-radius: 10px;
            border-bottom-left-radius: 10px;
        }

        .table-modern tbody td:last-child {
            border-right: 1px solid var(--border-subtle);
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;
        }

        /* Modern Badge/Pills */
        .badge-modern {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: var(--text-xs);
            font-weight: var(--font-semibold);
            letter-spacing: var(--tracking-wide);
            transition: all 0.2s ease;
        }

        .badge-modern.primary {
            background: rgba(59, 130, 246, 0.15);
            color: var(--blue-light);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .badge-modern.success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--green-light);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-modern.danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--red-light);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge-modern.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--yellow-light);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .badge-modern:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-sm);
        }

        /* === ANIMATIONS === */

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        .card-hover-float:hover {
            animation: float 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.6); }
        }

        .btn-pulse {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes shimmer-advanced {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        @keyframes shimmer-progress {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .skeleton-modern {
            background: linear-gradient(
                90deg,
                var(--bg-card) 0%,
                rgba(255, 255, 255, 0.05) 50%,
                var(--bg-card) 100%
            );
            background-size: 200% 100%;
            animation: shimmer-advanced 2s infinite;
            border-radius: 10px;
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-slide-in {
            animation: fadeSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* === END PREMIUM COMPONENTS === */

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-body { padding: 20px; }
        .card-body.no-padding { padding: 0; }

        /* Stats */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--blue-gradient);
        }

        .stat:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-label {
            font-size: var(--text-sm);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: var(--tracking-wider);
            margin-bottom: 8px;
            font-weight: var(--font-medium);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: var(--font-bold);
            line-height: 1.2;
        }

        .stat-value.green {
            background: var(--green-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-value.red {
            background: var(--red-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-value.blue {
            background: var(--blue-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat.positive::before {
            background: var(--green-gradient);
        }

        .stat.negative::before {
            background: var(--red-gradient);
        }

        /* Top Picks */
        .top-pick {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
        }

        .top-pick:hover { background: var(--bg-hover); }
        .top-pick:last-child { border-bottom: none; }

        .pick-rank {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--bg-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 12px;
        }

        .pick-rank.gold { background: var(--yellow-bg); color: var(--yellow); }
        .pick-rank.silver { background: var(--blue-bg); color: var(--blue); }
        .pick-rank.bronze { background: var(--purple-bg); color: var(--purple); }

        .pick-info { flex: 1; }

        .pick-ticker {
            font-weight: 600;
            font-size: 0.9375rem;
        }

        .pick-name {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .pick-score {
            text-align: right;
        }

        .pick-score-value {
            font-size: 1.125rem;
            font-weight: 700;
        }

        .pick-score-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .pick-theme {
            margin-left: 16px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 500;
            background: var(--blue-bg);
            color: var(--blue);
        }

        /* Theme Pills */
        .themes-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .theme-pill {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid var(--border);
            background: var(--bg-card);
        }

        .theme-pill:hover { border-color: var(--blue); }
        .theme-pill.active {
            background: var(--blue);
            border-color: var(--blue);
            color: white;
        }

        .theme-pill .count {
            margin-left: 6px;
            opacity: 0.7;
        }

        /* Theme Cards */
        .theme-stocks {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }

        .theme-stock {
            background: var(--bg-hover);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
        }

        .theme-stock:hover {
            background: var(--border);
        }

        .theme-stock-ticker {
            font-weight: 600;
            font-size: 0.9375rem;
            margin-bottom: 4px;
        }

        .theme-stock-change {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .theme-stock-change.up { color: var(--green); }
        .theme-stock-change.down { color: var(--red); }

        /* Table */
        .table-wrapper { overflow-x: auto; }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .table tr:hover { background: var(--bg-hover); }
        .table tr:last-child td { border-bottom: none; }

        .ticker-cell {
            font-weight: 600;
            color: var(--blue);
            cursor: pointer;
        }

        .ticker-cell:hover { text-decoration: underline; }

        .score-bar {
            width: 60px;
            height: 6px;
            background: var(--bg-hover);
            border-radius: 3px;
            overflow: hidden;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .score-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--blue), var(--green));
            border-radius: 3px;
        }

        /* Sidebar */
        .sidebar-card {
            margin-bottom: 16px;
        }

        .sidebar-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-item:last-child { border-bottom: none; }

        .sidebar-label {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .sidebar-value {
            font-size: 0.875rem;
            font-weight: 600;
        }

        /* Fear & Greed Gauge */
        .gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .gauge {
            width: 160px;
            height: 80px;
            position: relative;
        }

        .gauge-bg {
            width: 160px;
            height: 80px;
            border-radius: 80px 80px 0 0;
            background: linear-gradient(90deg, var(--red), var(--yellow), var(--green));
            position: relative;
            overflow: hidden;
        }

        .gauge-bg::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 50px;
            background: var(--bg-card);
            border-radius: 50px 50px 0 0;
        }

        .gauge-needle {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 4px;
            height: 60px;
            background: var(--text);
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(var(--rotation, 0deg));
            border-radius: 2px;
        }

        .gauge-value {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 16px;
        }

        .gauge-label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Alerts */
        .alert {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.8125rem;
            margin-bottom: 12px;
        }

        .alert.warning {
            background: var(--yellow-bg);
            border: 1px solid rgba(234, 179, 8, 0.3);
        }

        .alert.info {
            background: var(--blue-bg);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .alert-icon { font-size: 1rem; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 24px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover { color: var(--text); }

        .modal-body { padding: 24px; }

        /* Loading */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-hover) 25%, var(--border) 50%, var(--bg-hover) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content { flex-wrap: wrap; }
            .market-pulse { display: none; }
            .main { padding: 16px; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span>üìà</span>
                <span>Stock Scanner</span>
            </div>

            <div class="market-pulse" id="market-pulse">
                <div class="pulse-item">
                    <span class="pulse-label">SPY</span>
                    <span class="pulse-value" id="spy-change">--</span>
                </div>
                <div class="pulse-item">
                    <span class="pulse-label">QQQ</span>
                    <span class="pulse-value" id="qqq-change">--</span>
                </div>
                <div class="pulse-item">
                    <span class="pulse-label">VIX</span>
                    <span class="pulse-value" id="vix-value">--</span>
                </div>
                <div class="pulse-item">
                    <span class="pulse-label">Fear/Greed</span>
                    <span class="pulse-value" id="fear-greed">--</span>
                </div>
            </div>

            <div class="header-actions">
                <div class="sync-status" title="Telegram Sync Status">
                    <span id="sync-status-indicator" style="font-size: 0.75rem; color: var(--text-muted);">‚óã</span>
                    <span id="sync-status-text" style="font-size: 0.7rem; color: var(--text-muted);">OFFLINE</span>
                </div>
                <span class="update-time">Updated: <span id="last-update">--:--</span></span>
                <button class="btn btn-ghost" onclick="refreshAll()">‚Üª Refresh</button>
                <a href="https://t.me/Stocks_Story_Bot" target="_blank" class="btn btn-primary">Open Bot</a>
            </div>
        </div>
    </header>

    <!-- Tabs -->
    <nav class="tabs">
        <div class="tabs-inner">
            <div class="tab active" data-tab="overview">Overview</div>
            <div class="tab" data-tab="scan">Scan Results</div>
            <div class="tab" data-tab="themes">Themes</div>
            <div class="tab" data-tab="themeradar">Theme Radar</div>
            <div class="tab" data-tab="sec">SEC Intel</div>
            <div class="tab" data-tab="trades">Trades</div>
            <div class="tab" data-tab="analytics">Analytics</div>
            <div class="tab" data-tab="options">Options</div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <!-- Stats Row -->
            <div class="stats-row">
                <div class="stat">
                    <div class="stat-label">Stocks Scanned</div>
                    <div class="stat-value blue" id="stat-scanned">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Hot Opportunities</div>
                    <div class="stat-value green" id="stat-hot">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Developing</div>
                    <div class="stat-value" id="stat-developing">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Watchlist</div>
                    <div class="stat-value" id="stat-watchlist">0</div>
                </div>
            </div>

            <div class="grid grid-sidebar">
                <!-- Main Column -->
                <div>
                    <!-- Alerts -->
                    <div id="alerts-container"></div>

                    <!-- Top Opportunities -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">üéØ Top Opportunities</div>
                            <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="fetchScan()">Refresh</button>
                        </div>
                        <div class="card-body no-padding" id="top-picks">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìä</div>
                                <div>Loading opportunities...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Hot Themes -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üî• Hot Themes</div>
                        </div>
                        <div class="card-body">
                            <div class="themes-row" id="theme-pills">
                                
                            </div>
                            <div id="theme-stocks" style="margin-top: 20px;">
                                <div class="theme-stocks" id="theme-stocks-grid">
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div>
                    <!-- Fear & Greed -->
                    <div class="card sidebar-card">
                        <div class="card-header">
                            <div class="card-title">Fear & Greed</div>
                        </div>
                        <div class="card-body">
                            <div class="gauge-container">
                                <div class="gauge">
                                    <div class="gauge-bg"></div>
                                    <div class="gauge-needle" id="gauge-needle" style="--rotation: 0deg;"></div>
                                </div>
                                <div class="gauge-value" id="fg-value">--</div>
                                <div class="gauge-label" id="fg-label">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Market Health -->
                    <div class="card sidebar-card">
                        <div class="card-header">
                            <div class="card-title">Market Health</div>
                        </div>
                        <div class="card-body">
                            <div class="sidebar-item">
                                <span class="sidebar-label">Breadth Score</span>
                                <span class="sidebar-value" id="breadth-score">--</span>
                            </div>
                            <div class="sidebar-item">
                                <span class="sidebar-label">Advance/Decline</span>
                                <span class="sidebar-value" id="adv-dec">--</span>
                            </div>
                            <div class="sidebar-item">
                                <span class="sidebar-label">New Highs/Lows</span>
                                <span class="sidebar-value" id="hi-lo">--</span>
                            </div>
                            <div class="sidebar-item">
                                <span class="sidebar-label">Put/Call Ratio</span>
                                <span class="sidebar-value" id="put-call">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- High Conviction Alerts -->
                    <div class="card sidebar-card">
                        <div class="card-header">
                            <div class="card-title">üéØ High Conviction</div>
                            <button class="btn btn-ghost" style="padding: 2px 8px; font-size: 0.7rem;" onclick="fetchConvictionAlerts()">Refresh</button>
                        </div>
                        <div class="card-body" id="conviction-alerts-container">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading multi-signal alerts...</div>
                        </div>
                    </div>

                    <!-- Supply Chain Opportunities -->
                    <div class="card sidebar-card">
                        <div class="card-header">
                            <div class="card-title">üîó Supply Chain</div>
                            <button class="btn btn-ghost" style="padding: 2px 8px; font-size: 0.7rem;" onclick="fetchSupplyChain()">Refresh</button>
                        </div>
                        <div class="card-body" id="supplychain-container">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading lagging opportunities...</div>
                        </div>
                    </div>

                    <!-- Unusual Options Activity -->
                    <div class="card sidebar-card">
                        <div class="card-header">
                            <div class="card-title">üî• Unusual Options</div>
                            <button class="btn btn-ghost" style="padding: 2px 8px; font-size: 0.7rem;" onclick="fetchUnusualOptions()">Refresh</button>
                        </div>
                        <div class="card-body" id="unusual-options-container">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading unusual activity...</div>
                        </div>
                    </div>

                    <!-- Upcoming Earnings -->
                    <div class="card sidebar-card">
                        <div class="card-header">
                            <div class="card-title">üìÖ Earnings Soon</div>
                        </div>
                        <div class="card-body" id="earnings-sidebar">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading...</div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Quick Actions</div>
                        </div>
                        <div class="card-body" style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="padding: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px;">
                                <div style="font-size: 0.875rem; color: var(--text-muted);">
                                    ‚è∞ <strong>Automatic Daily Scan</strong><br>
                                    Runs every day at 6 AM PST with GPU acceleration<br>
                                    <span style="color: var(--green);">‚úì Last scan: 515 stocks analyzed</span>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="fetchScan()" style="width: 100%;">‚Üª Refresh Data</button>
                            <button class="btn btn-ghost" onclick="fetchBriefing()" style="width: 100%;">ü§ñ AI Briefing</button>
                            <div style="margin-top: 8px; padding: 8px; background: var(--blue-bg); border-radius: 6px; font-size: 0.75rem; color: var(--text-muted);">
                                üí° Manual scans disabled (Modal security). Data auto-refreshes daily.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scan Results Tab -->
        <div id="scan" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìä Scan Results</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" style="padding: 4px 12px; font-size: 0.75rem;" onclick="triggerScan('indices', event)">üîÑ Scan</button>
                        <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="triggerScan('full', event)">üåê Full</button>
                        <select id="filter-strength" class="btn btn-ghost" onchange="filterTable()">
                            <option value="">All Strength</option>
                            <option value="hot">Hot</option>
                            <option value="developing">Developing</option>
                            <option value="watchlist">Watchlist</option>
                        </select>
                        <select id="filter-theme" class="btn btn-ghost" onchange="filterTable()">
                            <option value="">All Themes</option>
                            
                        </select>
                    </div>
                </div>
                <div class="card-body no-padding">
                    <div class="table-wrapper">
                        <table class="table" id="scan-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Ticker</th>
                                    <th>Score</th>
                                    <th>Strength</th>
                                    <th>Theme</th>
                                    <th>Change</th>
                                    <th>Volume</th>
                                    <th>RS</th>
                                </tr>
                            </thead>
                            <tbody id="scan-table-body">
                                
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Themes Tab -->
        <div id="themes" class="tab-content">
            <div class="themes-row" style="margin-bottom: 24px;" id="all-themes">
                
            </div>

            <div class="grid grid-3" id="theme-cards">
                
            </div>
        </div>

        <!-- Theme Radar Tab (Theme Intelligence Hub) -->
        <div id="themeradar" class="tab-content">
            <div class="grid grid-3">
                <!-- Theme Radar Visual -->
                <div class="card" style="grid-column: span 2;">
                    <div class="card-header">
                        <div class="card-title">üì° Theme Radar</div>
                        <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="fetchThemeRadar()">Refresh</button>
                    </div>
                    <div class="card-body" id="theme-radar-container">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px;" id="theme-radar-grid">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading theme radar...</div>
                        </div>
                    </div>
                </div>

                <!-- Theme Alerts -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üö® Theme Alerts</div>
                    </div>
                    <div class="card-body" id="theme-alerts-container">
                        <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading alerts...</div>
                    </div>
                </div>
            </div>

            <!-- Theme Lifecycle Summary -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">üìä Theme Lifecycle Summary</div>
                    <button class="btn btn-primary" style="padding: 4px 12px; font-size: 0.75rem;" onclick="runThemeAnalysis()">Run Full Analysis</button>
                </div>
                <div class="card-body">
                    <div class="grid grid-5" id="lifecycle-summary">
                        <div class="stat" style="text-align: center;">
                            <div style="font-size: 1.5rem;">üå±</div>
                            <div class="stat-value" id="emerging-count">-</div>
                            <div class="stat-label">Emerging</div>
                        </div>
                        <div class="stat" style="text-align: center;">
                            <div style="font-size: 1.5rem;">üöÄ</div>
                            <div class="stat-value green" id="accelerating-count">-</div>
                            <div class="stat-label">Accelerating</div>
                        </div>
                        <div class="stat" style="text-align: center;">
                            <div style="font-size: 1.5rem;">üî•</div>
                            <div class="stat-value yellow" id="peak-count">-</div>
                            <div class="stat-label">At Peak</div>
                        </div>
                        <div class="stat" style="text-align: center;">
                            <div style="font-size: 1.5rem;">üìâ</div>
                            <div class="stat-value red" id="declining-count">-</div>
                            <div class="stat-label">Declining</div>
                        </div>
                        <div class="stat" style="text-align: center;">
                            <div style="font-size: 1.5rem;">üíÄ</div>
                            <div class="stat-value" id="dead-count">-</div>
                            <div class="stat-label">Dead</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Theme Details Table -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">üìã All Themes</div>
                </div>
                <div class="card-body no-padding">
                    <div class="table-container">
                        <table class="data-table" id="themes-detail-table">
                            <thead>
                                <tr>
                                    <th>Theme</th>
                                    <th>Lifecycle</th>
                                    <th>Score</th>
                                    <th>Velocity</th>
                                    <th>Tickers</th>
                                </tr>
                            </thead>
                            <tbody id="themes-detail-body">
                                <tr><td colspan="5" style="text-align: center; color: var(--text-muted);">Click "Refresh" to load data</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Ticker Theme Lookup -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">üéØ Ticker Theme Boost</div>
                </div>
                <div class="card-body">
                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <input type="text" id="ticker-theme-input" placeholder="Enter ticker (e.g., NVDA)..."
                            style="flex: 1; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.875rem;">
                        <button class="btn btn-primary" onclick="lookupTickerTheme()">Check Boost</button>
                    </div>
                    <div id="ticker-theme-result" style="font-size: 0.8125rem;"></div>
                </div>
            </div>

            <!-- Theme Management -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">Settings Theme Config</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="loadThemeConfig()">Refresh</button>
                        <button class="btn btn-primary" style="padding: 4px 12px; font-size: 0.75rem;" onclick="runAIDiscovery()">AI Discover</button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Add Theme Form -->
                    <div style="background: var(--bg); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 12px; font-size: 0.875rem;">Add New Theme</div>
                        <div style="display: grid; grid-template-columns: 1fr 2fr 1fr auto; gap: 12px; align-items: end;">
                            <div>
                                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Theme ID</label>
                                <input type="text" id="new-theme-id" placeholder="AI_AGENTS"
                                    style="width: 100%; padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.875rem;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Keywords (comma-separated)</label>
                                <input type="text" id="new-theme-keywords" placeholder="ai agent, autonomous, agentic"
                                    style="width: 100%; padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.875rem;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Tickers (comma-separated)</label>
                                <input type="text" id="new-theme-tickers" placeholder="AGNT, PLTR"
                                    style="width: 100%; padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.875rem;">
                            </div>
                            <button class="btn btn-primary" onclick="addNewTheme()">Add</button>
                        </div>
                    </div>

                    <!-- Theme Stats -->
                    <div id="theme-config-stats" style="display: flex; gap: 24px; margin-bottom: 16px; font-size: 0.875rem;">
                        <span>Total: <strong id="stat-total">-</strong></span>
                        <span style="color: var(--green);">Known: <strong id="stat-known">-</strong></span>
                        <span style="color: var(--yellow);">Emerging: <strong id="stat-emerging">-</strong></span>
                        <span style="color: var(--text-muted);">Archived: <strong id="stat-archived">-</strong></span>
                    </div>

                    <!-- Theme Config Table -->
                    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                        <table class="data-table" id="theme-config-table">
                            <thead style="position: sticky; top: 0; background: var(--bg-card);">
                                <tr>
                                    <th style="width: 150px;">Theme</th>
                                    <th style="width: 80px;">Status</th>
                                    <th>Keywords</th>
                                    <th>Tickers</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="theme-config-body">
                                <tr><td colspan="5" style="text-align: center; color: var(--text-muted);">Click "Refresh" to load themes</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- AI Discovered Themes -->
            <div class="card" style="margin-top: 20px; display: none;" id="ai-discovery-card">
                <div class="card-header">
                    <div class="card-title">AI Discovered Themes</div>
                </div>
                <div class="card-body" id="ai-discovery-results">
                </div>
            </div>
        </div>

        <!-- SEC Intelligence Tab -->
        <div id="sec" class="tab-content">
            <div class="grid grid-3">
                <!-- M&A Radar -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üîç M&A Radar</div>
                        <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="fetchMARadar()">Refresh</button>
                    </div>
                    <div class="card-body" id="ma-radar-container">
                        <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading M&A activity...</div>
                    </div>
                </div>

                <!-- Active Deals -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ü§ù Active Deals</div>
                        <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="fetchDeals()">Refresh</button>
                    </div>
                    <div class="card-body" id="deals-container">
                        <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading deals...</div>
                    </div>
                </div>

                <!-- Quick Lookup -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìã SEC Lookup</div>
                    </div>
                    <div class="card-body">
                        <div style="margin-bottom: 12px;">
                            <input type="text" id="sec-ticker-input" placeholder="Enter ticker..."
                                style="width: 100%; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.875rem;">
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-ghost" onclick="lookupSECFilings()" style="flex: 1;">Filings</button>
                            <button class="btn btn-ghost" onclick="lookupMACheck()" style="flex: 1;">M&A Check</button>
                            <button class="btn btn-ghost" onclick="lookupInsider()" style="flex: 1;">Insider</button>
                        </div>
                        <div id="sec-lookup-result" style="margin-top: 12px; font-size: 0.8125rem;"></div>
                    </div>
                </div>
            </div>

            <!-- Deal Tracker Table -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">üìä Deal Tracker</div>
                    <button class="btn btn-primary" style="padding: 4px 12px; font-size: 0.75rem;" onclick="showAddDealModal()">+ Add Deal</button>
                </div>
                <div class="card-body no-padding">
                    <div class="table-container">
                        <table class="data-table" id="deals-table">
                            <thead>
                                <tr>
                                    <th>Target</th>
                                    <th>Acquirer</th>
                                    <th>Deal $</th>
                                    <th>Current</th>
                                    <th>Spread</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="deals-table-body">
                                <tr><td colspan="6" style="text-align: center; color: var(--text-muted);">No deals tracked. Click + Add Deal to start.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recent SEC Filings Feed -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">üìÑ Recent Filings Feed</div>
                </div>
                <div class="card-body" id="filings-feed">
                    <div style="color: var(--text-muted); font-size: 0.8125rem;">Select a ticker above to view filings...</div>
                </div>
            </div>

            <!-- Government Contracts Section -->
            <div style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">
                <h3 style="font-size: 1rem; margin-bottom: 16px; color: var(--text);">üèõÔ∏è Government Contracts</h3>
                <p style="color: var(--text-muted); font-size: 0.8125rem; margin-bottom: 16px;">
                    Track federal spending on defense, tech, and infrastructure. Government contracts often signal sector momentum.
                </p>
                <div class="grid grid-3">
                    <!-- Contract Themes -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìä Theme Spending</div>
                            <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="fetchContractThemes()">Refresh</button>
                        </div>
                        <div class="card-body" id="contract-themes-container">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading contract data...</div>
                        </div>
                    </div>

                    <!-- Recent Contracts -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìã Recent Awards</div>
                            <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="fetchRecentContracts()">Refresh</button>
                        </div>
                        <div class="card-body" id="recent-contracts-container">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading recent contracts...</div>
                        </div>
                    </div>

                    <!-- Company Lookup -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üîç Company Lookup</div>
                        </div>
                        <div class="card-body">
                            <div style="margin-bottom: 12px;">
                                <input type="text" id="contract-ticker-input" placeholder="Enter ticker (e.g., LMT)..."
                                    style="width: 100%; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.875rem;">
                            </div>
                            <button class="btn btn-primary" onclick="lookupCompanyContracts()" style="width: 100%;">Search Contracts</button>
                            <div id="contract-lookup-result" style="margin-top: 12px; font-size: 0.8125rem;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patent Intelligence Section -->
            <div style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">
                <h3 style="font-size: 1rem; margin-bottom: 16px; color: var(--text);">üî¨ Patent Intelligence</h3>
                <p style="color: var(--text-muted); font-size: 0.8125rem; margin-bottom: 16px;">
                    Patents are filed 6-12 months before product launches. Track R&D activity as a leading indicator.
                </p>
                <div class="grid grid-3">
                    <!-- Patent Themes -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üè∑Ô∏è Theme Activity</div>
                            <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="fetchPatentThemes()">Refresh</button>
                        </div>
                        <div class="card-body" id="patent-themes-container">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading patent themes...</div>
                        </div>
                    </div>

                    <!-- Patent Lookup -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üîç Company Patents</div>
                        </div>
                        <div class="card-body">
                            <div style="margin-bottom: 12px;">
                                <input type="text" id="patent-ticker-input" placeholder="Enter ticker (e.g., NVDA)..."
                                    style="width: 100%; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.875rem;">
                            </div>
                            <button class="btn btn-primary" onclick="lookupCompanyPatents()" style="width: 100%;">Search Patents</button>
                            <div id="patent-lookup-result" style="margin-top: 12px; font-size: 0.8125rem;"></div>
                        </div>
                    </div>

                    <!-- Patent Stats -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìä Why Patents Matter</div>
                        </div>
                        <div class="card-body" style="font-size: 0.8125rem; color: var(--text-muted);">
                            <div style="margin-bottom: 8px;"><strong style="color: var(--green);">üìà Leading Indicator</strong><br>Patent filings precede product launches by 6-12 months</div>
                            <div style="margin-bottom: 8px;"><strong style="color: var(--blue);">üí∞ R&D Investment</strong><br>Surge in patents = heavy investment in area</div>
                            <div><strong style="color: var(--yellow);">üéØ Theme Discovery</strong><br>Track emerging tech before it hits the market</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trades Tab - Professional Trading Dashboard -->
        <div id="trades" class="tab-content">
            <!-- Enhanced Stats Row -->
            <div class="stats-row" style="grid-template-columns: repeat(6, 1fr);">
                <div class="stat">
                    <div class="stat-label">Open Positions</div>
                    <div class="stat-value blue" id="trade-positions-count">--</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Watchlist</div>
                    <div class="stat-value" id="trade-watchlist-count">--</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Total P&L</div>
                    <div class="stat-value" id="trade-total-pnl">--</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-value green" id="trade-win-rate">--</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Portfolio Risk</div>
                    <div class="stat-value" id="trade-risk-level">--</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Alerts</div>
                    <div class="stat-value red" id="trade-high-risk">--</div>
                </div>
            </div>

            <!-- Risk Alerts Banner -->
            <div id="trade-alerts-container"></div>

            <!-- Main 3-Column Layout -->
            <div style="display: grid; grid-template-columns: 1fr 380px; gap: 20px; margin-top: 20px;">
                <!-- Left Column - Positions & Journal -->
                <div>
                    <!-- AI Trade Advisor -->
                    <div class="card" style="margin-bottom: 20px; border-left: 3px solid var(--purple);">
                        <div class="card-header">
                            <div class="card-title">ü§ñ AI Trade Advisor</div>
                            <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="refreshAIAdvisor()">Refresh</button>
                        </div>
                        <div class="card-body" id="ai-advisor-container">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;" id="ai-recommendations">
                                <div style="background: var(--bg-hover); padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">PRIORITY ACTION</div>
                                    <div style="font-size: 1.1rem; font-weight: 600;" id="ai-priority-action">--</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">MARKET REGIME</div>
                                    <div style="font-size: 1.1rem; font-weight: 600;" id="ai-market-regime">--</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">OVERALL STANCE</div>
                                    <div style="font-size: 1.1rem; font-weight: 600;" id="ai-stance">--</div>
                                </div>
                            </div>
                            <div style="margin-top: 16px; padding: 12px; background: var(--bg-hover); border-radius: 8px;">
                                <div style="font-size: 0.8125rem; color: var(--text-muted);" id="ai-insight">Click refresh to get AI-powered trading insights based on your positions and market conditions...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Position Cards Grid -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">üìä Open Positions</div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="scanAllPositions()">üîç Scan All</button>
                                <button class="btn btn-primary" style="padding: 4px 12px; font-size: 0.75rem;" onclick="showAddTradeModal()">+ Add Trade</button>
                            </div>
                        </div>
                        <div class="card-body" id="position-cards-container">
                            <div style="color: var(--text-muted); text-align: center; padding: 40px;">Loading positions...</div>
                        </div>
                    </div>

                    <!-- Smart Trade Journal -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">üìì Trade Journal</div>
                            <div style="display: flex; gap: 8px;">
                                <select id="journal-filter" style="background: var(--bg-hover); border: 1px solid var(--border); color: var(--text); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;" onchange="filterJournal()">
                                    <option value="all">All Entries</option>
                                    <option value="trade">Trades</option>
                                    <option value="note">Notes</option>
                                    <option value="lesson">Lessons</option>
                                    <option value="mistake">Mistakes</option>
                                </select>
                                <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="showAddJournalEntry()">+ Add Entry</button>
                            </div>
                        </div>
                        <div class="card-body" id="journal-container" style="max-height: 400px; overflow-y: auto;">
                            <div style="color: var(--text-muted); text-align: center; padding: 20px;">Loading journal...</div>
                        </div>
                    </div>

                    <!-- Watchlist -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìã Watchlist</div>
                        </div>
                        <div class="card-body" id="watchlist-cards-container">
                            <div style="color: var(--text-muted); text-align: center; padding: 20px;">Loading watchlist...</div>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div>
                    <!-- Quick Actions -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">‚ö° Quick Actions</div>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <button class="btn btn-primary" style="padding: 10px;" onclick="showAddTradeModal()">üìù Add Trade</button>
                                <button class="btn btn-ghost" style="padding: 10px;" onclick="showBuyModal()">üí∞ Log Buy</button>
                                <button class="btn btn-ghost" style="padding: 10px;" onclick="showSellModal()">üíµ Log Sell</button>
                                <button class="btn btn-ghost" style="padding: 10px;" onclick="fetchDailyReport()">üìä Report</button>
                            </div>
                            <button class="btn btn-ghost" style="width: 100%; margin-top: 8px; padding: 10px;" onclick="showAddJournalEntry()">üìì Add Journal Entry</button>
                        </div>
                    </div>

                    <!-- Portfolio Summary with Charts -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">üíº Portfolio Overview</div>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">INVESTED</div>
                                    <div style="font-size: 1.1rem; font-weight: 600;" id="portfolio-invested">--</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">CURRENT</div>
                                    <div style="font-size: 1.1rem; font-weight: 600;" id="portfolio-value">--</div>
                                </div>
                            </div>
                            <div style="background: var(--bg-hover); padding: 16px; border-radius: 8px; text-align: center; margin-bottom: 16px;">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">TOTAL P&L</div>
                                <div style="font-size: 1.5rem; font-weight: 700;" id="portfolio-pnl">--</div>
                            </div>
                            <!-- Theme Concentration -->
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">THEME CONCENTRATION</div>
                            <div id="theme-concentration-chart" style="margin-bottom: 12px;">
                                <div style="color: var(--text-muted); font-size: 0.75rem;">No positions</div>
                            </div>
                        </div>
                    </div>

                    <!-- Scaling Opportunities -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">üìà Scale Signals</div>
                        </div>
                        <div class="card-body" id="scale-opportunities">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Run scan to detect opportunities...</div>
                        </div>
                    </div>

                    <!-- Performance Metrics -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">üìà Performance</div>
                        </div>
                        <div class="card-body">
                            <div class="sidebar-item">
                                <span class="sidebar-label">Avg Win</span>
                                <span class="sidebar-value green" id="perf-avg-win">--</span>
                            </div>
                            <div class="sidebar-item">
                                <span class="sidebar-label">Avg Loss</span>
                                <span class="sidebar-value red" id="perf-avg-loss">--</span>
                            </div>
                            <div class="sidebar-item">
                                <span class="sidebar-label">Profit Factor</span>
                                <span class="sidebar-value" id="perf-profit-factor">--</span>
                            </div>
                            <div class="sidebar-item">
                                <span class="sidebar-label">Best Trade</span>
                                <span class="sidebar-value green" id="perf-best">--</span>
                            </div>
                            <div class="sidebar-item">
                                <span class="sidebar-label">Worst Trade</span>
                                <span class="sidebar-value red" id="perf-worst">--</span>
                            </div>
                            <div class="sidebar-item">
                                <span class="sidebar-label">Avg Hold Time</span>
                                <span class="sidebar-value" id="perf-hold-time">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Options Flow -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìä Options Flow</div>
                            <button class="btn btn-ghost" onclick="refreshOptionsFlow()" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">Refresh</button>
                        </div>
                        <div class="card-body" id="options-flow-container">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Select a position to view options flow</div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üïê Activity Feed</div>
                        </div>
                        <div class="card-body" id="recent-activity" style="max-height: 200px; overflow-y: auto;">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">No recent activity</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="grid grid-2">
                <!-- Evolution Engine -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üß¨ Evolution Engine</div>
                    </div>
                    <div class="card-body">
                        <div class="sidebar-item">
                            <span class="sidebar-label">Learning Cycles</span>
                            <span class="sidebar-value" id="evo-cycles">--</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="sidebar-label">Overall Accuracy</span>
                            <span class="sidebar-value" id="evo-accuracy">--</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="sidebar-label">Calibration Score</span>
                            <span class="sidebar-value" id="evo-calibration">--</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="sidebar-label">Last Evolution</span>
                            <span class="sidebar-value" id="evo-last">--</span>
                        </div>
                    </div>
                </div>

                <!-- Adaptive Weights -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">‚öñÔ∏è Adaptive Weights</div>
                    </div>
                    <div class="card-body" id="weights-container">
                        <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading...</div>
                    </div>
                </div>

                <!-- Technical Signals -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìà Technical Signals</div>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                            <input
                                type="text"
                                id="technical-ticker-input"
                                placeholder="Ticker"
                                style="flex: 1; background: var(--bg-hover); border: 1px solid var(--border); color: var(--text); padding: 8px; border-radius: 6px; font-size: 0.8rem;"
                                onkeypress="if(event.key==='Enter') loadTechnicalIndicators()"
                            />
                            <button class="btn btn-ghost" onclick="loadTechnicalIndicators()" style="padding: 8px 16px; font-size: 0.75rem;">
                                Analyze
                            </button>
                        </div>
                        <div id="technical-indicators-container">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Enter a ticker to analyze</div>
                        </div>
                    </div>
                </div>

                <!-- Parameter Learning -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">‚öôÔ∏è Parameter Learning</div>
                    </div>
                    <div class="card-body">
                        <div class="sidebar-item">
                            <span class="sidebar-label">Total Parameters</span>
                            <span class="sidebar-value" id="param-total">--</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="sidebar-label">Parameters Learned</span>
                            <span class="sidebar-value" id="param-learned">--</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="sidebar-label">Learning Progress</span>
                            <span class="sidebar-value" id="param-progress">--</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="sidebar-label">Avg Confidence</span>
                            <span class="sidebar-value" id="param-confidence">--</span>
                        </div>
                    </div>
                </div>

                <!-- Correlations -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üîó Correlations</div>
                    </div>
                    <div class="card-body" id="correlations-container">
                        <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- AI Briefing -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">ü§ñ AI Market Briefing</div>
                    <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="fetchBriefing()">Refresh</button>
                </div>
                <div class="card-body" id="briefing-container">
                    <div style="color: var(--text-muted); font-size: 0.8125rem;">Click refresh to generate AI briefing...</div>
                </div>
            </div>
        </div>

        <!-- Options Tab -->
        <div id="options" class="tab-content">
            <!-- Ticker Search -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <div class="card-title">üîé Options Chain Lookup</div>
                </div>
                <div class="card-body">
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <input
                            type="text"
                            id="options-ticker-input"
                            placeholder="Enter ticker (e.g., AAPL, SPY)"
                            style="flex: 1; background: var(--bg-hover); border: 1px solid var(--border); color: var(--text); padding: 12px; border-radius: 8px; font-size: 0.9rem;"
                            onkeypress="if(event.key==='Enter') loadOptionsChain()"
                        />
                        <button class="btn btn-primary" onclick="loadOptionsChain()" style="padding: 12px 24px;">
                            Load Chain
                        </button>
                    </div>
                </div>
            </div>

            <!-- Summary Grid -->
            <div class="grid grid-4" id="options-summary" style="display: none; margin-bottom: 20px;">
                <div class="card">
                    <div class="card-body" style="text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">SENTIMENT</div>
                        <div style="font-size: 1.5rem; font-weight: 700;" id="opt-sentiment">--</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body" style="text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">PUT/CALL RATIO</div>
                        <div style="font-size: 1.5rem; font-weight: 700;" id="opt-pc-ratio">--</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body" style="text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">TOTAL CALL VOLUME</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--green);" id="opt-call-vol">--</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body" style="text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">TOTAL PUT VOLUME</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--red);" id="opt-put-vol">--</div>
                    </div>
                </div>
            </div>

            <!-- Options Tables -->
            <div class="grid grid-2" id="options-tables" style="display: none;">
                <!-- Calls Table -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìû Calls</div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div style="max-height: 600px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                                <thead style="position: sticky; top: 0; background: var(--bg-card); border-bottom: 1px solid var(--border);">
                                    <tr>
                                        <th style="padding: 8px; text-align: left;">Strike</th>
                                        <th style="padding: 8px; text-align: right;">Bid</th>
                                        <th style="padding: 8px; text-align: right;">Ask</th>
                                        <th style="padding: 8px; text-align: right;">Vol</th>
                                        <th style="padding: 8px; text-align: right;">OI</th>
                                        <th style="padding: 8px; text-align: right;">IV</th>
                                        <th style="padding: 8px; text-align: right;">Delta</th>
                                    </tr>
                                </thead>
                                <tbody id="calls-table-body">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                            Enter a ticker to load options chain
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Puts Table -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìâ Puts</div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div style="max-height: 600px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                                <thead style="position: sticky; top: 0; background: var(--bg-card); border-bottom: 1px solid var(--border);">
                                    <tr>
                                        <th style="padding: 8px; text-align: left;">Strike</th>
                                        <th style="padding: 8px; text-align: right;">Bid</th>
                                        <th style="padding: 8px; text-align: right;">Ask</th>
                                        <th style="padding: 8px; text-align: right;">Vol</th>
                                        <th style="padding: 8px; text-align: right;">OI</th>
                                        <th style="padding: 8px; text-align: right;">IV</th>
                                        <th style="padding: 8px; text-align: right;">Delta</th>
                                    </tr>
                                </thead>
                                <tbody id="puts-table-body">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                            Enter a ticker to load options chain
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market Options Sentiment -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">üìä Market Options Sentiment</div>
                    <button class="btn btn-ghost" onclick="loadMarketSentiment()" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">Refresh</button>
                </div>
                <div class="card-body">
                    <div class="grid grid-4" id="market-sentiment-grid">
                        <div style="text-align: center; padding: 12px;">
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">SPY P/C RATIO</div>
                            <div style="font-size: 1.25rem; font-weight: 700;" id="spy-pc-ratio">--</div>
                            <div style="font-size: 0.65rem; color: var(--text-muted);" id="spy-pc-label">Loading...</div>
                        </div>
                        <div style="text-align: center; padding: 12px;">
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">TOTAL GEX</div>
                            <div style="font-size: 1.25rem; font-weight: 700;" id="market-gex">--</div>
                            <div style="font-size: 0.65rem; color: var(--text-muted);" id="gex-label">Loading...</div>
                        </div>
                        <div style="text-align: center; padding: 12px;">
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">VIX LEVEL</div>
                            <div style="font-size: 1.25rem; font-weight: 700;" id="vix-level">--</div>
                            <div style="font-size: 0.65rem; color: var(--text-muted);" id="vix-label">Loading...</div>
                        </div>
                        <div style="text-align: center; padding: 12px;">
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">0DTE VOLUME</div>
                            <div style="font-size: 1.25rem; font-weight: 700;" id="zero-dte-vol">--</div>
                            <div style="font-size: 0.65rem; color: var(--text-muted);">Intraday</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Whale Trades & Unusual Activity -->
            <div class="grid grid-2" style="margin-top: 20px;">
                <!-- Whale Trades -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üêã Whale Trades (>$500K)</div>
                        <button class="btn btn-ghost" onclick="loadWhaleTrades()" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">Refresh</button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div style="max-height: 400px; overflow-y: auto;" id="whale-trades-container">
                            <div style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 0.8rem;">
                                Click Refresh to load whale trades
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Unusual Activity Feed -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">‚ö° Unusual Activity</div>
                        <button class="btn btn-ghost" onclick="loadUnusualActivity()" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">Refresh</button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div style="max-height: 400px; overflow-y: auto;" id="unusual-activity-container">
                            <div style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 0.8rem;">
                                Click Refresh to scan unusual activity
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Options Screener -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">üîç Options Screener</div>
                </div>
                <div class="card-body">
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
                        <div style="flex: 1; min-width: 150px;">
                            <label style="font-size: 0.7rem; color: var(--text-muted); display: block; margin-bottom: 4px;">Min Premium ($K)</label>
                            <input type="number" id="screener-min-premium" value="50" min="1" style="width: 100%; background: var(--bg-hover); border: 1px solid var(--border); color: var(--text); padding: 8px; border-radius: 6px; font-size: 0.8rem;" />
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="font-size: 0.7rem; color: var(--text-muted); display: block; margin-bottom: 4px;">Min IV Rank (%)</label>
                            <input type="number" id="screener-min-iv" value="50" min="0" max="100" style="width: 100%; background: var(--bg-hover); border: 1px solid var(--border); color: var(--text); padding: 8px; border-radius: 6px; font-size: 0.8rem;" />
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="font-size: 0.7rem; color: var(--text-muted); display: block; margin-bottom: 4px;">Sentiment</label>
                            <select id="screener-sentiment" style="width: 100%; background: var(--bg-hover); border: 1px solid var(--border); color: var(--text); padding: 8px; border-radius: 6px; font-size: 0.8rem;">
                                <option value="">Any</option>
                                <option value="bullish">Bullish Only</option>
                                <option value="bearish">Bearish Only</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="font-size: 0.7rem; color: var(--text-muted); display: block; margin-bottom: 4px;">Tickers (comma sep)</label>
                            <input type="text" id="screener-tickers" placeholder="NVDA,AAPL,TSLA" style="width: 100%; background: var(--bg-hover); border: 1px solid var(--border); color: var(--text); padding: 8px; border-radius: 6px; font-size: 0.8rem;" />
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn btn-primary" onclick="runOptionsScreener()" style="padding: 8px 20px;">Screen</button>
                        </div>
                    </div>
                    <div id="screener-results">
                        <div style="text-align: center; color: var(--text-muted); font-size: 0.8rem; padding: 20px;">
                            Configure filters and click Screen to find options opportunities
                        </div>
                    </div>
                </div>
            </div>

            <!-- Smart Money Flow Analysis -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">üí∞ Smart Money Flow Analysis</div>
                </div>
                <div class="card-body">
                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <input type="text" id="flow-ticker-input" placeholder="Enter ticker (e.g., NVDA)" style="flex: 1; background: var(--bg-hover); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 6px; font-size: 0.85rem;" onkeypress="if(event.key==='Enter') loadSmartMoneyFlow()" />
                        <button class="btn btn-primary" onclick="loadSmartMoneyFlow()" style="padding: 10px 20px;">Analyze Flow</button>
                    </div>
                    <div id="smart-money-flow-container">
                        <div style="text-align: center; color: var(--text-muted); font-size: 0.8rem; padding: 20px;">
                            Enter a ticker to analyze institutional and smart money options flow
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">Stock Details</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                Loading...
            </div>
        </div>
    </div>

    <!-- Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- Load modular JavaScript -->
    <script type="module" src="js/main.js"></script>

    <script>
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000/api'
            : 'https://zhuanleee--stockstory-api-create-fastapi-app.modal.run';

        // =============================================================================
        // DEBUG HELPER - Test API connection
        // =============================================================================
        window.testConnection = async function() {
            console.log('üß™ Testing API Connection...');
            console.log('üìç Current hostname:', window.location.hostname);
            console.log('üì° API_BASE:', API_BASE);
            console.log('');

            try {
                // Test 1: Health endpoint
                console.log('Test 1: Health endpoint');
                const healthUrl = `${API_BASE}/health`;
                console.log('  URL:', healthUrl);
                const healthRes = await fetch(healthUrl);
                console.log('  Status:', healthRes.status);
                const healthData = await healthRes.json();
                console.log('  Response:', healthData);
                console.log('');

                // Test 2: Scan endpoint
                console.log('Test 2: Scan endpoint');
                const scanUrl = `${API_BASE}/scan`;
                console.log('  URL:', scanUrl);
                const scanRes = await fetch(scanUrl);
                console.log('  Status:', scanRes.status);
                const scanData = await scanRes.json();
                console.log('  Response:', scanData);
                console.log('');

                console.log('‚úÖ Connection test complete!');
                console.log('üí° To manually refresh: refreshAll()');
                console.log('üí° To test scan fetch: fetchScan()');

                return { health: healthData, scan: scanData };
            } catch (e) {
                console.error('‚ùå Connection test failed:', e);
                return { error: e.message };
            }
        };

        // Log API configuration on page load
        console.log('üöÄ Stock Scanner Dashboard loaded');
        console.log('üì° API_BASE:', API_BASE);
        console.log('üí° Run testConnection() to verify API');

        // =============================================================================
        // SOCKET.IO SYNC CLIENT
        // =============================================================================

        class SyncClient {
            constructor() {
                this.socket = null;
                this.clientId = null;
                this.connected = false;
                this.eventHandlers = {};
            }

            connect() {
                // SocketIO is disabled on the backend
                // Real-time sync is not available in this deployment
                console.debug('Real-time sync disabled - SocketIO not available on backend');
                this.updateSyncStatus('unavailable');
                return;

                /* Disabled - SocketIO not enabled on backend
                try {
                    // Connect to same origin (API server) with Socket.IO
                    const serverUrl = API_BASE.replace('/api', '');
                    const isSecure = window.location.protocol === 'https:';
                    console.log('Connecting to sync server:', serverUrl);

                    this.socket = io(serverUrl, {
                        transports: ['polling'],  // Polling only - WebSocket upgrade fails on Railway
                        secure: isSecure,
                        reconnection: true,
                        reconnectionAttempts: 3,
                        reconnectionDelay: 3000,
                        reconnectionDelayMax: 10000,
                        timeout: 10000,
                    });

                    // Connection events
                    this.socket.on('connect', () => this.onConnect());
                    this.socket.on('disconnect', (reason) => this.onDisconnect(reason));
                    this.socket.on('connect_error', (error) => this.onError(error));

                    // Sync events
                    this.socket.on('connected', (data) => this.handleConnected(data));
                    this.socket.on('sync_history', (data) => this.handleSyncHistory(data));
                    this.socket.on('sync_event', (data) => this.handleSyncEvent(data));
                    this.socket.on('status', (data) => this.handleStatus(data));
                    this.socket.on('heartbeat_ack', () => {});
                    this.socket.on('error', (data) => console.debug('Sync error:', data));

                } catch (e) {
                    console.debug('Sync server unavailable');
                    this.updateSyncStatus('unavailable');
                }
                */
            }

            onConnect() {
                console.log('Real-time sync connected');
                this.connected = true;
                this.failCount = 0;
                this.updateSyncStatus('connected');
            }

            onDisconnect(reason) {
                console.debug('Sync disconnected:', reason);
                this.connected = false;
                this.updateSyncStatus('disconnected');
            }

            onError(error) {
                this.failCount = (this.failCount || 0) + 1;
                if (this.failCount <= 2) {
                    console.debug('Sync connection attempt', this.failCount);
                }
                if (this.failCount >= 3) {
                    // Give up quietly - sync is optional
                    this.updateSyncStatus('unavailable');
                    if (this.socket) {
                        this.socket.disconnect();
                    }
                    return;
                }
                this.updateSyncStatus('error');
            }

            handleConnected(data) {
                this.clientId = data.client_id;
                console.log('Sync client ID:', this.clientId);
                this.showNotification('Sync Connected', 'Real-time Telegram sync active', 'success');
            }

            handleSyncHistory(data) {
                const events = data.events || [];
                console.log(`Received ${events.length} historical events`);
                events.forEach(event => this.processEvent(event, false));
            }

            handleSyncEvent(data) {
                const event = data.event;
                if (event) {
                    this.processEvent(event, true);
                }
            }

            handleStatus(data) {
                this.updateSyncStatusDetails(data);
            }

            processEvent(event, notify = true) {
                const eventType = event.event_type;
                const source = event.source;
                const payload = event.payload || {};

                console.log(`Sync event: ${eventType} from ${source}`);

                // Handle different event types
                switch (eventType) {
                    case 'trade_created':
                        if (source === 'telegram' && notify) {
                            this.showNotification('Trade Added (Telegram)', `${payload.ticker} added to watchlist`, 'info');
                            fetchTrades();
                        }
                        break;

                    case 'buy_executed':
                        if (source === 'telegram' && notify) {
                            this.showNotification('Buy Executed (Telegram)', `${payload.shares} ${payload.ticker} @ $${payload.price}`, 'success');
                            fetchTrades();
                        }
                        break;

                    case 'sell_executed':
                        if (source === 'telegram' && notify) {
                            this.showNotification('Sell Executed (Telegram)', `${payload.shares} ${payload.ticker} @ $${payload.price}`, 'warning');
                            fetchTrades();
                        }
                        break;

                    case 'exit_signal':
                        if (notify) {
                            this.showNotification('Exit Signal', `${payload.ticker}: ${payload.signal_type}`, 'danger');
                        }
                        break;

                    case 'journal_added':
                        if (source === 'telegram' && notify) {
                            this.showNotification('Journal Entry (Telegram)', `${payload.entry_type}: ${(payload.content || '').slice(0, 50)}...`, 'info');
                            fetchJournal();
                        }
                        break;

                    case 'command_received':
                        if (notify) {
                            this.showNotification('Telegram Command', `/${payload.command} ${payload.args || ''}`, 'info');
                            addSyncActivityItem(`Telegram: /${payload.command} ${payload.args || ''}`, 'command');
                        }
                        break;

                    case 'scan_completed':
                        if (notify) {
                            this.showNotification('Scan Complete', `${payload.positions_scanned} positions, ${payload.signals_count} signals`, 'info');
                        }
                        break;
                }

                // Add to sync activity
                if (source === 'telegram' && notify) {
                    addSyncActivityItem(this.formatEventMessage(event), eventType.replace('_', '-'));
                }

                // Acknowledge event
                if (event.ack_required) {
                    this.send({ type: 'ack', event_id: event.id });
                }
            }

            formatEventMessage(event) {
                const p = event.payload;
                const formatters = {
                    'trade_created': () => `Added ${p.ticker} to watchlist`,
                    'buy_executed': () => `Bought ${p.shares} ${p.ticker} @ $${p.price}`,
                    'sell_executed': () => `Sold ${p.shares} ${p.ticker} @ $${p.price}`,
                    'exit_signal': () => `Exit signal for ${p.ticker}: ${p.signal_type}`,
                    'journal_added': () => `Journal: ${p.entry_type} - ${p.content?.slice(0, 30)}...`,
                    'command_received': () => `Command: /${p.command}`,
                    'scan_completed': () => `Scan: ${p.positions_scanned} positions`,
                };
                const formatter = formatters[event.event_type];
                return formatter ? formatter() : event.event_type;
            }

            send(data) {
                if (this.socket && this.connected) {
                    this.socket.emit('message', data);
                }
            }

            // Publish event to server
            publish(eventType, payload) {
                if (this.socket && this.connected) {
                    this.socket.emit('publish', {
                        event_type: eventType,
                        payload: payload
                    });
                }
            }

            // Request sync status
            requestStatus() {
                if (this.socket && this.connected) {
                    this.socket.emit('get_status');
                }
            }

            // Acknowledge event receipt
            ack(eventId) {
                if (this.socket && this.connected) {
                    this.socket.emit('ack', { event_id: eventId });
                }
            }

            updateSyncStatus(status) {
                const indicator = document.getElementById('sync-status-indicator');
                const text = document.getElementById('sync-status-text');

                if (!indicator || !text) return;

                const statusConfig = {
                    'connected': { color: 'var(--green)', text: 'SYNCED', icon: '‚óè' },
                    'disconnected': { color: 'var(--yellow)', text: 'OFFLINE', icon: '‚óã' },
                    'error': { color: 'var(--red)', text: 'ERROR', icon: '‚úï' },
                    'unavailable': { color: 'var(--text-muted)', text: 'N/A', icon: '‚óã' },
                };

                const config = statusConfig[status] || statusConfig.disconnected;
                indicator.style.color = config.color;
                indicator.textContent = config.icon;
                text.textContent = config.text;
                text.style.color = config.color;
            }

            updateSyncStatusDetails(status) {
                const el = document.getElementById('sync-details');
                if (el) {
                    el.innerHTML = `
                        <div>Clients: ${status.connected_clients || 0}</div>
                        <div>Events: ${status.total_events || 0}</div>
                    `;
                }
            }

            showNotification(title, message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `sync-notification sync-notification-${type}`;
                notification.innerHTML = `
                    <div class="sync-notification-title">${title}</div>
                    <div class="sync-notification-message">${message}</div>
                `;

                // Add to container
                let container = document.getElementById('sync-notifications');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'sync-notifications';
                    container.style.cssText = 'position: fixed; top: 70px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 8px;';
                    document.body.appendChild(container);
                }
                container.appendChild(notification);

                // Auto-remove after 5 seconds
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            }
        }

        // Global sync client
        const syncClient = new SyncClient();

        // Sync activity helper
        function addSyncActivityItem(message, type = 'sync') {
            const activityItems = window.activityItems || [];
            activityItems.unshift({
                message: `[SYNC] ${message}`,
                type: type,
                timestamp: new Date().toISOString()
            });
            window.activityItems = activityItems;
            if (typeof renderActivityFeed === 'function') {
                renderActivityFeed();
            }
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                switchTab(tabId);
            });
        });

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // Auto-load data for specific tabs
            if (tabId === 'themeradar') {
                fetchThemeRadar();
                loadThemeConfig();
            } else if (tabId === 'sec') {
                fetchMARadar();
                fetchDeals();
            } else if (tabId === 'trades') {
                fetchTrades();
            } else if (tabId === 'options') {
                fetchUnusualOptions();
                loadMarketSentiment();
            }
        }

        // Modal
        function openModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal-overlay').classList.add('active');
        }

        function closeModal(e) {
            if (!e || e.target === document.getElementById('modal-overlay')) {
                document.getElementById('modal-overlay').classList.remove('active');
            }
        }

        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

        // Show ticker details
        async function showTicker(ticker) {
            openModal(ticker, '<div style="text-align: center; padding: 20px;">Loading...</div>');
            try {
                // Fetch both stock data and options overview in parallel
                const [stockRes, optionsRes] = await Promise.all([
                    fetch(`${API_BASE}/ticker/${ticker}`),
                    fetch(`${API_BASE}/options/overview/${ticker}`)
                ]);

                const data = await stockRes.json();
                const optionsData = await optionsRes.json();

                if (data.ok && data.stock) {
                    const s = data.stock;
                    let content = `
                        <div style="display: grid; gap: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: 700;">${s.ticker}</div>
                                    <div style="color: var(--text-muted);">${s.sector || 'N/A'}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.25rem; font-weight: 600;">Score: ${(s.story_score || 0).toFixed(1)}</div>
                                    <div style="color: var(--text-muted);">${s.story_strength || 'N/A'}</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Change</div>
                                    <div style="font-weight: 600; color: ${(s.change_pct || 0) >= 0 ? 'var(--green)' : 'var(--red)'};">${(s.change_pct || 0) >= 0 ? '+' : ''}${(s.change_pct || 0).toFixed(2)}%</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Volume</div>
                                    <div style="font-weight: 600;">${formatVolume(s.volume || 0)}</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">RS Rating</div>
                                    <div style="font-weight: 600;">${(s.rs_rating || 0).toFixed(0)}</div>
                                </div>
                            </div>
                            ${s.hottest_theme ? `<div style="padding: 8px 12px; background: var(--blue-bg); border-radius: 8px; font-size: 0.875rem;"><strong>Theme:</strong> ${s.hottest_theme}</div>` : ''}
                            ${s.catalyst ? `<div style="padding: 8px 12px; background: var(--yellow-bg); border-radius: 8px; font-size: 0.875rem;"><strong>Catalyst:</strong> ${s.catalyst}</div>` : ''}
                    `;

                    // Add options overview if available
                    if (optionsData.ok && optionsData.data && !optionsData.data.error) {
                        const opts = optionsData.data;
                        const flow = opts.flow || {};
                        const unusual = opts.unusual_activity || {};

                        if (flow.sentiment || flow.put_call_ratio) {
                            const sentiment = flow.sentiment || 'neutral';
                            const sentimentColor = sentiment === 'bullish' ? 'var(--green)' :
                                                   sentiment === 'bearish' ? 'var(--red)' :
                                                   'var(--text-muted)';

                            content += `
                                <div style="padding: 12px; background: var(--bg-hover); border-radius: 8px; border-left: 3px solid ${sentimentColor};">
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">üìä OPTIONS FLOW</div>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                        <div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">Sentiment</div>
                                            <div style="font-weight: 600; color: ${sentimentColor}; text-transform: uppercase;">${sentiment}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">P/C Ratio</div>
                                            <div style="font-weight: 600;">${flow.put_call_ratio?.toFixed(2) || '--'}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">Call Vol</div>
                                            <div style="font-weight: 600; color: var(--green);">${formatVolume(flow.total_call_volume || 0)}</div>
                                        </div>
                                    </div>
                                    ${unusual.unusual_activity ?
                                        `<div style="margin-top: 8px; padding: 6px 10px; background: rgba(255, 193, 7, 0.1); border-radius: 4px; font-size: 0.75rem; color: var(--yellow);">
                                            ‚ö†Ô∏è Unusual activity detected (${unusual.unusual_contracts?.length || 0} contracts)
                                        </div>` :
                                        ''
                                    }
                                </div>
                            `;
                        }
                    }

                    content += `</div>`;
                    document.getElementById('modal-body').innerHTML = content;
                }
            } catch (e) {
                document.getElementById('modal-body').innerHTML = '<div style="color: var(--red);">Failed to load data</div>';
            }
        }

        function formatVolume(vol) {
            if (vol >= 1e9) return (vol / 1e9).toFixed(1) + 'B';
            if (vol >= 1e6) return (vol / 1e6).toFixed(1) + 'M';
            if (vol >= 1e3) return (vol / 1e3).toFixed(1) + 'K';
            return vol.toString();
        }

        // Fetch functions
        async function fetchHealth() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();
                if (data.ok) {
                    const fg = data.fear_greed || {};
                    const breadth = data.breadth || {};
                    const raw = data.raw_data || {};

                    // Market pulse - calculate from raw data
                    const spy = raw.spy_20d_return || 0;
                    const qqq = spy;  // Use SPY as proxy
                    document.getElementById('spy-change').textContent = (spy >= 0 ? '+' : '') + spy.toFixed(2) + '%';
                    document.getElementById('spy-change').className = 'pulse-value ' + (spy >= 0 ? 'up' : 'down');
                    document.getElementById('qqq-change').textContent = (qqq >= 0 ? '+' : '') + qqq.toFixed(2) + '%';
                    document.getElementById('qqq-change').className = 'pulse-value ' + (qqq >= 0 ? 'up' : 'down');
                    document.getElementById('vix-value').textContent = (raw.vix || 0).toFixed(1);

                    // Fear & Greed
                    const fgScore = fg.score || data.overall_score || 50;
                    document.getElementById('fg-value').textContent = fgScore.toFixed(0);
                    document.getElementById('fear-greed').textContent = fgScore.toFixed(0);
                    const fgLabel = fg.label || (fgScore <= 25 ? 'Extreme Fear' : fgScore <= 45 ? 'Fear' : fgScore <= 55 ? 'Neutral' : fgScore <= 75 ? 'Greed' : 'Extreme Greed');
                    document.getElementById('fg-label').textContent = fgLabel;
                    const rotation = (fgScore - 50) * 1.8; // -90 to 90 degrees
                    document.getElementById('gauge-needle').style.setProperty('--rotation', rotation + 'deg');

                    // Health metrics from breadth
                    document.getElementById('breadth-score').textContent = (breadth.breadth_score || 0).toFixed(0) + '%';
                    document.getElementById('adv-dec').textContent = (breadth.advance_decline_ratio || 0).toFixed(2);
                    document.getElementById('hi-lo').textContent = `${breadth.new_highs || 0} / ${breadth.new_lows || 0}`;
                    document.getElementById('put-call').textContent = (raw.vix_term_ratio || 0).toFixed(2);
                }
            } catch (e) { console.warn('Health fetch failed:', e); }
        }

        async function fetchScan() {
            console.log('üîÑ fetchScan() called');
            console.log('üì° API_BASE:', API_BASE);

            try {
                const url = `${API_BASE}/scan`;
                console.log('üìç Fetching:', url);

                const res = await fetch(url);
                console.log('‚úÖ Response status:', res.status, res.statusText);

                const data = await res.json();
                console.log('üì¶ Response data:', data);

                // Fix: API returns 'results' not 'stocks'
                const stocks = data.results || data.stocks || [];
                console.log('üìä Stocks array length:', stocks.length);

                // Fix: Check for data.status === 'success' OR stocks.length > 0
                // API returns {status: 'success', results: [...]} not {ok: true}
                if ((data.status === 'success' || data.ok) && stocks.length > 0) {
                    console.log('‚úÖ Rendering', stocks.length, 'stocks');
                    renderTopPicks(stocks);
                    renderScanTable(stocks);

                    // Update stats
                    document.getElementById('stat-scanned').textContent = stocks.length;
                    document.getElementById('stat-hot').textContent = stocks.filter(s => s.story_strength === 'hot').length;
                    document.getElementById('stat-developing').textContent = stocks.filter(s => s.story_strength === 'developing').length;
                    document.getElementById('stat-watchlist').textContent = stocks.filter(s => s.story_strength === 'watchlist').length;
                } else {
                    // Show empty state when no data
                    console.log('‚ö†Ô∏è No scan data available:', data.message || 'Scanner has not run yet');
                    console.log('   data.ok:', data.ok);
                    console.log('   data.status:', data.status);
                    console.log('   stocks.length:', stocks.length);
                }
            } catch (e) {
                console.error('‚ùå Scan fetch failed:', e);
                console.error('   Error details:', e.message, e.stack);
            }
        }

        async function triggerScan(mode = 'indices', evt = null) {
            // Safety: Check if toast is loaded
            const safeToast = window.toast || { error: console.error, success: console.log };

            // Fix: Get button reference safely - use passed event or find button
            const btn = evt?.target || document.querySelector(`button[onclick*="triggerScan('${mode}')"]`) || null;
            if (!btn) {
                safeToast.error('Button reference not found');
                return;
            }

            const originalText = btn.textContent;
            const modeLabel = mode === 'full' ? 'Full Universe' : mode === 'indices' ? 'S&P+NASDAQ' : 'Quick';
            btn.textContent = `‚è≥ Scanning ${modeLabel}...`;
            btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/scan/trigger?mode=${mode}`, { method: 'POST' });
                const data = await res.json();

                if (data.ok && data.status === 'started') {
                    // Scan started in background (202 Accepted)
                    btn.textContent = `‚è≥ Scanning ${data.universe_size} stocks...`;
                    safeToast.success(`Scan started! Processing ${data.universe_size} stocks in background.`, 5000);

                    // Poll for results every 10 seconds
                    let pollCount = 0;
                    const maxPolls = 30; // 5 minutes max
                    const pollInterval = setInterval(async () => {
                        pollCount++;
                        try {
                            await fetchScan();
                            // If we got new data, stop polling
                            clearInterval(pollInterval);
                            btn.textContent = '‚úÖ Scan complete!';
                            safeToast.success('Scan results updated!');
                            setTimeout(() => {
                                btn.textContent = originalText;
                                btn.disabled = false;
                            }, 2000);
                        } catch (e) {
                            // Continue polling
                            if (pollCount >= maxPolls) {
                                clearInterval(pollInterval);
                                btn.textContent = '‚è∞ Timed out';
                                setTimeout(() => {
                                    btn.textContent = originalText;
                                    btn.disabled = false;
                                }, 2000);
                            }
                        }
                    }, 10000); // Poll every 10 seconds

                    // Re-enable button after 5 seconds (allow manual refresh)
                    setTimeout(() => {
                        btn.disabled = false;
                    }, 5000);

                } else if (data.ok && data.scanned !== undefined) {
                    // Legacy response (scan completed immediately)
                    btn.textContent = `‚úÖ ${data.scanned} stocks!`;
                    await fetchScan();
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 2000);
                } else {
                    const errorMsg = data.error || 'Scan failed';
                    btn.textContent = '‚ùå ' + errorMsg.substring(0, 20);
                    safeToast.error('Scan failed: ' + errorMsg);
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 3000);
                }
            } catch (e) {
                console.error('Trigger scan failed:', e);
                btn.textContent = '‚ùå Error';
                safeToast.error('Scan error: ' + (e.message || 'Network issue'));
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 3000);
            }
        }

        function renderTopPicks(stocks) {
            const top = stocks.slice(0, 10);
            if (top.length === 0) {
                document.getElementById('top-picks').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div style="margin-bottom: 8px;">No scan data available</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Run /scan on Telegram or wait for scheduled scan</div>
                    </div>`;
                return;
            }

            document.getElementById('top-picks').innerHTML = top.map((s, i) => {
                const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                return `
                    <div class="top-pick" onclick="showTicker('${s.ticker}')">
                        <div class="pick-rank ${rankClass}">${i + 1}</div>
                        <div class="pick-info">
                            <div class="pick-ticker">${s.ticker}</div>
                            <div class="pick-name">${s.story_strength || 'N/A'}</div>
                        </div>
                        <div class="pick-score">
                            <div class="pick-score-value">${(s.story_score || 0).toFixed(0)}</div>
                            <div class="pick-score-label">score</div>
                        </div>
                        ${s.hottest_theme ? `<div class="pick-theme">${s.hottest_theme}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderScanTable(stocks) {
            window.scanData = stocks;

            // Populate theme filter dropdown
            populateThemeFilter(stocks);

            filterTable();
        }

        function populateThemeFilter(stocks) {
            const themeFilter = document.getElementById('filter-theme');
            if (!themeFilter || !stocks || stocks.length === 0) return;

            // Extract unique themes from scan data
            const themes = [...new Set(stocks.map(s => s.hottest_theme).filter(t => t && t !== '-'))].sort();

            // Keep "All Themes" option and add discovered themes
            themeFilter.innerHTML = '<option value="">All Themes</option>' +
                themes.map(theme => `<option value="${theme}">${theme}</option>`).join('');
        }

        function filterTable() {
            const strength = document.getElementById('filter-strength').value;
            const theme = document.getElementById('filter-theme').value;

            let filtered = window.scanData || [];
            if (strength) filtered = filtered.filter(s => s.story_strength === strength);
            if (theme) filtered = filtered.filter(s => s.hottest_theme === theme);

            document.getElementById('scan-table-body').innerHTML = filtered.map((s, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td class="ticker-cell" onclick="showTicker('${s.ticker}')">${s.ticker}</td>
                    <td>
                        <span class="score-bar"><span class="score-bar-fill" style="width: ${Math.min(s.story_score || 0, 100)}%"></span></span>
                        ${(s.story_score || 0).toFixed(0)}
                    </td>
                    <td>${s.story_strength || '-'}</td>
                    <td>${s.hottest_theme || '-'}</td>
                    <td style="color: ${(s.change_pct || 0) >= 0 ? 'var(--green)' : 'var(--red)'};">${(s.change_pct || 0) >= 0 ? '+' : ''}${(s.change_pct || 0).toFixed(2)}%</td>
                    <td>${formatVolume(s.volume || 0)}</td>
                    <td>${(s.rs_rating || 0).toFixed(0)}</td>
                </tr>
            `).join('');
        }

        async function fetchConvictionAlerts() {
            try {
                document.getElementById('conviction-alerts-container').innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">Scanning signals...</div>';
                const res = await fetch(`${API_BASE}/conviction/alerts?min_score=60`);
                const data = await res.json();

                if (data.ok && data.alerts && data.alerts.length > 0) {
                    const recEmoji = {
                        'STRONG BUY': 'üü¢üü¢',
                        'BUY': 'üü¢',
                        'WATCH': 'üü°',
                        'HOLD': '‚ö™',
                        'AVOID': 'üî¥'
                    };

                    let html = '';
                    data.alerts.slice(0, 5).forEach(a => {
                        const emoji = recEmoji[a.recommendation] || '‚ö™';
                        html += `<div class="sidebar-item" style="cursor: pointer; padding: 8px 0; border-bottom: 1px solid var(--border);" onclick="showConvictionDetail('${a.ticker}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">${a.ticker}</span>
                                <span style="font-size: 0.875rem;">${emoji} ${a.conviction_score.toFixed(0)}</span>
                            </div>
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 2px;">
                                ${a.bullish_signals} bullish ‚Ä¢ ${a.recommendation}
                            </div>
                        </div>`;
                    });
                    document.getElementById('conviction-alerts-container').innerHTML = html;
                } else {
                    document.getElementById('conviction-alerts-container').innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">No high-conviction setups. Signals need to align.</div>';
                }
            } catch (e) {
                console.warn('Conviction alerts fetch failed:', e);
                document.getElementById('conviction-alerts-container').innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">Could not load conviction data</div>';
            }
        }

        async function showConvictionDetail(ticker) {
            try {
                const res = await fetch(`${API_BASE}/conviction/${ticker}`);
                const data = await res.json();

                if (data.ok) {
                    const recEmoji = {'STRONG BUY': 'üü¢üü¢', 'BUY': 'üü¢', 'WATCH': 'üü°', 'HOLD': '‚ö™', 'AVOID': 'üî¥'};
                    let msg = `üéØ ${ticker} CONVICTION: ${data.conviction_score.toFixed(0)}/100\n`;
                    msg += `Recommendation: ${data.recommendation} ${recEmoji[data.recommendation] || ''}\n\n`;

                    msg += `Signals:\n`;
                    if (data.signals.insider) msg += `‚Ä¢ Insider: ${data.signals.insider.score.toFixed(0)} (${data.signals.insider.signal})\n`;
                    if (data.signals.options) msg += `‚Ä¢ Options: ${data.signals.options.score.toFixed(0)} (${data.signals.options.signal})\n`;
                    if (data.signals.patents) msg += `‚Ä¢ Patents: ${data.signals.patents.score.toFixed(0)} (${data.signals.patents.signal})\n`;
                    if (data.signals.contracts) msg += `‚Ä¢ Contracts: ${data.signals.contracts.score.toFixed(0)} (${data.signals.contracts.signal})\n`;
                    if (data.signals.sentiment) msg += `‚Ä¢ Sentiment: ${data.signals.sentiment.score.toFixed(0)} (${data.signals.sentiment.signal})\n`;
                    if (data.signals.technical) msg += `‚Ä¢ Technical: ${data.signals.technical.score.toFixed(0)} (${data.signals.technical.signal})\n`;

                    if (data.warnings && data.warnings.length > 0) {
                        msg += `\nWarnings: ${data.warnings.join(', ')}`;
                    }

                    alert(msg);
                }
            } catch (e) {
                console.warn('Conviction detail fetch failed:', e);
            }
        }

        // Supply Chain Discovery Functions
        async function fetchSupplyChain() {
            try {
                document.getElementById('supplychain-container').innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">ü§ñ AI analyzing market data...</div>';

                // Try AI-driven discovery first
                let data = null;
                try {
                    const aiRes = await fetch(`${API_BASE}/supplychain/ai-discover`);
                    data = await aiRes.json();
                } catch (e) {
                    console.warn('AI discovery failed, trying static:', e);
                }

                // Fallback to static themes if AI fails
                if (!data || !data.ok || !data.opportunities || data.opportunities.length === 0) {
                    const staticRes = await fetch(`${API_BASE}/supplychain/themes`);
                    data = await staticRes.json();
                    data.isStatic = true;
                }

                if (data.ok) {
                    let html = '';

                    // AI-driven opportunities
                    if (data.opportunities && data.opportunities.length > 0) {
                        const themeGroups = {};
                        for (const opp of data.opportunities) {
                            const theme = opp.theme || 'Unknown';
                            if (!themeGroups[theme]) themeGroups[theme] = [];
                            themeGroups[theme].push(opp);
                        }

                        for (const [theme, opps] of Object.entries(themeGroups).slice(0, 4)) {
                            const topOpp = opps[0];
                            const confEmoji = topOpp.confidence > 75 ? 'üî•' : topOpp.confidence > 50 ? 'üå±' : 'üëÄ';

                            html += `<div class="sidebar-item" style="cursor: pointer; padding: 8px 0; border-bottom: 1px solid var(--border);" onclick="showAIOpportunity('${encodeURIComponent(JSON.stringify(opps.slice(0, 5)))}')">
                                <div>
                                    <span style="font-weight: 600;">${confEmoji} ${theme}</span>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">${opps.length} opportunities</div>
                                    <div style="font-size: 0.7rem; color: var(--green);">Top: ${opps.slice(0, 2).map(o => o.ticker).join(', ')}</div>
                                </div>
                            </div>`;
                        }

                        html += `<div style="font-size: 0.7rem; color: var(--blue); margin-top: 8px;">ü§ñ AI-analyzed ‚Ä¢ ${data.opportunities.length} total</div>`;
                    }
                    // Static theme mapping
                    else if (data.themes && data.themes.length > 0) {
                        const stageEmoji = {'emerging': 'üå±', 'accelerating': 'üöÄ', 'mainstream': 'üåä', 'late': 'üçÇ'};

                        for (const theme of data.themes.slice(0, 5)) {
                            const emoji = stageEmoji[theme.lifecycle_stage] || '‚ö™';
                            html += `<div class="sidebar-item" style="cursor: pointer; padding: 8px 0; border-bottom: 1px solid var(--border);" onclick="showSupplyChainDetail('${theme.theme_id}')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <span style="font-weight: 600;">${emoji} ${theme.theme_name}</span>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">${theme.laggard_count} lagging plays</div>
                                    </div>
                                    <span style="color: var(--green); font-size: 0.8rem;">${theme.opportunity_score?.toFixed(0) || '--'}</span>
                                </div>
                            </div>`;
                        }

                        html += `<div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 8px;">Total: ${data.total_opportunities} opportunities</div>`;
                    } else {
                        html = '<div style="color: var(--text-muted); font-size: 0.8125rem;">No lagging plays found.</div>';
                    }

                    document.getElementById('supplychain-container').innerHTML = html;
                } else {
                    document.getElementById('supplychain-container').innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">No lagging plays found. Run a scan first.</div>';
                }
            } catch (e) {
                console.warn('Supply chain fetch failed:', e);
                document.getElementById('supplychain-container').innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">Could not load supply chain data</div>';
            }
        }

        function showAIOpportunity(encodedData) {
            try {
                const opps = JSON.parse(decodeURIComponent(encodedData));
                let msg = 'ü§ñ AI SUPPLY CHAIN OPPORTUNITIES\n\n';

                for (const opp of opps) {
                    msg += `‚Ä¢ ${opp.ticker} (${opp.role || opp.source})\n`;
                    if (opp.connection) msg += `  Connection: ${opp.connection}\n`;
                    if (opp.catalyst) msg += `  Catalyst: ${opp.catalyst}\n`;
                    if (opp.thesis) msg += `  Thesis: ${opp.thesis}\n`;
                    if (opp.opportunity_score) msg += `  Score: ${opp.opportunity_score}/100\n`;
                    msg += '\n';
                }

                alert(msg);
            } catch (e) {
                console.warn('Failed to parse AI opportunity:', e);
            }
        }

        async function showSupplyChainDetail(themeId) {
            try {
                const res = await fetch(`${API_BASE}/supplychain/${themeId}`);
                const data = await res.json();

                if (data.ok && data.theme) {
                    const theme = data.theme;
                    let msg = `üîó SUPPLY CHAIN: ${theme.theme_name}\n`;
                    msg += `Stage: ${theme.lifecycle_stage.toUpperCase()}\n`;
                    msg += `Opportunity: ${theme.opportunity_score.toFixed(0)}/100\n\n`;

                    msg += `Lagging Plays (${theme.laggard_count} stocks):\n`;

                    // Show suppliers that haven't moved
                    const allNodes = [...(theme.suppliers || []), ...(theme.equipment || []), ...(theme.materials || []), ...(theme.beneficiaries || []), ...(theme.infrastructure || [])];
                    const laggards = allNodes.filter(n => !n.has_moved).sort((a, b) => b.opportunity_score - a.opportunity_score).slice(0, 8);

                    for (const node of laggards) {
                        const perf = node.price_performance_30d >= 0 ? '+' + node.price_performance_30d.toFixed(1) : node.price_performance_30d.toFixed(1);
                        msg += `‚Ä¢ ${node.ticker} (${node.role}): Story ${node.story_score.toFixed(0)}, 30d: ${perf}%\n`;
                    }

                    msg += `\nValidation:\n`;
                    msg += `‚Ä¢ Patents: ${theme.patent_validation.toFixed(0)}/100\n`;
                    msg += `‚Ä¢ Contracts: ${theme.contract_validation.toFixed(0)}/100\n`;
                    msg += `‚Ä¢ Insider: ${theme.insider_validation.toFixed(0)}/100\n`;
                    msg += `\n${theme.estimated_runway}`;

                    alert(msg);
                }
            } catch (e) {
                console.warn('Supply chain detail fetch failed:', e);
            }
        }

        async function fetchEarnings() {
            try {
                const res = await fetch(`${API_BASE}/earnings`);
                const data = await res.json();
                if (data.ok && data.earnings) {
                    const upcoming = data.earnings.slice(0, 5);
                    if (upcoming.length === 0) {
                        document.getElementById('earnings-sidebar').innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">No upcoming earnings</div>';
                        return;
                    }
                    document.getElementById('earnings-sidebar').innerHTML = upcoming.map(e => `
                        <div class="sidebar-item" style="cursor: pointer;" onclick="showTicker('${e.ticker}')">
                            <span style="font-weight: 600;">${e.ticker}</span>
                            <span style="font-size: 0.75rem; color: ${e.days_until === 0 ? 'var(--red)' : e.days_until === 1 ? 'var(--yellow)' : 'var(--text-muted)'};">
                                ${e.days_until === 0 ? 'TODAY' : e.days_until === 1 ? 'Tomorrow' : e.days_until + 'd'}
                            </span>
                        </div>
                    `).join('');

                    // Show alert if earnings today
                    const today = data.earnings.filter(e => e.days_until === 0);
                    if (today.length > 0) {
                        document.getElementById('alerts-container').innerHTML = `
                            <div class="alert warning">
                                <span class="alert-icon">‚ö†Ô∏è</span>
                                <span><strong>${today.length} stock(s)</strong> report earnings today: ${today.map(e => e.ticker).join(', ')}</span>
                            </div>
                        `;
                    }
                }
            } catch (e) { console.warn('Earnings fetch failed:', e); }
        }

        async function fetchEvolution() {
            try {
                const statusRes = await fetch(`${API_BASE}/evolution/status`);
                const status = await statusRes.json();
                if (status.ok) {
                    document.getElementById('evo-cycles').textContent = status.learning_cycles || 0;
                    document.getElementById('evo-accuracy').textContent = ((status.overall_accuracy || 0) * 100).toFixed(1) + '%';
                    document.getElementById('evo-calibration').textContent = ((status.calibration_score || 0) * 100).toFixed(1) + '%';
                    document.getElementById('evo-last').textContent = status.last_evolution || 'Never';
                }

                const weightsRes = await fetch(`${API_BASE}/evolution/weights`);
                const weights = await weightsRes.json();
                if (weights.ok && weights.weights) {
                    const w = weights.weights;
                    document.getElementById('weights-container').innerHTML = Object.entries(w).slice(0, 6).map(([k, v]) => `
                        <div class="sidebar-item">
                            <span class="sidebar-label">${k.replace(/_/g, ' ')}</span>
                            <span class="sidebar-value">${(v * 100).toFixed(0)}%</span>
                        </div>
                    `).join('');
                }
            } catch (e) { console.warn('Evolution fetch failed:', e); }
        }

        async function fetchParameters() {
            try {
                const res = await fetch(`${API_BASE}/parameters/status`);
                const data = await res.json();
                if (data.ok) {
                    const p = data.parameters || {};
                    document.getElementById('param-total').textContent = p.total || 0;
                    document.getElementById('param-learned').textContent = p.learned || 0;
                    document.getElementById('param-progress').textContent = ((p.learning_progress || 0) * 100).toFixed(0) + '%';
                    document.getElementById('param-confidence').textContent = ((p.avg_confidence || 0) * 100).toFixed(0) + '%';
                }
            } catch (e) { console.warn('Parameters fetch failed:', e); }
        }

        async function fetchCorrelations() {
            try {
                const res = await fetch(`${API_BASE}/evolution/correlations`);
                const data = await res.json();
                if (data.ok && data.correlations) {
                    const corrs = Object.entries(data.correlations).slice(0, 5);
                    if (corrs.length === 0) {
                        document.getElementById('correlations-container').innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">No correlations discovered yet</div>';
                        return;
                    }
                    document.getElementById('correlations-container').innerHTML = corrs.map(([pair, value]) => `
                        <div class="sidebar-item">
                            <span class="sidebar-label">${pair}</span>
                            <span class="sidebar-value" style="color: ${value >= 0.5 ? 'var(--green)' : value <= -0.5 ? 'var(--red)' : 'var(--text)'};">${(value * 100).toFixed(0)}%</span>
                        </div>
                    `).join('');
                }
            } catch (e) { console.warn('Correlations fetch failed:', e); }
        }

        async function fetchThemes() {
            try {
                const res = await fetch(`${API_BASE}/themes/list`);
                const data = await res.json();

                // Handle both data.themes and data.data structures
                const themesArray = data.themes || data.data || [];

                if (data.ok) {
                    // Convert array to object if needed
                    if (Array.isArray(themesArray)) {
                        window.themesData = {};
                        themesArray.forEach(theme => {
                            if (theme.name) {
                                window.themesData[theme.name] = theme;
                            }
                        });
                    } else {
                        window.themesData = themesArray;
                    }

                    // Render themes to DOM
                    renderThemes();
                }
            } catch (e) {
                console.warn('Themes fetch failed:', e);
                renderThemes(); // Show empty state
            }
        }

        function renderThemes() {
            const themes = window.themesData || {};
            const themeNames = Object.keys(themes);

            // Render theme pills
            const allThemesContainer = document.getElementById('all-themes');
            if (themeNames.length === 0) {
                allThemesContainer.innerHTML = '<div style="color: var(--text-muted); font-size: 0.875rem; padding: 16px;">No themes available. Themes will appear here after a scan is completed.</div>';
                document.getElementById('theme-cards').innerHTML = '';
                return;
            }

            allThemesContainer.innerHTML = themeNames.map(name => `
                <span class="theme-pill" onclick="selectTheme('${name}')">${name}</span>
            `).join('');

            // Render theme cards
            const themeCardsContainer = document.getElementById('theme-cards');
            themeCardsContainer.innerHTML = themeNames.map(name => {
                const theme = themes[name];
                const tickerCount = theme.tickers ? theme.tickers.length : 0;
                return `
                    <div class="card card-glass" style="cursor: pointer;" onclick="selectTheme('${name}')">
                        <div class="card-body">
                            <div style="font-weight: var(--font-semibold); font-size: var(--text-lg); margin-bottom: 8px; color: var(--text);">${name}</div>
                            <div style="color: var(--text-muted); font-size: var(--text-sm);">${tickerCount} stocks</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectTheme(themeName) {
            // Highlight selected pill
            document.querySelectorAll('.theme-pill').forEach(pill => {
                pill.classList.toggle('active', pill.textContent.includes(themeName));
            });

            // Show theme stocks
            const themes = window.themesData || {};
            const theme = themes[themeName];
            if (theme && theme.tickers) {
                document.getElementById('theme-stocks-grid').innerHTML = theme.tickers.slice(0, 12).map(ticker => `
                    <div class="theme-stock" onclick="showTicker('${ticker}')">
                        <div class="theme-stock-ticker">${ticker}</div>
                    </div>
                `).join('');
            }
        }

        async function fetchBriefing() {
            document.getElementById('briefing-container').innerHTML = '<div style="color: var(--text-muted);">Generating AI briefing...</div>';
            try {
                const res = await fetch(`${API_BASE}/briefing`);
                const data = await res.json();
                if (data.ok && data.briefing) {
                    document.getElementById('briefing-container').innerHTML = `
                        <div style="white-space: pre-wrap; line-height: 1.7; font-size: 0.875rem;">${data.briefing}</div>
                    `;
                }
            } catch (e) {
                document.getElementById('briefing-container').innerHTML = '<div style="color: var(--red);">Failed to generate briefing</div>';
            }
        }

        // SEC EDGAR Functions
        async function fetchMARadar() {
            try {
                const res = await fetch(`${API_BASE}/sec/ma-radar`);
                const data = await res.json();

                if (data.ok && data.radar) {
                    let html = '';
                    if (data.radar.length === 0) {
                        html = '<div style="color: var(--text-muted);">No M&A activity detected</div>';
                    } else {
                        data.radar.slice(0, 8).forEach(item => {
                            const color = item.score >= 50 ? 'var(--red)' : item.score >= 25 ? 'var(--yellow)' : 'var(--green)';
                            const level = item.score >= 50 ? 'HIGH' : item.score >= 25 ? 'MED' : 'LOW';
                            html += `<div class="sidebar-item" style="cursor: pointer;" onclick="lookupMACheckFor('${item.ticker}')">
                                <span class="sidebar-label">${item.ticker}</span>
                                <span class="sidebar-value" style="color: ${color};">${level} ${item.score}%</span>
                            </div>`;
                        });
                    }
                    document.getElementById('ma-radar-container').innerHTML = html;
                }
            } catch (e) { console.warn('M&A radar fetch failed:', e); }
        }

        async function fetchDeals() {
            try {
                const res = await fetch(`${API_BASE}/sec/deals`);
                const data = await res.json();

                if (data.ok) {
                    // Update deals container
                    let html = '';
                    if (!data.deals || data.deals.length === 0) {
                        html = '<div style="color: var(--text-muted);">No deals tracked</div>';
                        document.getElementById('deals-container').innerHTML = html;
                        document.getElementById('deals-table-body').innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">No deals tracked. Click + Add Deal to start.</td></tr>';
                        return;
                    }

                    // Summary in sidebar
                    data.deals.forEach(deal => {
                        const spreadColor = deal.spread_pct > 5 ? 'var(--green)' : deal.spread_pct > 2 ? 'var(--yellow)' : 'var(--text-muted)';
                        html += `<div class="sidebar-item">
                            <span class="sidebar-label">${deal.target} ‚Üê ${deal.acquirer}</span>
                            <span class="sidebar-value" style="color: ${spreadColor};">+${deal.spread_pct.toFixed(1)}%</span>
                        </div>`;
                    });
                    document.getElementById('deals-container').innerHTML = html;

                    // Table
                    let tableHtml = '';
                    data.deals.forEach(deal => {
                        const statusEmoji = deal.status === 'approved' ? 'üü¢' : deal.status === 'pending' ? 'üü°' : '‚ö™';
                        const spreadColor = deal.spread_pct > 5 ? 'var(--green)' : deal.spread_pct > 2 ? 'var(--yellow)' : 'var(--text-muted)';
                        tableHtml += `<tr>
                            <td><strong>${deal.target}</strong></td>
                            <td>${deal.acquirer}</td>
                            <td>$${deal.deal_price.toFixed(2)}</td>
                            <td>$${deal.current_price.toFixed(2)}</td>
                            <td style="color: ${spreadColor};">+${deal.spread_pct.toFixed(1)}%</td>
                            <td>${statusEmoji} ${deal.status}</td>
                        </tr>`;
                    });
                    document.getElementById('deals-table-body').innerHTML = tableHtml;
                }
            } catch (e) { console.warn('Deals fetch failed:', e); }
        }

        async function lookupSECFilings() {
            const ticker = document.getElementById('sec-ticker-input').value.trim().toUpperCase();
            if (!ticker) { alert('Enter a ticker'); return; }

            document.getElementById('sec-lookup-result').innerHTML = '<div style="color: var(--text-muted);">Loading...</div>';

            try {
                const res = await fetch(`${API_BASE}/sec/filings/${ticker}`);
                const data = await res.json();

                if (data.ok && data.filings) {
                    let html = `<div style="margin-bottom: 8px; font-weight: 600;">${ticker} - ${data.count} filings</div>`;
                    data.filings.slice(0, 10).forEach(f => {
                        const emoji = f.form_type.includes('8-K') ? '‚ö°' : f.form_type.includes('DEFM') ? 'üîî' : f.form_type === '4' ? 'üë§' : 'üìÑ';
                        html += `<div style="margin-bottom: 6px;">
                            ${emoji} <strong>${f.form_type}</strong> - ${f.filed_date}
                            <a href="${f.url}" target="_blank" style="color: var(--blue); margin-left: 8px;">View</a>
                        </div>`;
                    });
                    document.getElementById('filings-feed').innerHTML = html;
                    document.getElementById('sec-lookup-result').innerHTML = `<div style="color: var(--green);">Found ${data.count} filings</div>`;
                } else {
                    document.getElementById('sec-lookup-result').innerHTML = '<div style="color: var(--red);">No filings found</div>';
                }
            } catch (e) {
                document.getElementById('sec-lookup-result').innerHTML = '<div style="color: var(--red);">Error fetching filings</div>';
            }
        }

        async function lookupMACheck() {
            const ticker = document.getElementById('sec-ticker-input').value.trim().toUpperCase();
            if (!ticker) { alert('Enter a ticker'); return; }
            lookupMACheckFor(ticker);
        }

        async function lookupMACheckFor(ticker) {
            document.getElementById('sec-lookup-result').innerHTML = '<div style="color: var(--text-muted);">Analyzing M&A activity...</div>';

            try {
                const res = await fetch(`${API_BASE}/sec/ma-check/${ticker}`);
                const data = await res.json();

                if (data.ok) {
                    const color = data.ma_score >= 50 ? 'var(--red)' : data.ma_score >= 25 ? 'var(--yellow)' : 'var(--green)';
                    const level = data.ma_score >= 50 ? 'HIGH' : data.ma_score >= 25 ? 'MEDIUM' : 'LOW';
                    let html = `<div style="margin-bottom: 8px;">
                        <strong>${ticker}</strong> M&A Probability: <span style="color: ${color}; font-weight: 600;">${level} (${data.ma_score}/100)</span>
                    </div>`;
                    if (data.signals && data.signals.length > 0) {
                        html += '<div style="margin-top: 8px;">';
                        data.signals.forEach(s => {
                            html += `<div style="margin-bottom: 4px;">‚Ä¢ ${s}</div>`;
                        });
                        html += '</div>';
                    } else {
                        html += '<div style="color: var(--text-muted);">No M&A signals detected</div>';
                    }
                    document.getElementById('sec-lookup-result').innerHTML = html;
                }
            } catch (e) {
                document.getElementById('sec-lookup-result').innerHTML = '<div style="color: var(--red);">Error checking M&A</div>';
            }
        }

        async function lookupInsider() {
            const ticker = document.getElementById('sec-ticker-input').value.trim().toUpperCase();
            if (!ticker) { alert('Enter a ticker'); return; }

            document.getElementById('sec-lookup-result').innerHTML = '<div style="color: var(--text-muted);">Loading insider data...</div>';

            try {
                const res = await fetch(`${API_BASE}/sec/insider/${ticker}`);
                const data = await res.json();

                if (data.ok) {
                    let html = `<div style="margin-bottom: 8px;"><strong>${ticker}</strong> - ${data.count} Form 4 filings (90 days)</div>`;
                    if (data.transactions && data.transactions.length > 0) {
                        data.transactions.slice(0, 5).forEach(t => {
                            html += `<div style="margin-bottom: 4px;">üë§ ${t.date} - <a href="${t.url}" target="_blank" style="color: var(--blue);">View</a></div>`;
                        });
                    } else {
                        html += '<div style="color: var(--text-muted);">No recent insider transactions</div>';
                    }
                    document.getElementById('sec-lookup-result').innerHTML = html;
                }
            } catch (e) {
                document.getElementById('sec-lookup-result').innerHTML = '<div style="color: var(--red);">Error fetching insider data</div>';
            }
        }

        function showAddDealModal() {
            const target = prompt('Target ticker (e.g., VMW):');
            if (!target) return;
            const acquirer = prompt('Acquirer ticker (e.g., AVGO):');
            if (!acquirer) return;
            const price = prompt('Deal price (e.g., 142.50):');
            if (!price) return;

            addDeal(target, acquirer, parseFloat(price));
        }

        async function addDeal(target, acquirer, dealPrice) {
            try {
                const res = await fetch(`${API_BASE}/sec/deals/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target, acquirer, deal_price: dealPrice })
                });
                const data = await res.json();

                if (data.ok) {
                    alert(data.message);
                    fetchDeals();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Failed to add deal');
            }
        }

        // Government Contracts Functions
        async function fetchContractThemes() {
            try {
                document.getElementById('contract-themes-container').innerHTML = '<div style="color: var(--text-muted);">Loading...</div>';
                const res = await fetch(`${API_BASE}/contracts/themes`);
                const data = await res.json();

                if (data.ok && data.themes) {
                    let html = '';
                    const sortedThemes = Object.entries(data.themes)
                        .filter(([_, info]) => info.total_value > 0)
                        .sort((a, b) => b[1].total_value - a[1].total_value)
                        .slice(0, 8);

                    sortedThemes.forEach(([theme, info]) => {
                        const trendEmoji = info.trend === 'increasing' ? 'üìà' : info.trend === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';
                        const trendColor = info.trend === 'increasing' ? 'var(--green)' : info.trend === 'decreasing' ? 'var(--red)' : 'var(--text-muted)';
                        const valueB = (info.total_value / 1e9).toFixed(1);

                        html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <div>
                                <div style="font-weight: 500;">${theme.replace(/_/g, ' ').toUpperCase()}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${info.contract_count || 0} contracts</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600;">$${valueB}B</div>
                                <div style="font-size: 0.75rem; color: ${trendColor};">${trendEmoji} ${info.mom_change > 0 ? '+' : ''}${(info.mom_change || 0).toFixed(0)}% MoM</div>
                            </div>
                        </div>`;
                    });

                    document.getElementById('contract-themes-container').innerHTML = html || '<div style="color: var(--text-muted);">No contract data</div>';
                } else {
                    document.getElementById('contract-themes-container').innerHTML = '<div style="color: var(--text-muted);">Contracts API not configured</div>';
                }
            } catch (e) {
                console.warn('Contract themes fetch failed:', e);
                document.getElementById('contract-themes-container').innerHTML = '<div style="color: var(--text-muted);">Could not load contract data</div>';
            }
        }

        async function fetchRecentContracts() {
            try {
                document.getElementById('recent-contracts-container').innerHTML = '<div style="color: var(--text-muted);">Loading...</div>';
                const res = await fetch(`${API_BASE}/contracts/recent`);
                const data = await res.json();

                if (data.ok && data.contracts) {
                    let html = '';
                    data.contracts.slice(0, 6).forEach(c => {
                        const valueM = (c.amount / 1e6).toFixed(1);
                        html += `<div style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <div style="font-weight: 500; font-size: 0.8125rem;">${c.recipient || 'Unknown'}</div>
                            <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                                <span style="font-size: 0.75rem; color: var(--text-muted);">${c.agency || 'Federal'}</span>
                                <span style="font-weight: 600; color: var(--green);">$${valueM}M</span>
                            </div>
                        </div>`;
                    });
                    document.getElementById('recent-contracts-container').innerHTML = html || '<div style="color: var(--text-muted);">No recent contracts</div>';
                } else {
                    document.getElementById('recent-contracts-container').innerHTML = '<div style="color: var(--text-muted);">No data</div>';
                }
            } catch (e) {
                console.warn('Recent contracts fetch failed:', e);
                document.getElementById('recent-contracts-container').innerHTML = '<div style="color: var(--text-muted);">Could not load contracts</div>';
            }
        }

        async function lookupCompanyContracts() {
            const ticker = document.getElementById('contract-ticker-input').value.trim().toUpperCase();
            if (!ticker) { alert('Enter a ticker'); return; }

            document.getElementById('contract-lookup-result').innerHTML = '<div style="color: var(--text-muted);">Searching contracts...</div>';

            try {
                const res = await fetch(`${API_BASE}/contracts/company/${ticker}`);
                const data = await res.json();

                if (data.ok && data.activity) {
                    const a = data.activity;
                    const valueB = (a.total_value / 1e9).toFixed(2);
                    const signalPct = Math.round((a.signal_strength || 0) * 100);

                    let html = `
                        <div style="background: var(--bg-hover); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--green);">$${valueB}B</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Total Contract Value</div>
                            <div style="margin-top: 8px; font-size: 0.875rem;">${a.contract_count || 0} contracts ‚Ä¢ Signal: ${signalPct}%</div>
                        </div>`;

                    if (a.top_agencies && a.top_agencies.length > 0) {
                        html += '<div style="margin-bottom: 8px;"><strong>Top Agencies:</strong></div>';
                        a.top_agencies.slice(0, 3).forEach(agency => {
                            html += `<div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">‚Ä¢ ${agency}</div>`;
                        });
                    }

                    document.getElementById('contract-lookup-result').innerHTML = html;
                } else {
                    document.getElementById('contract-lookup-result').innerHTML = `<div style="color: var(--text-muted);">No contract data for ${ticker}</div>`;
                }
            } catch (e) {
                document.getElementById('contract-lookup-result').innerHTML = '<div style="color: var(--red);">Error fetching contracts</div>';
            }
        }

        // Patent Intelligence Functions
        async function fetchPatentThemes() {
            try {
                document.getElementById('patent-themes-container').innerHTML = '<div style="color: var(--text-muted);">Loading...</div>';
                const res = await fetch(`${API_BASE}/patents/themes`);
                const data = await res.json();

                if (data.ok && data.themes) {
                    let html = '';
                    const sortedThemes = Object.entries(data.themes)
                        .sort((a, b) => b[1].patent_count - a[1].patent_count)
                        .slice(0, 8);

                    sortedThemes.forEach(([theme, info]) => {
                        const trendEmoji = info.trend === 'increasing' ? 'üìà' : info.trend === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';
                        const trendColor = info.trend === 'increasing' ? 'var(--green)' : info.trend === 'decreasing' ? 'var(--red)' : 'var(--text-muted)';
                        const signalPct = Math.round((info.signal_strength || 0) * 100);

                        html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <div>
                                <div style="font-weight: 500;">${theme.replace(/_/g, ' ').toUpperCase()}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${info.patent_count} patents</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: ${trendColor};">${trendEmoji} ${info.yoy_change > 0 ? '+' : ''}${(info.yoy_change || 0).toFixed(0)}% YoY</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Signal: ${signalPct}%</div>
                            </div>
                        </div>`;
                    });

                    document.getElementById('patent-themes-container').innerHTML = html || '<div style="color: var(--text-muted);">No patent data</div>';
                } else {
                    document.getElementById('patent-themes-container').innerHTML = '<div style="color: var(--text-muted);">Patent API not configured</div>';
                }
            } catch (e) {
                console.warn('Patent themes fetch failed:', e);
                document.getElementById('patent-themes-container').innerHTML = '<div style="color: var(--text-muted);">Could not load patent data</div>';
            }
        }

        async function lookupCompanyPatents() {
            const ticker = document.getElementById('patent-ticker-input').value.trim().toUpperCase();
            if (!ticker) { alert('Enter a ticker'); return; }

            document.getElementById('patent-lookup-result').innerHTML = '<div style="color: var(--text-muted);">Searching patents...</div>';

            try {
                const res = await fetch(`${API_BASE}/patents/company/${ticker}`);
                const data = await res.json();

                if (data.ok && data.activity) {
                    const a = data.activity;
                    const trendEmoji = a.trend === 'increasing' ? 'üìà' : a.trend === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';
                    const trendColor = a.trend === 'increasing' ? 'var(--green)' : a.trend === 'decreasing' ? 'var(--red)' : 'var(--text-muted)';

                    let html = `
                        <div style="background: var(--bg-hover); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text);">${a.patent_count}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Patents (3 years)</div>
                            <div style="margin-top: 8px; color: ${trendColor};">${trendEmoji} ${a.yoy_change > 0 ? '+' : ''}${(a.yoy_change || 0).toFixed(0)}% YoY</div>
                        </div>`;

                    if (a.top_keywords && a.top_keywords.length > 0) {
                        html += '<div style="margin-bottom: 8px;"><strong>Top Keywords:</strong></div>';
                        html += '<div style="display: flex; flex-wrap: wrap; gap: 4px;">';
                        a.top_keywords.slice(0, 6).forEach(kw => {
                            html += `<span style="background: var(--bg); padding: 2px 8px; border-radius: 4px; font-size: 0.7rem;">${kw}</span>`;
                        });
                        html += '</div>';
                    }

                    if (a.recent_patents && a.recent_patents.length > 0) {
                        html += '<div style="margin-top: 12px;"><strong>Recent Patents:</strong></div>';
                        a.recent_patents.slice(0, 3).forEach(p => {
                            html += `<div style="margin-top: 6px; font-size: 0.75rem; color: var(--text-muted);">‚Ä¢ ${p.title || p.patent_id}</div>`;
                        });
                    }

                    document.getElementById('patent-lookup-result').innerHTML = html;
                } else {
                    document.getElementById('patent-lookup-result').innerHTML = `<div style="color: var(--text-muted);">No patent data for ${ticker}</div>`;
                }
            } catch (e) {
                document.getElementById('patent-lookup-result').innerHTML = '<div style="color: var(--red);">Error fetching patents</div>';
            }
        }

        // Theme Intelligence Hub Functions
        async function fetchThemeRadar() {
            try {
                const res = await fetch(`${API_BASE}/theme-intel/radar`);
                const data = await res.json();

                if (data.ok && data.radar) {
                    const lifecycleEmoji = {
                        'emerging': 'üå±',
                        'accelerating': 'üöÄ',
                        'peak': 'üî•',
                        'declining': 'üìâ',
                        'dead': 'üíÄ'
                    };
                    const lifecycleColor = {
                        'emerging': 'var(--blue)',
                        'accelerating': 'var(--green)',
                        'peak': 'var(--yellow)',
                        'declining': 'var(--red)',
                        'dead': 'var(--text-muted)'
                    };

                    let html = '';
                    data.radar.forEach(theme => {
                        const emoji = lifecycleEmoji[theme.lifecycle] || '‚ö™';
                        const color = lifecycleColor[theme.lifecycle] || 'var(--text-muted)';
                        const trendArrow = theme.trend > 0 ? '‚Üë' : theme.trend < 0 ? '‚Üì' : '‚Üí';
                        const trendColor = theme.trend > 0 ? 'var(--green)' : theme.trend < 0 ? 'var(--red)' : 'var(--text-muted)';

                        html += `<div style="background: var(--bg-hover); border-radius: 8px; padding: 12px; border-left: 3px solid ${color};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <span style="font-weight: 600;">${emoji} ${theme.theme_name}</span>
                                <span style="color: ${trendColor};">${trendArrow}</span>
                            </div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: ${color};">${theme.score.toFixed(0)}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">${theme.lifecycle.toUpperCase()}</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">${theme.tickers.slice(0, 4).join(', ')}</div>
                        </div>`;
                    });

                    document.getElementById('theme-radar-grid').innerHTML = html || '<div style="color: var(--text-muted);">No theme data available</div>';

                    // Update lifecycle counts if summary available
                    const lifecycleCounts = { emerging: 0, accelerating: 0, peak: 0, declining: 0, dead: 0 };
                    data.radar.forEach(t => {
                        if (lifecycleCounts[t.lifecycle] !== undefined) {
                            lifecycleCounts[t.lifecycle]++;
                        }
                    });
                    document.getElementById('emerging-count').textContent = lifecycleCounts.emerging;
                    document.getElementById('accelerating-count').textContent = lifecycleCounts.accelerating;
                    document.getElementById('peak-count').textContent = lifecycleCounts.peak;
                    document.getElementById('declining-count').textContent = lifecycleCounts.declining;
                    document.getElementById('dead-count').textContent = lifecycleCounts.dead;

                    // Update table
                    let tableHtml = '';
                    data.radar.forEach(theme => {
                        const emoji = lifecycleEmoji[theme.lifecycle] || '‚ö™';
                        const color = lifecycleColor[theme.lifecycle] || 'var(--text-muted)';
                        const trendStr = theme.trend > 0 ? `+${theme.trend.toFixed(1)}` : theme.trend.toFixed(1);
                        const trendColor = theme.trend > 0 ? 'var(--green)' : theme.trend < 0 ? 'var(--red)' : 'var(--text-muted)';

                        tableHtml += `<tr>
                            <td><strong>${theme.theme_name}</strong></td>
                            <td>${emoji} <span style="color: ${color};">${theme.lifecycle}</span></td>
                            <td>${theme.score.toFixed(0)}</td>
                            <td style="color: ${trendColor};">${trendStr}</td>
                            <td style="font-size: 0.75rem;">${theme.tickers.slice(0, 5).join(', ')}</td>
                        </tr>`;
                    });
                    document.getElementById('themes-detail-body').innerHTML = tableHtml || '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No data</td></tr>';
                }
            } catch (e) {
                console.warn('Theme radar fetch failed:', e);
                document.getElementById('theme-radar-grid').innerHTML = '<div style="color: var(--red);">Failed to load theme radar</div>';
            }
        }

        async function fetchThemeAlerts() {
            try {
                const res = await fetch(`${API_BASE}/theme-intel/alerts`);
                const data = await res.json();

                if (data.ok) {
                    let html = '';
                    if (!data.alerts || data.alerts.length === 0) {
                        html = '<div style="color: var(--text-muted);">No alerts in last 24h</div>';
                    } else {
                        data.alerts.slice(0, 10).forEach(alert => {
                            const typeEmoji = {
                                'breakout': 'üí•',
                                'acceleration': 'üöÄ',
                                'rotation_in': 'üìà',
                                'rotation_out': 'üìâ'
                            }[alert.alert_type] || '‚ö™';
                            const severityColor = {
                                'high': 'var(--red)',
                                'medium': 'var(--yellow)',
                                'low': 'var(--green)'
                            }[alert.severity] || 'var(--text-muted)';

                            html += `<div style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>${typeEmoji} <strong>${alert.theme_name}</strong></span>
                                    <span style="font-size: 0.75rem; padding: 2px 6px; background: ${severityColor}20; color: ${severityColor}; border-radius: 4px;">${alert.severity.toUpperCase()}</span>
                                </div>
                                <div style="font-size: 0.8125rem; color: var(--text-muted); margin-top: 4px;">${alert.message}</div>
                            </div>`;
                        });
                    }
                    document.getElementById('theme-alerts-container').innerHTML = html;
                }
            } catch (e) {
                console.warn('Theme alerts fetch failed:', e);
            }
        }

        async function runThemeAnalysis() {
            document.getElementById('theme-radar-grid').innerHTML = '<div style="color: var(--text-muted);">Running full analysis... This may take 1-2 minutes.</div>';

            try {
                const res = await fetch(`${API_BASE}/theme-intel/run-analysis`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quick: true })
                });
                const data = await res.json();

                if (data.ok) {
                    alert(`Analysis complete! Found ${data.alerts_count} alerts.`);
                    fetchThemeRadar();
                    fetchThemeAlerts();
                } else {
                    alert('Analysis failed: ' + data.error);
                }
            } catch (e) {
                alert('Failed to run analysis');
            }
        }

        async function lookupTickerTheme() {
            const ticker = document.getElementById('ticker-theme-input').value.trim().toUpperCase();
            if (!ticker) { alert('Enter a ticker'); return; }

            document.getElementById('ticker-theme-result').innerHTML = '<div style="color: var(--text-muted);">Loading...</div>';

            try {
                const res = await fetch(`${API_BASE}/theme-intel/ticker/${ticker}`);
                const data = await res.json();

                if (data.ok) {
                    const boostColor = data.boost > 0 ? 'var(--green)' : data.boost < 0 ? 'var(--red)' : 'var(--text-muted)';
                    const boostSign = data.boost > 0 ? '+' : '';

                    let html = `<div style="margin-bottom: 12px;">
                        <strong>${ticker}</strong> Theme Boost: <span style="color: ${boostColor}; font-weight: 700; font-size: 1.25rem;">${boostSign}${data.boost} pts</span>
                    </div>`;

                    if (data.themes && data.themes.length > 0) {
                        html += '<div style="margin-top: 12px;">';
                        data.themes.forEach(theme => {
                            const lifecycleEmoji = {
                                'emerging': 'üå±',
                                'accelerating': 'üöÄ',
                                'peak': 'üî•',
                                'declining': 'üìâ',
                                'dead': 'üíÄ'
                            }[theme.lifecycle] || '‚ö™';
                            const themeBoostColor = theme.boost > 0 ? 'var(--green)' : theme.boost < 0 ? 'var(--red)' : 'var(--text-muted)';

                            html += `<div style="padding: 8px; background: var(--bg-hover); border-radius: 6px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>${lifecycleEmoji} ${theme.theme_name}</span>
                                    <span style="color: ${themeBoostColor};">${theme.boost > 0 ? '+' : ''}${theme.boost}</span>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Score: ${theme.score.toFixed(0)} | ${theme.lifecycle}</div>
                            </div>`;
                        });
                        html += '</div>';
                    } else {
                        html += `<div style="color: var(--text-muted);">${data.reason}</div>`;
                    }

                    document.getElementById('ticker-theme-result').innerHTML = html;
                } else {
                    document.getElementById('ticker-theme-result').innerHTML = `<div style="color: var(--red);">Error: ${data.error}</div>`;
                }
            } catch (e) {
                document.getElementById('ticker-theme-result').innerHTML = '<div style="color: var(--red);">Failed to lookup ticker</div>';
            }
        }

        // =============================================================================
        // THEME CONFIG MANAGEMENT FUNCTIONS
        // =============================================================================

        async function loadThemeConfig() {
            try {
                const res = await fetch(`${API_BASE}/themes/config`);
                const data = await res.json();

                if (data.ok) {
                    // Update stats
                    const stats = data.stats || {};
                    document.getElementById('stat-total').textContent = stats.total_themes || 0;
                    document.getElementById('stat-known').textContent = stats.known || 0;
                    document.getElementById('stat-emerging').textContent = stats.emerging || 0;
                    document.getElementById('stat-archived').textContent = stats.archived || 0;

                    // Render theme table
                    const tbody = document.getElementById('theme-config-body');
                    const themes = data.themes || {};

                    if (Object.keys(themes).length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No themes configured</td></tr>';
                        return;
                    }

                    let html = '';
                    Object.entries(themes).forEach(([id, theme]) => {
                        const statusColor = theme.status === 'known' ? 'var(--green)' :
                                           theme.status === 'emerging' ? 'var(--yellow)' : 'var(--text-muted)';
                        const statusBadge = `<span style="background: ${statusColor}20; color: ${statusColor}; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${theme.status}</span>`;

                        html += `<tr data-theme-id="${id}">
                            <td style="font-weight: 600;">${theme.name || id}</td>
                            <td>${statusBadge}</td>
                            <td style="font-size: 0.75rem; color: var(--text-muted);">${(theme.keywords || []).slice(0, 5).join(', ')}${theme.keywords?.length > 5 ? '...' : ''}</td>
                            <td style="font-size: 0.75rem;"><code>${(theme.tickers || []).join(', ')}</code></td>
                            <td>
                                <div style="display: flex; gap: 4px;">
                                    ${theme.status === 'archived'
                                        ? `<button class="btn btn-ghost" style="padding: 2px 8px; font-size: 0.7rem;" onclick="restoreTheme('${id}')">Restore</button>`
                                        : `<button class="btn btn-ghost" style="padding: 2px 8px; font-size: 0.7rem; color: var(--red);" onclick="archiveTheme('${id}')">Archive</button>`
                                    }
                                </div>
                            </td>
                        </tr>`;
                    });
                    tbody.innerHTML = html;
                } else {
                    document.getElementById('theme-config-body').innerHTML =
                        `<tr><td colspan="5" style="text-align: center; color: var(--red);">Error: ${data.error}</td></tr>`;
                }
            } catch (e) {
                document.getElementById('theme-config-body').innerHTML =
                    '<tr><td colspan="5" style="text-align: center; color: var(--red);">Failed to load theme config</td></tr>';
            }
        }

        async function addNewTheme() {
            const themeId = document.getElementById('new-theme-id').value.trim();
            const keywords = document.getElementById('new-theme-keywords').value.trim();
            const tickers = document.getElementById('new-theme-tickers').value.trim();

            if (!themeId) { alert('Theme ID is required'); return; }
            if (!keywords) { alert('Keywords are required'); return; }

            try {
                const res = await fetch(`${API_BASE}/themes/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        theme_id: themeId,
                        keywords: keywords.split(',').map(k => k.trim().toLowerCase()),
                        tickers: tickers ? tickers.split(',').map(t => t.trim().toUpperCase()) : []
                    })
                });
                const data = await res.json();

                if (data.ok) {
                    alert('Theme added successfully!');
                    document.getElementById('new-theme-id').value = '';
                    document.getElementById('new-theme-keywords').value = '';
                    document.getElementById('new-theme-tickers').value = '';
                    loadThemeConfig();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Failed to add theme');
            }
        }

        async function archiveTheme(themeId) {
            if (!confirm(`Archive theme "${themeId}"?`)) return;

            try {
                const res = await fetch(`${API_BASE}/themes/remove`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ theme_id: themeId })
                });
                const data = await res.json();

                if (data.ok) {
                    loadThemeConfig();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Failed to archive theme');
            }
        }

        async function restoreTheme(themeId) {
            try {
                const res = await fetch(`${API_BASE}/themes/restore`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ theme_id: themeId })
                });
                const data = await res.json();

                if (data.ok) {
                    loadThemeConfig();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Failed to restore theme');
            }
        }

        async function runAIDiscovery() {
            const card = document.getElementById('ai-discovery-card');
            const results = document.getElementById('ai-discovery-results');

            card.style.display = 'block';
            results.innerHTML = '<div style="color: var(--text-muted);">Running AI discovery... this may take 30 seconds...</div>';

            try {
                const res = await fetch(`${API_BASE}/themes/discover`, { method: 'POST' });
                const data = await res.json();

                if (data.ok && data.discovered && data.discovered.length > 0) {
                    let html = '<div style="display: grid; gap: 12px;">';
                    data.discovered.forEach(theme => {
                        html += `<div style="background: var(--bg-hover); padding: 12px; border-radius: 8px; border-left: 3px solid var(--yellow);">
                            <div style="font-weight: 600; margin-bottom: 8px;">${theme.name || theme.id}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">
                                <strong>Keywords:</strong> ${(theme.keywords || []).join(', ')}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">
                                <strong>Tickers:</strong> ${(theme.suggested_tickers || []).join(', ')}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">
                                <strong>Catalyst:</strong> ${theme.catalyst || 'N/A'}
                            </div>
                            <button class="btn btn-primary" style="padding: 4px 12px; font-size: 0.75rem;"
                                onclick="addDiscoveredTheme('${theme.id}', '${(theme.keywords || []).join(',')}', '${(theme.suggested_tickers || []).join(',')}')">
                                Add Theme
                            </button>
                        </div>`;
                    });
                    html += '</div>';
                    html += `<div style="margin-top: 12px; font-size: 0.75rem; color: var(--text-muted);">Analyzed ${data.headline_count} headlines</div>`;
                    results.innerHTML = html;
                } else if (data.ok) {
                    results.innerHTML = '<div style="color: var(--text-muted);">No new themes discovered. Current themes cover the news well!</div>';
                } else {
                    results.innerHTML = `<div style="color: var(--red);">Error: ${data.error}</div>`;
                }
            } catch (e) {
                results.innerHTML = '<div style="color: var(--red);">Failed to run AI discovery</div>';
            }
        }

        async function addDiscoveredTheme(themeId, keywords, tickers) {
            try {
                const res = await fetch(`${API_BASE}/themes/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        theme_id: themeId,
                        keywords: keywords.split(',').filter(k => k),
                        tickers: tickers.split(',').filter(t => t)
                    })
                });
                const data = await res.json();

                if (data.ok) {
                    alert('Theme added!');
                    loadThemeConfig();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Failed to add theme');
            }
        }

        // =============================================================================
        // TRADE MANAGEMENT FUNCTIONS
        // =============================================================================

        // Store positions globally for filtering
        let allPositions = [];
        let allWatchlist = [];
        let journalEntries = [];

        async function fetchTrades() {
            try {
                // Fetch positions
                const posRes = await fetch(`${API_BASE}/trades/positions`);
                const posData = await posRes.json();

                if (posData.ok) {
                    allPositions = posData.positions || [];
                    document.getElementById('trade-positions-count').textContent = posData.count || 0;
                    renderPositionCards(allPositions);
                    updatePortfolioSummary(allPositions);
                    renderThemeConcentration(allPositions);
                    updatePerformanceMetrics(allPositions);
                }

                // Fetch watchlist
                const watchRes = await fetch(`${API_BASE}/trades/watchlist`);
                const watchData = await watchRes.json();

                if (watchData.ok) {
                    allWatchlist = watchData.watchlist || [];
                    document.getElementById('trade-watchlist-count').textContent = watchData.count || 0;
                    renderWatchlistCards(allWatchlist);
                }

                // Fetch risk
                const riskRes = await fetch(`${API_BASE}/trades/risk`);
                const riskData = await riskRes.json();

                if (riskData.ok) {
                    const riskColors = {
                        'critical': 'var(--red)',
                        'high': 'var(--red)',
                        'elevated': 'var(--yellow)',
                        'moderate': 'var(--green)',
                        'low': 'var(--text-muted)',
                        'none': 'var(--green)'
                    };
                    const riskLevel = riskData.overall_risk || 'none';
                    document.getElementById('trade-risk-level').textContent = riskLevel.toUpperCase();
                    document.getElementById('trade-risk-level').style.color = riskColors[riskLevel] || 'var(--text)';
                    document.getElementById('trade-high-risk').textContent = riskData.high_risk_count || 0;

                    // Show risk alerts
                    renderTradeAlerts(riskData.high_risk_trades || []);
                }

                // Fetch journal
                fetchJournal();

                // Fetch activity
                fetchActivityFeed();

            } catch (e) {
                console.warn('Trades fetch failed:', e);
            }
        }

        function renderPositionCards(positions) {
            const container = document.getElementById('position-cards-container');
            if (!positions || positions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 40px;">No open positions. Click "+ Add Trade" to start tracking.</div>';
                return;
            }

            const riskColors = {
                'critical': '#ef4444',
                'high': '#f97316',
                'elevated': '#eab308',
                'moderate': '#22c55e',
                'low': '#6b7280',
                'none': '#10b981'
            };

            container.innerHTML = positions.map(pos => {
                const pnlPct = pos.pnl_pct || 0;
                const pnlValue = pos.pnl_value || 0;
                const pnlColor = pnlPct >= 0 ? 'var(--green)' : 'var(--red)';
                const riskLevel = pos.current_risk_level || 'none';
                const riskColor = riskColors[riskLevel] || riskColors.none;
                const storyScore = pos.story_score || 0;
                const exitConf = pos.composite_exit_confidence || 0;
                const daysHeld = pos.days_held || 0;
                const theme = pos.theme || 'No Theme';

                // Calculate profit target progress (assuming 20% target for visual)
                const profitTarget = 20;
                const progressPct = Math.min(100, Math.max(0, (pnlPct / profitTarget) * 100));
                const progressColor = pnlPct >= profitTarget ? 'var(--green)' : pnlPct >= 0 ? 'var(--blue)' : 'var(--red)';

                return `<div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 4px solid ${riskColor};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div style="cursor: pointer;" onclick="showTradeDetail('${pos.id}')">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.25rem; font-weight: 700;">${pos.ticker}</span>
                                <span style="font-size: 0.7rem; padding: 2px 6px; background: ${riskColor}20; color: ${riskColor}; border-radius: 4px;">${riskLevel.toUpperCase()}</span>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${theme} ‚Ä¢ ${daysHeld}d held</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${pnlColor};">${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(1)}%</div>
                            <div style="font-size: 0.8rem; color: ${pnlColor};">$${pnlValue >= 0 ? '+' : ''}${pnlValue.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        </div>
                    </div>

                    <!-- Story Score Bar -->
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">
                            <span>Story Score</span>
                            <span>${storyScore.toFixed(0)}/100</span>
                        </div>
                        <div style="height: 4px; background: var(--bg-hover); border-radius: 2px; overflow: hidden;">
                            <div style="height: 100%; width: ${storyScore}%; background: linear-gradient(90deg, var(--blue), var(--purple));"></div>
                        </div>
                    </div>

                    <!-- Profit Target Progress -->
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">
                            <span>Profit Target</span>
                            <span>${pnlPct.toFixed(1)}% / ${profitTarget}%</span>
                        </div>
                        <div style="height: 4px; background: var(--bg-hover); border-radius: 2px; overflow: hidden;">
                            <div style="height: 100%; width: ${progressPct}%; background: ${progressColor}; transition: width 0.3s;"></div>
                        </div>
                    </div>

                    <!-- Position Details -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; font-size: 0.75rem;">
                        <div style="background: var(--bg-hover); padding: 8px; border-radius: 6px; text-align: center;">
                            <div style="color: var(--text-muted);">Shares</div>
                            <div style="font-weight: 600;">${pos.total_shares}</div>
                        </div>
                        <div style="background: var(--bg-hover); padding: 8px; border-radius: 6px; text-align: center;">
                            <div style="color: var(--text-muted);">Avg Cost</div>
                            <div style="font-weight: 600;">$${(pos.average_cost || 0).toFixed(2)}</div>
                        </div>
                        <div style="background: var(--bg-hover); padding: 8px; border-radius: 6px; text-align: center;">
                            <div style="color: var(--text-muted);">Current</div>
                            <div style="font-weight: 600;">$${(pos.current_price || 0).toFixed(2)}</div>
                        </div>
                        <div style="background: var(--bg-hover); padding: 8px; border-radius: 6px; text-align: center;">
                            <div style="color: var(--text-muted);">Exit Conf</div>
                            <div style="font-weight: 600; color: ${exitConf > 60 ? 'var(--yellow)' : 'var(--text)'};">${exitConf.toFixed(0)}%</div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" style="flex: 1; padding: 8px; font-size: 0.75rem;" onclick="showBuyModalFor('${pos.id}', '${pos.ticker}')">üìà Scale In</button>
                        <button class="btn btn-ghost" style="flex: 1; padding: 8px; font-size: 0.75rem;" onclick="showSellModalFor('${pos.id}', '${pos.ticker}', ${pos.total_shares})">üìâ Scale Out</button>
                        <button class="btn btn-ghost" style="padding: 8px; font-size: 0.75rem;" onclick="scanSinglePosition('${pos.id}')">üîç</button>
                    </div>
                </div>`;
            }).join('');
        }

        async function scanSinglePosition(tradeId) {
            try {
                const res = await fetch(`${API_BASE}/trades/scan`);
                const data = await res.json();
                if (data.ok) {
                    const position = (data.positions || []).find(p => p.id === tradeId);
                    if (position) {
                        let msg = `Scan Results for ${position.ticker}:\n\n`;
                        if (position.exit_signals && position.exit_signals.length > 0) {
                            msg += 'Exit Signals:\n';
                            position.exit_signals.forEach(s => {
                                msg += `- ${s.signal_type}: ${s.reason} (${s.confidence}%)\n`;
                            });
                        } else {
                            msg += 'No exit signals detected.\n';
                        }
                        if (position.scale_in?.should_scale) {
                            msg += `\nScale In: +${position.scale_in.size_pct}%`;
                        }
                        if (position.scale_out?.should_scale) {
                            msg += `\nScale Out: -${position.scale_out.size_pct}%`;
                        }
                        alert(msg);
                    }
                }
            } catch (e) {
                alert('Scan failed');
            }
        }

        function renderWatchlistCards(watchlist) {
            const container = document.getElementById('watchlist-cards-container');
            if (!watchlist || watchlist.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">Watchlist empty. Add tickers to track potential trades.</div>';
                return;
            }

            const strategyColors = {
                'conservative': 'var(--blue)',
                'aggressive': 'var(--red)',
                'core_trade': 'var(--purple)',
                'momentum': 'var(--yellow)'
            };

            container.innerHTML = `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                ${watchlist.map(item => {
                    const strategy = item.scaling_plan?.strategy || 'conservative';
                    const strategyColor = strategyColors[strategy] || 'var(--blue)';
                    const theme = item.theme || 'No Theme';

                    return `<div style="background: var(--bg-hover); border: 1px solid var(--border); border-radius: 10px; padding: 14px; border-top: 3px solid ${strategyColor};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div>
                                <div style="font-size: 1.1rem; font-weight: 700;">${item.ticker}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${theme}</div>
                            </div>
                            <span style="font-size: 0.65rem; padding: 2px 6px; background: ${strategyColor}20; color: ${strategyColor}; border-radius: 4px; text-transform: capitalize;">${strategy}</span>
                        </div>
                        ${item.thesis ? `<div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px; line-height: 1.4; max-height: 40px; overflow: hidden;">${item.thesis}</div>` : ''}
                        <div style="display: flex; gap: 6px;">
                            <button class="btn btn-primary" style="flex: 1; padding: 6px; font-size: 0.7rem;" onclick="showBuyModalFor('${item.id}', '${item.ticker}')">Enter</button>
                            <button class="btn btn-ghost" style="padding: 6px; font-size: 0.7rem;" onclick="deleteTrade('${item.id}')">‚úï</button>
                        </div>
                    </div>`;
                }).join('')}
            </div>`;
        }

        function renderTradeAlerts(highRiskTrades) {
            const container = document.getElementById('trade-alerts-container');
            if (!highRiskTrades || highRiskTrades.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = highRiskTrades.map(trade => `
                <div class="alert ${trade.risk_level === 'critical' ? 'alert-danger' : 'alert-warning'}" style="margin-bottom: 12px;">
                    <span class="alert-icon">${trade.risk_level === 'critical' ? 'üî¥' : '‚ö†Ô∏è'}</span>
                    <span><strong>${trade.ticker}</strong>: ${trade.risk_level.toUpperCase()} risk (${trade.confidence.toFixed(0)}%) - ${trade.urgency}</span>
                </div>
            `).join('');
        }

        function updatePortfolioSummary(positions) {
            let totalInvested = 0;
            let currentValue = 0;

            positions.forEach(pos => {
                totalInvested += (pos.average_cost || 0) * (pos.total_shares || 0);
                currentValue += (pos.current_price || pos.average_cost || 0) * (pos.total_shares || 0);
            });

            const totalPnl = currentValue - totalInvested;
            const pnlPct = totalInvested > 0 ? (totalPnl / totalInvested) * 100 : 0;

            document.getElementById('portfolio-invested').textContent = '$' + totalInvested.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('portfolio-value').textContent = '$' + currentValue.toLocaleString(undefined, {maximumFractionDigits: 0});

            const pnlEl = document.getElementById('portfolio-pnl');
            pnlEl.textContent = `${totalPnl >= 0 ? '+' : ''}$${totalPnl.toLocaleString(undefined, {maximumFractionDigits: 0})} (${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(1)}%)`;
            pnlEl.style.color = totalPnl >= 0 ? 'var(--green)' : 'var(--red)';
        }

        async function scanAllPositions() {
            document.getElementById('scale-opportunities').innerHTML = '<div style="color: var(--text-muted);">Scanning positions...</div>';

            try {
                const res = await fetch(`${API_BASE}/trades/scan`);
                const data = await res.json();

                if (data.ok) {
                    // Update scale opportunities
                    let scaleHtml = '';
                    const positions = data.positions || [];

                    const scaleIns = positions.filter(p => p.scale_in?.should_scale);
                    const scaleOuts = positions.filter(p => p.scale_out?.should_scale);

                    if (scaleIns.length > 0) {
                        scaleHtml += '<div style="margin-bottom: 12px;"><strong style="color: var(--green);">üìà Scale In:</strong></div>';
                        scaleIns.forEach(p => {
                            scaleHtml += `<div class="sidebar-item">
                                <span class="sidebar-label">${p.ticker}</span>
                                <span class="sidebar-value" style="color: var(--green);">+${p.scale_in.size_pct.toFixed(0)}%</span>
                            </div>`;
                        });
                    }

                    if (scaleOuts.length > 0) {
                        scaleHtml += '<div style="margin-bottom: 12px; margin-top: 16px;"><strong style="color: var(--yellow);">üìâ Scale Out:</strong></div>';
                        scaleOuts.forEach(p => {
                            scaleHtml += `<div class="sidebar-item">
                                <span class="sidebar-label">${p.ticker}</span>
                                <span class="sidebar-value" style="color: var(--yellow);">-${p.scale_out.size_pct.toFixed(0)}%</span>
                            </div>`;
                        });
                    }

                    if (!scaleHtml) {
                        scaleHtml = '<div style="color: var(--text-muted); font-size: 0.8125rem;">No scaling opportunities detected</div>';
                    }

                    document.getElementById('scale-opportunities').innerHTML = scaleHtml;

                    // Refresh positions table with updated risk levels
                    fetchTrades();
                }
            } catch (e) {
                console.warn('Scan failed:', e);
                document.getElementById('scale-opportunities').innerHTML = '<div style="color: var(--red);">Scan failed</div>';
            }
        }

        function showAddTradeModal() {
            const ticker = prompt('Ticker symbol:');
            if (!ticker) return;

            const thesis = prompt('Investment thesis (why this trade?):');
            const theme = prompt('Theme (e.g., AI Infrastructure):') || '';
            const strategy = prompt('Strategy (conservative/aggressive/core_trade/momentum):') || 'conservative';

            addTrade(ticker.toUpperCase(), thesis, theme, strategy);
        }

        async function addTrade(ticker, thesis, theme, strategy) {
            try {
                const res = await fetch(`${API_BASE}/trades/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker, thesis, theme, strategy })
                });
                const data = await res.json();

                if (data.ok) {
                    alert(`Added ${ticker} to watchlist`);
                    fetchTrades();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Failed to add trade');
            }
        }

        function showBuyModal() {
            const ticker = prompt('Ticker symbol:');
            if (!ticker) return;

            showBuyModalFor(null, ticker.toUpperCase());
        }

        function showBuyModalFor(tradeId, ticker) {
            const shares = prompt(`Shares to buy for ${ticker}:`);
            if (!shares) return;

            const price = prompt(`Price per share for ${ticker}:`);
            if (!price) return;

            const reason = prompt('Reason for buy:') || 'Manual entry';

            executeBuy(tradeId, ticker, parseInt(shares), parseFloat(price), reason);
        }

        async function executeBuy(tradeId, ticker, shares, price, reason) {
            try {
                let url = `${API_BASE}/trades/${tradeId}/buy`;

                // If no tradeId, first create the trade
                if (!tradeId) {
                    const createRes = await fetch(`${API_BASE}/trades/create`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ticker, thesis: reason })
                    });
                    const createData = await createRes.json();
                    if (!createData.ok) {
                        alert('Error creating trade: ' + createData.error);
                        return;
                    }
                    tradeId = createData.trade.id;
                    url = `${API_BASE}/trades/${tradeId}/buy`;
                }

                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shares, price, reason })
                });
                const data = await res.json();

                if (data.ok) {
                    alert(data.message);
                    fetchTrades();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Failed to execute buy');
            }
        }

        function showSellModal() {
            const ticker = prompt('Ticker symbol to sell:');
            if (!ticker) return;

            // Find trade by ticker
            alert('Please use the Sell button on a specific position');
        }

        function showSellModalFor(tradeId, ticker, maxShares) {
            const shares = prompt(`Shares to sell for ${ticker} (max: ${maxShares}):`);
            if (!shares) return;

            const price = prompt(`Price per share for ${ticker}:`);
            if (!price) return;

            const reason = prompt('Reason for sell:') || 'Manual exit';

            executeSell(tradeId, parseInt(shares), parseFloat(price), reason);
        }

        async function executeSell(tradeId, shares, price, reason) {
            try {
                const res = await fetch(`${API_BASE}/trades/${tradeId}/sell`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shares, price, reason })
                });
                const data = await res.json();

                if (data.ok) {
                    alert(data.message);
                    fetchTrades();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Failed to execute sell');
            }
        }

        async function deleteTrade(tradeId) {
            if (!confirm('Remove this trade from watchlist?')) return;

            try {
                const res = await fetch(`${API_BASE}/trades/${tradeId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (data.ok) {
                    fetchTrades();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Failed to delete trade');
            }
        }

        async function showTradeDetail(tradeId) {
            openModal('Trade Details', '<div style="text-align: center; padding: 20px;">Loading...</div>');

            try {
                const res = await fetch(`${API_BASE}/trades/${tradeId}`);
                const data = await res.json();

                if (data.ok && data.trade) {
                    const t = data.trade;
                    const pnlPct = t.unrealized_pnl_pct || ((t.current_price - t.average_cost) / t.average_cost * 100) || 0;
                    const pnlColor = pnlPct >= 0 ? 'var(--green)' : 'var(--red)';

                    const content = `
                        <div style="display: grid; gap: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: 700;">${t.ticker}</div>
                                    <div style="color: var(--text-muted);">${t.theme || 'No theme'}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.25rem; font-weight: 600; color: ${pnlColor};">${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(1)}%</div>
                                    <div style="color: var(--text-muted);">${t.status}</div>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Shares</div>
                                    <div style="font-weight: 600;">${t.total_shares}</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Avg Cost</div>
                                    <div style="font-weight: 600;">$${(t.average_cost || 0).toFixed(2)}</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Current</div>
                                    <div style="font-weight: 600;">$${(t.current_price || 0).toFixed(2)}</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Days Held</div>
                                    <div style="font-weight: 600;">${t.days_held}</div>
                                </div>
                            </div>

                            ${t.thesis ? `<div style="padding: 12px; background: var(--bg-hover); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Thesis</div>
                                <div style="font-size: 0.875rem;">${t.thesis}</div>
                            </div>` : ''}

                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Risk Level</div>
                                    <div style="font-weight: 600;">${(t.current_risk_level || 'none').toUpperCase()}</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Exit Confidence</div>
                                    <div style="font-weight: 600;">${(t.composite_exit_confidence || 0).toFixed(0)}%</div>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Strategy</div>
                                    <div style="font-weight: 600; text-transform: capitalize;">${t.scaling_plan?.strategy || 'conservative'}</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Scale-ins</div>
                                    <div style="font-weight: 600;">${t.scale_ins_used || 0}/${t.scaling_plan?.max_scale_ins || 3}</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Scale-outs</div>
                                    <div style="font-weight: 600;">${t.scale_outs_used || 0}</div>
                                </div>
                            </div>

                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <button class="btn btn-primary" onclick="showBuyModalFor('${t.id}', '${t.ticker}')" style="flex: 1;">Add Shares</button>
                                <button class="btn btn-ghost" onclick="showSellModalFor('${t.id}', '${t.ticker}', ${t.total_shares})" style="flex: 1;">Sell Shares</button>
                            </div>
                        </div>
                    `;
                    document.getElementById('modal-body').innerHTML = content;

                    // Update options flow sidebar
                    showOptionsFlowForTicker(t.ticker);
                }
            } catch (e) {
                document.getElementById('modal-body').innerHTML = '<div style="color: var(--red);">Failed to load trade details</div>';
            }
        }

        async function fetchDailyReport() {
            openModal('Daily Report', '<div style="text-align: center; padding: 20px;">Generating report...</div>');

            try {
                const res = await fetch(`${API_BASE}/trades/daily-report`);
                const data = await res.json();

                if (data.ok && data.report) {
                    document.getElementById('modal-body').innerHTML = `
                        <div style="white-space: pre-wrap; line-height: 1.7; font-size: 0.875rem; font-family: monospace;">${data.report}</div>
                    `;
                } else {
                    document.getElementById('modal-body').innerHTML = '<div style="color: var(--red);">Failed to generate report</div>';
                }
            } catch (e) {
                document.getElementById('modal-body').innerHTML = '<div style="color: var(--red);">Failed to generate report</div>';
            }
        }

        // =============================================================================
        // AI ADVISOR FUNCTIONS
        // =============================================================================

        async function refreshAIAdvisor() {
            document.getElementById('ai-insight').innerHTML = '<span style="color: var(--text-muted);">Analyzing positions...</span>';

            try {
                // Get risk assessment for AI insights
                const riskRes = await fetch(`${API_BASE}/trades/risk`);
                const riskData = await riskRes.json();

                // Get scan data for market context
                const scanRes = await fetch(`${API_BASE}/trades/scan`);
                const scanData = await scanRes.json();

                if (riskData.ok && scanData.ok) {
                    const positions = scanData.positions || [];
                    const highRisk = riskData.high_risk_trades || [];

                    // Determine priority action
                    let priorityAction = 'HOLD';
                    let priorityColor = 'var(--text)';
                    if (highRisk.length > 0) {
                        const critical = highRisk.filter(t => t.risk_level === 'critical');
                        if (critical.length > 0) {
                            priorityAction = `EXIT ${critical[0].ticker}`;
                            priorityColor = 'var(--red)';
                        } else {
                            priorityAction = `REVIEW ${highRisk[0].ticker}`;
                            priorityColor = 'var(--yellow)';
                        }
                    } else {
                        const scaleIns = positions.filter(p => p.scale_in?.should_scale);
                        if (scaleIns.length > 0) {
                            priorityAction = `SCALE IN ${scaleIns[0].ticker}`;
                            priorityColor = 'var(--green)';
                        }
                    }

                    // Determine market regime based on positions
                    let regime = 'NEUTRAL';
                    let regimeColor = 'var(--text-muted)';
                    const avgPnl = positions.length > 0 ? positions.reduce((sum, p) => sum + (p.pnl_pct || 0), 0) / positions.length : 0;
                    if (avgPnl > 5) {
                        regime = 'BULLISH';
                        regimeColor = 'var(--green)';
                    } else if (avgPnl < -5) {
                        regime = 'BEARISH';
                        regimeColor = 'var(--red)';
                    }

                    // Determine overall stance
                    let stance = 'NEUTRAL';
                    let stanceColor = 'var(--text-muted)';
                    const riskLevel = riskData.overall_risk || 'none';
                    if (riskLevel === 'critical' || riskLevel === 'high') {
                        stance = 'DEFENSIVE';
                        stanceColor = 'var(--red)';
                    } else if (riskLevel === 'elevated') {
                        stance = 'CAUTIOUS';
                        stanceColor = 'var(--yellow)';
                    } else if (positions.length > 0 && avgPnl > 0) {
                        stance = 'AGGRESSIVE';
                        stanceColor = 'var(--green)';
                    }

                    document.getElementById('ai-priority-action').innerHTML = `<span style="color: ${priorityColor};">${priorityAction}</span>`;
                    document.getElementById('ai-market-regime').innerHTML = `<span style="color: ${regimeColor};">${regime}</span>`;
                    document.getElementById('ai-stance').innerHTML = `<span style="color: ${stanceColor};">${stance}</span>`;

                    // Generate insight
                    let insight = '';
                    if (positions.length === 0) {
                        insight = 'No open positions. Consider scanning for high-conviction setups with strong story scores.';
                    } else if (highRisk.length > 0) {
                        insight = `${highRisk.length} position(s) require attention. ${highRisk[0].ticker} shows ${highRisk[0].risk_level} risk level (${highRisk[0].confidence}% confidence). Consider reducing exposure.`;
                    } else {
                        const winners = positions.filter(p => (p.pnl_pct || 0) > 0);
                        const losers = positions.filter(p => (p.pnl_pct || 0) < 0);
                        insight = `Portfolio is ${winners.length > losers.length ? 'performing well' : 'mixed'}. ${winners.length} winners, ${losers.length} losers. `;
                        if (avgPnl > 10) {
                            insight += 'Consider taking partial profits on extended positions.';
                        } else if (avgPnl < -5) {
                            insight += 'Review stop levels and thesis integrity for underperformers.';
                        } else {
                            insight += 'Continue monitoring story developments and technical levels.';
                        }
                    }
                    document.getElementById('ai-insight').innerHTML = insight;
                }
            } catch (e) {
                console.warn('AI Advisor refresh failed:', e);
                document.getElementById('ai-insight').innerHTML = '<span style="color: var(--red);">Failed to load AI insights</span>';
            }
        }

        // =============================================================================
        // JOURNAL FUNCTIONS
        // =============================================================================

        async function fetchJournal() {
            try {
                const res = await fetch(`${API_BASE}/trades/journal`);
                const data = await res.json();

                if (data.ok) {
                    journalEntries = data.entries || [];
                    renderJournal(journalEntries);
                } else {
                    // Journal endpoint might not exist yet, show empty state
                    journalEntries = [];
                    renderJournal([]);
                }
            } catch (e) {
                console.warn('Journal fetch failed:', e);
                journalEntries = [];
                renderJournal([]);
            }
        }

        function filterJournal() {
            const filter = document.getElementById('journal-filter').value;
            if (filter === 'all') {
                renderJournal(journalEntries);
            } else {
                renderJournal(journalEntries.filter(e => e.entry_type === filter));
            }
        }

        function renderJournal(entries) {
            const container = document.getElementById('journal-container');

            if (!entries || entries.length === 0) {
                container.innerHTML = `<div style="text-align: center; padding: 30px;">
                    <div style="font-size: 2rem; margin-bottom: 8px;">üìì</div>
                    <div style="color: var(--text-muted);">No journal entries yet.</div>
                    <div style="color: var(--text-muted); font-size: 0.8rem; margin-top: 4px;">Document your trades, lessons, and insights.</div>
                </div>`;
                return;
            }

            const typeIcons = {
                'trade': 'üíπ',
                'note': 'üìù',
                'lesson': 'üí°',
                'mistake': '‚ö†Ô∏è'
            };
            const typeColors = {
                'trade': 'var(--blue)',
                'note': 'var(--text-muted)',
                'lesson': 'var(--green)',
                'mistake': 'var(--red)'
            };

            container.innerHTML = entries.map(entry => {
                const icon = typeIcons[entry.entry_type] || 'üìù';
                const color = typeColors[entry.entry_type] || 'var(--text-muted)';
                const date = new Date(entry.timestamp).toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
                const time = new Date(entry.timestamp).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});

                return `<div style="padding: 12px; background: var(--bg-hover); border-radius: 8px; margin-bottom: 10px; border-left: 3px solid ${color};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.1rem;">${icon}</span>
                            ${entry.ticker ? `<span style="font-weight: 600;">${entry.ticker}</span>` : ''}
                            <span style="font-size: 0.7rem; padding: 2px 6px; background: ${color}20; color: ${color}; border-radius: 4px; text-transform: capitalize;">${entry.entry_type}</span>
                        </div>
                        <span style="font-size: 0.7rem; color: var(--text-muted);">${date} ${time}</span>
                    </div>
                    <div style="font-size: 0.85rem; line-height: 1.5;">${entry.content}</div>
                    ${entry.tags && entry.tags.length > 0 ? `<div style="margin-top: 8px; display: flex; gap: 4px; flex-wrap: wrap;">
                        ${entry.tags.map(tag => `<span style="font-size: 0.65rem; padding: 2px 6px; background: var(--bg-card); border-radius: 4px; color: var(--text-muted);">#${tag}</span>`).join('')}
                    </div>` : ''}
                </div>`;
            }).join('');
        }

        function showAddJournalEntry() {
            const entryType = prompt('Entry type (trade/note/lesson/mistake):', 'note') || 'note';
            const validTypes = ['trade', 'note', 'lesson', 'mistake'];
            if (!validTypes.includes(entryType.toLowerCase())) {
                alert('Invalid type. Use: trade, note, lesson, or mistake');
                return;
            }

            const ticker = prompt('Ticker (optional, press Enter to skip):') || '';
            const content = prompt('Entry content:');
            if (!content) return;

            const tagsStr = prompt('Tags (comma-separated, optional):') || '';
            const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];

            addJournalEntry(entryType.toLowerCase(), content, ticker.toUpperCase() || null, tags);
        }

        async function addJournalEntry(entryType, content, ticker = null, tags = []) {
            try {
                const res = await fetch(`${API_BASE}/trades/journal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ entry_type: entryType, content, ticker, tags })
                });
                const data = await res.json();

                if (data.ok) {
                    fetchJournal();
                    // Also add to activity feed
                    addActivityItem(`Added ${entryType} journal entry${ticker ? ` for ${ticker}` : ''}`);
                } else {
                    alert('Failed to add entry: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed to add journal entry');
            }
        }

        // =============================================================================
        // THEME CONCENTRATION
        // =============================================================================

        function renderThemeConcentration(positions) {
            const container = document.getElementById('theme-concentration-chart');

            if (!positions || positions.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.75rem;">No positions to analyze</div>';
                return;
            }

            // Group by theme
            const themeValues = {};
            let totalValue = 0;

            positions.forEach(pos => {
                const theme = pos.theme || 'No Theme';
                const value = (pos.current_price || pos.average_cost || 0) * (pos.total_shares || 0);
                themeValues[theme] = (themeValues[theme] || 0) + value;
                totalValue += value;
            });

            if (totalValue === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.75rem;">No position values</div>';
                return;
            }

            // Sort by value
            const sortedThemes = Object.entries(themeValues).sort((a, b) => b[1] - a[1]);

            // Theme colors
            const themeColors = [
                'var(--blue)', 'var(--purple)', 'var(--green)', 'var(--yellow)',
                'var(--red)', 'var(--cyan)', 'var(--pink)', 'var(--text-muted)'
            ];

            container.innerHTML = sortedThemes.map(([theme, value], i) => {
                const pct = (value / totalValue * 100).toFixed(1);
                const color = themeColors[i % themeColors.length];

                return `<div style="margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.7rem; margin-bottom: 2px;">
                        <span style="color: ${color};">${theme}</span>
                        <span>${pct}%</span>
                    </div>
                    <div style="height: 6px; background: var(--bg-hover); border-radius: 3px; overflow: hidden;">
                        <div style="height: 100%; width: ${pct}%; background: ${color}; transition: width 0.3s;"></div>
                    </div>
                </div>`;
            }).join('');
        }

        // =============================================================================
        // PERFORMANCE METRICS
        // =============================================================================

        function updatePerformanceMetrics(positions) {
            // Calculate from positions
            const wins = positions.filter(p => (p.pnl_pct || 0) > 0);
            const losses = positions.filter(p => (p.pnl_pct || 0) < 0);

            const avgWin = wins.length > 0 ? wins.reduce((sum, p) => sum + (p.pnl_pct || 0), 0) / wins.length : 0;
            const avgLoss = losses.length > 0 ? losses.reduce((sum, p) => sum + Math.abs(p.pnl_pct || 0), 0) / losses.length : 0;

            const totalWins = wins.reduce((sum, p) => sum + (p.pnl_value || 0), 0);
            const totalLosses = Math.abs(losses.reduce((sum, p) => sum + (p.pnl_value || 0), 0));
            const profitFactor = totalLosses > 0 ? (totalWins / totalLosses).toFixed(2) : (totalWins > 0 ? '‚àû' : '--');

            const allPnl = positions.map(p => p.pnl_pct || 0);
            const bestTrade = allPnl.length > 0 ? Math.max(...allPnl) : 0;
            const worstTrade = allPnl.length > 0 ? Math.min(...allPnl) : 0;

            const avgHoldTime = positions.length > 0 ? Math.round(positions.reduce((sum, p) => sum + (p.days_held || 0), 0) / positions.length) : 0;

            document.getElementById('perf-avg-win').textContent = avgWin > 0 ? `+${avgWin.toFixed(1)}%` : '--';
            document.getElementById('perf-avg-loss').textContent = avgLoss > 0 ? `-${avgLoss.toFixed(1)}%` : '--';
            document.getElementById('perf-profit-factor').textContent = profitFactor;
            document.getElementById('perf-best').textContent = bestTrade > 0 ? `+${bestTrade.toFixed(1)}%` : '--';
            document.getElementById('perf-worst').textContent = worstTrade < 0 ? `${worstTrade.toFixed(1)}%` : '--';
            document.getElementById('perf-hold-time').textContent = avgHoldTime > 0 ? `${avgHoldTime}d` : '--';
        }

        // =============================================================================
        // ACTIVITY FEED
        // =============================================================================

        let activityItems = [];

        async function fetchActivityFeed() {
            try {
                const res = await fetch(`${API_BASE}/trades/activity`);
                const data = await res.json();

                if (data.ok) {
                    activityItems = data.activities || [];
                    renderActivityFeed();
                } else {
                    // Activity endpoint might not exist, use local tracking
                    renderActivityFeed();
                }
            } catch (e) {
                // Fallback to showing recent local activity
                renderActivityFeed();
            }
        }

        function renderActivityFeed() {
            const container = document.getElementById('recent-activity');

            if (activityItems.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.8rem;">No recent activity</div>';
                return;
            }

            container.innerHTML = activityItems.slice(0, 10).map(item => {
                const time = item.timestamp ? new Date(item.timestamp).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) : 'now';
                const typeEmoji = {
                    'buy': 'üìà',
                    'sell': 'üìâ',
                    'create': '‚ûï',
                    'delete': 'üóëÔ∏è',
                    'scan': 'üîç',
                    'journal': 'üìì'
                }[item.type] || '‚Ä¢';

                return `<div style="padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 0.8rem;">
                    <span>${typeEmoji}</span>
                    <span>${item.message}</span>
                    <span style="color: var(--text-muted); font-size: 0.7rem; float: right;">${time}</span>
                </div>`;
            }).join('');
        }

        function addActivityItem(message, type = 'general') {
            activityItems.unshift({
                message,
                type,
                timestamp: new Date().toISOString()
            });
            renderActivityFeed();
        }

        // =============================================================================
        // OPTIONS FEATURES (POLYGON)
        // =============================================================================

        async function fetchUnusualOptions() {
            try {
                const res = await fetch(`${API_BASE}/options/scan/unusual?limit=10`);
                const data = await res.json();

                if (!data.ok || !data.data || data.data.length === 0) {
                    document.getElementById('unusual-options-container').innerHTML =
                        '<div style="color: var(--text-muted); font-size: 0.8125rem;">No unusual activity detected</div>';
                    return;
                }

                let html = '';
                data.data.slice(0, 5).forEach(item => {
                    const signals = item.signals || [];
                    const sentiment = signals.find(s => s.type === 'BEARISH_FLOW' || s.type === 'BULLISH_FLOW');
                    const sentimentColor = sentiment ?
                        (sentiment.type === 'BULLISH_FLOW' ? 'var(--green)' : 'var(--red)') :
                        'var(--text-muted)';

                    html += `
                        <div class="sidebar-item" style="cursor: pointer;" onclick="showOptionsDetail('${item.ticker}')">
                            <div>
                                <div style="font-weight: 600;">${item.ticker}</div>
                                <div style="font-size: 0.7rem; color: ${sentimentColor};">
                                    ${item.unusual_contracts} unusual contracts
                                </div>
                            </div>
                            <div style="text-align: right; font-size: 0.75rem; color: var(--text-muted);">
                                ${sentiment ? sentiment.strength : 'moderate'}
                            </div>
                        </div>
                    `;
                });

                document.getElementById('unusual-options-container').innerHTML = html;
            } catch (e) {
                console.error('Failed to fetch unusual options:', e);
                document.getElementById('unusual-options-container').innerHTML =
                    '<div style="color: var(--red); font-size: 0.8125rem;">Failed to load</div>';
            }
        }

        function showOptionsDetail(ticker) {
            // Switch to Options tab
            showTab('options');

            // Load options chain for ticker
            document.getElementById('options-ticker-input').value = ticker;
            loadOptionsChain();

            // Also load technical indicators
            document.getElementById('technical-ticker-input').value = ticker;
            loadTechnicalIndicators();
        }

        // Options flow for Trades tab
        let currentFlowTicker = null;

        async function showOptionsFlowForTicker(ticker) {
            if (!ticker) {
                document.getElementById('options-flow-container').innerHTML =
                    '<div style="color: var(--text-muted); font-size: 0.8125rem;">Select a position to view options flow</div>';
                currentFlowTicker = null;
                return;
            }

            currentFlowTicker = ticker;

            try {
                const res = await fetch(`${API_BASE}/options/flow/${ticker}`);
                const data = await res.json();

                if (!data.ok || data.data.error) {
                    document.getElementById('options-flow-container').innerHTML =
                        '<div style="color: var(--text-muted); font-size: 0.8125rem;">No options data available</div>';
                    return;
                }

                const flow = data.data;
                const sentiment = flow.sentiment || 'neutral';
                const sentimentColor = sentiment === 'bullish' ? 'var(--green)' :
                                      sentiment === 'bearish' ? 'var(--red)' :
                                      'var(--text-muted)';

                const html = `
                    <div style="margin-bottom: 1rem;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Sentiment</div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: ${sentimentColor}; text-transform: uppercase;">
                            ${sentiment}
                        </div>
                        ${flow.sentiment_score !== undefined ?
                            `<div style="font-size: 0.7rem; color: var(--text-muted);">${flow.sentiment_score}/100</div>` :
                            ''}
                    </div>
                    <div class="sidebar-item">
                        <span class="sidebar-label">Put/Call Ratio</span>
                        <span class="sidebar-value">${flow.put_call_ratio?.toFixed(2) || '--'}</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="sidebar-label">Call Volume</span>
                        <span class="sidebar-value green">${flow.total_call_volume?.toLocaleString() || '--'}</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="sidebar-label">Put Volume</span>
                        <span class="sidebar-value red">${flow.total_put_volume?.toLocaleString() || '--'}</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="sidebar-label">Call OI</span>
                        <span class="sidebar-value">${flow.total_call_oi?.toLocaleString() || '--'}</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="sidebar-label">Put OI</span>
                        <span class="sidebar-value">${flow.total_put_oi?.toLocaleString() || '--'}</span>
                    </div>
                    ${flow.has_unusual_activity ?
                        '<div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(255, 193, 7, 0.1); border-radius: 0.5rem; font-size: 0.75rem; color: var(--yellow);">‚ö†Ô∏è Unusual activity detected</div>' :
                        ''}
                `;

                document.getElementById('options-flow-container').innerHTML = html;
            } catch (e) {
                console.error('Failed to fetch options flow:', e);
                document.getElementById('options-flow-container').innerHTML =
                    '<div style="color: var(--red); font-size: 0.8125rem;">Failed to load</div>';
            }
        }

        async function refreshOptionsFlow() {
            if (currentFlowTicker) {
                await showOptionsFlowForTicker(currentFlowTicker);
            }
        }

        // Options chain loader
        async function loadOptionsChain() {
            const ticker = document.getElementById('options-ticker-input').value.trim().toUpperCase();
            if (!ticker) {
                alert('Please enter a ticker symbol');
                return;
            }

            try {
                // Show loading state
                document.getElementById('calls-table-body').innerHTML =
                    '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>';
                document.getElementById('puts-table-body').innerHTML =
                    '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">Loading...</td></tr>';

                // Fetch options chain
                const res = await fetch(`${API_BASE}/options/chain/${ticker}`);
                const data = await res.json();

                if (!data.ok || data.data.error) {
                    throw new Error(data.data?.error || 'Failed to load options chain');
                }

                const chain = data.data;

                // Show summary grid
                document.getElementById('options-summary').style.display = 'grid';
                document.getElementById('options-tables').style.display = 'grid';

                // Populate summary
                const summary = chain.summary || {};
                const sentiment = summary.sentiment || 'neutral';
                const sentimentColor = sentiment === 'bullish' ? 'var(--green)' :
                                      sentiment === 'bearish' ? 'var(--red)' :
                                      'var(--text-muted)';

                document.getElementById('opt-sentiment').textContent = sentiment.toUpperCase();
                document.getElementById('opt-sentiment').style.color = sentimentColor;
                document.getElementById('opt-pc-ratio').textContent = (summary.put_call_ratio || 0).toFixed(2);
                document.getElementById('opt-call-vol').textContent = (summary.total_call_volume || 0).toLocaleString();
                document.getElementById('opt-put-vol').textContent = (summary.total_put_volume || 0).toLocaleString();

                // Render calls table
                const calls = chain.calls || [];
                if (calls.length === 0) {
                    document.getElementById('calls-table-body').innerHTML =
                        '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">No call contracts available</td></tr>';
                } else {
                    document.getElementById('calls-table-body').innerHTML = calls.slice(0, 50).map(c => {
                        const deltaColor = (c.delta || 0) >= 0.5 ? 'var(--green)' : 'var(--text-muted)';
                        return `
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 8px; font-weight: 600;">$${c.strike || '--'}</td>
                                <td style="padding: 8px; text-align: right;">$${(c.bid || 0).toFixed(2)}</td>
                                <td style="padding: 8px; text-align: right;">$${(c.ask || 0).toFixed(2)}</td>
                                <td style="padding: 8px; text-align: right;">${(c.volume || 0).toLocaleString()}</td>
                                <td style="padding: 8px; text-align: right;">${(c.open_interest || 0).toLocaleString()}</td>
                                <td style="padding: 8px; text-align: right;">${c.implied_volatility ? (c.implied_volatility * 100).toFixed(1) + '%' : '--'}</td>
                                <td style="padding: 8px; text-align: right; color: ${deltaColor}; font-weight: 600;">${c.delta ? c.delta.toFixed(3) : '--'}</td>
                            </tr>
                        `;
                    }).join('');
                }

                // Render puts table
                const puts = chain.puts || [];
                if (puts.length === 0) {
                    document.getElementById('puts-table-body').innerHTML =
                        '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">No put contracts available</td></tr>';
                } else {
                    document.getElementById('puts-table-body').innerHTML = puts.slice(0, 50).map(p => {
                        const deltaColor = (p.delta || 0) <= -0.5 ? 'var(--red)' : 'var(--text-muted)';
                        return `
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 8px; font-weight: 600;">$${p.strike || '--'}</td>
                                <td style="padding: 8px; text-align: right;">$${(p.bid || 0).toFixed(2)}</td>
                                <td style="padding: 8px; text-align: right;">$${(p.ask || 0).toFixed(2)}</td>
                                <td style="padding: 8px; text-align: right;">${(p.volume || 0).toLocaleString()}</td>
                                <td style="padding: 8px; text-align: right;">${(p.open_interest || 0).toLocaleString()}</td>
                                <td style="padding: 8px; text-align: right;">${p.implied_volatility ? (p.implied_volatility * 100).toFixed(1) + '%' : '--'}</td>
                                <td style="padding: 8px; text-align: right; color: ${deltaColor}; font-weight: 600;">${p.delta ? p.delta.toFixed(3) : '--'}</td>
                            </tr>
                        `;
                    }).join('');
                }

            } catch (e) {
                console.error('Failed to load options chain:', e);
                alert('Failed to load options chain: ' + e.message);
                document.getElementById('calls-table-body').innerHTML =
                    '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--red);">Failed to load</td></tr>';
                document.getElementById('puts-table-body').innerHTML =
                    '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--red);">Failed to load</td></tr>';
            }
        }

        // Market Options Sentiment loader
        async function loadMarketSentiment() {
            try {
                const res = await fetch(`${API_BASE}/options/market-sentiment`);
                const data = await res.json();

                if (data.ok && data.data) {
                    const sentiment = data.data;

                    // SPY P/C Ratio
                    const pcRatio = sentiment.spy_put_call_ratio || sentiment.put_call_ratio || 0;
                    const pcEl = document.getElementById('spy-pc-ratio');
                    pcEl.textContent = pcRatio.toFixed(2);
                    pcEl.style.color = pcRatio > 1.0 ? 'var(--red)' : pcRatio < 0.7 ? 'var(--green)' : 'var(--text)';
                    document.getElementById('spy-pc-label').textContent = pcRatio > 1.0 ? 'Bearish' : pcRatio < 0.7 ? 'Bullish' : 'Neutral';

                    // GEX
                    const gex = sentiment.total_gex || sentiment.gex || 0;
                    const gexEl = document.getElementById('market-gex');
                    gexEl.textContent = (gex / 1e9).toFixed(1) + 'B';
                    gexEl.style.color = gex > 0 ? 'var(--green)' : 'var(--red)';
                    document.getElementById('gex-label').textContent = gex > 0 ? 'Supportive' : 'Volatile';

                    // VIX
                    const vix = sentiment.vix || 0;
                    const vixEl = document.getElementById('vix-level');
                    vixEl.textContent = vix.toFixed(1);
                    vixEl.style.color = vix > 25 ? 'var(--red)' : vix < 15 ? 'var(--green)' : 'var(--text)';
                    document.getElementById('vix-label').textContent = vix > 25 ? 'High Fear' : vix < 15 ? 'Low Fear' : 'Normal';

                    // 0DTE Volume
                    const zeroDte = sentiment.zero_dte_volume || 0;
                    document.getElementById('zero-dte-vol').textContent = (zeroDte / 1e6).toFixed(1) + 'M';
                }
            } catch (e) {
                console.error('Failed to load market sentiment:', e);
            }
        }

        // Whale Trades loader
        async function loadWhaleTrades() {
            const container = document.getElementById('whale-trades-container');
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">Loading whale trades...</div>';

            try {
                const res = await fetch(`${API_BASE}/options/whales?min_premium=500000`);
                const data = await res.json();

                if (data.ok && (data.whales || data.data) && (data.whales || data.data).length > 0) {
                    const trades = data.whales || data.data;
                    let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">';
                    html += '<thead><tr style="background: var(--bg-hover); border-bottom: 1px solid var(--border);">';
                    html += '<th style="padding: 8px; text-align: left;">Ticker</th>';
                    html += '<th style="padding: 8px; text-align: left;">Type</th>';
                    html += '<th style="padding: 8px; text-align: right;">Strike</th>';
                    html += '<th style="padding: 8px; text-align: right;">Premium</th>';
                    html += '<th style="padding: 8px; text-align: center;">Side</th>';
                    html += '</tr></thead><tbody>';

                    trades.slice(0, 15).forEach(t => {
                        const typeEmoji = t.type === 'C' || t.type === 'call' ? 'üìà' : 'üìâ';
                        const sideColor = t.side?.toLowerCase() === 'buy' ? 'var(--green)' : 'var(--red)';
                        const premium = (t.premium || 0) / 1000;

                        html += `<tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 8px; font-weight: 600;">${t.ticker || '--'}</td>
                            <td style="padding: 8px;">${typeEmoji} ${(t.type || 'C').toUpperCase()}</td>
                            <td style="padding: 8px; text-align: right;">$${t.strike || '--'}</td>
                            <td style="padding: 8px; text-align: right; font-weight: 600;">$${premium.toFixed(0)}K</td>
                            <td style="padding: 8px; text-align: center; color: ${sideColor}; font-weight: 600;">${(t.side || 'BUY').toUpperCase()}</td>
                        </tr>`;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No whale trades found</div>';
                }
            } catch (e) {
                console.error('Failed to load whale trades:', e);
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--red);">Failed to load whale trades</div>';
            }
        }

        // Unusual Activity loader
        async function loadUnusualActivity() {
            const container = document.getElementById('unusual-activity-container');
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">Scanning unusual activity...</div>';

            try {
                const tickers = 'NVDA,AAPL,TSLA,META,AMZN,GOOGL,MSFT,AMD,SPY,QQQ';
                const res = await fetch(`${API_BASE}/options/feed?tickers=${tickers}`);
                const data = await res.json();

                if (data.ok && (data.feed || data.data) && (data.feed || data.data).length > 0) {
                    const items = data.feed || data.data;
                    let html = '<div style="padding: 8px 0;">';

                    items.slice(0, 12).forEach(item => {
                        const typeEmoji = item.type === 'C' ? 'üìà' : 'üìâ';
                        const volOi = item.volume_oi_ratio || 0;
                        const premium = (item.premium || 0) / 1000;
                        const unusualBadge = volOi > 3 ? '<span style="background: var(--yellow); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; margin-left: 8px;">HOT</span>' : '';

                        html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid var(--border);">
                            <div>
                                <span style="font-weight: 600;">${item.ticker || '--'}</span>
                                <span style="color: var(--text-muted); margin-left: 8px;">${typeEmoji} $${item.strike || '--'}</span>
                                ${unusualBadge}
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600;">$${premium.toFixed(0)}K</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Vol/OI: ${volOi.toFixed(1)}x</div>
                            </div>
                        </div>`;
                    });

                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No unusual activity detected</div>';
                }
            } catch (e) {
                console.error('Failed to load unusual activity:', e);
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--red);">Failed to scan</div>';
            }
        }

        // Options Screener
        async function runOptionsScreener() {
            const container = document.getElementById('screener-results');
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">Running screener...</div>';

            try {
                const minPremium = (document.getElementById('screener-min-premium').value || 50) * 1000;
                const minIv = document.getElementById('screener-min-iv').value || 0;
                const sentiment = document.getElementById('screener-sentiment').value;
                const tickers = document.getElementById('screener-tickers').value.trim().toUpperCase() || 'NVDA,AAPL,TSLA,META,AMD';

                let url = `${API_BASE}/options/screener?tickers=${tickers}&min_premium=${minPremium}&min_iv_rank=${minIv}`;
                if (sentiment) url += `&sentiment=${sentiment}`;

                const res = await fetch(url);
                const data = await res.json();

                if (data.ok && (data.results || data.data) && (data.results || data.data).length > 0) {
                    const results = data.results || data.data;
                    let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 12px;">';
                    html += '<thead><tr style="background: var(--bg-hover); border-bottom: 1px solid var(--border);">';
                    html += '<th style="padding: 10px; text-align: left;">Ticker</th>';
                    html += '<th style="padding: 10px; text-align: left;">Type</th>';
                    html += '<th style="padding: 10px; text-align: right;">Strike</th>';
                    html += '<th style="padding: 10px; text-align: right;">Premium</th>';
                    html += '<th style="padding: 10px; text-align: right;">IV Rank</th>';
                    html += '<th style="padding: 10px; text-align: center;">Sentiment</th>';
                    html += '</tr></thead><tbody>';

                    results.slice(0, 20).forEach(r => {
                        const typeEmoji = r.type === 'C' ? 'üìà' : 'üìâ';
                        const sentColor = r.sentiment === 'bullish' ? 'var(--green)' : r.sentiment === 'bearish' ? 'var(--red)' : 'var(--text-muted)';
                        const premium = (r.premium || 0) / 1000;
                        const ivRank = r.iv_rank || 0;

                        html += `<tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 10px; font-weight: 600;">${r.ticker || '--'}</td>
                            <td style="padding: 10px;">${typeEmoji} ${(r.type || 'C').toUpperCase()}</td>
                            <td style="padding: 10px; text-align: right;">$${r.strike || '--'}</td>
                            <td style="padding: 10px; text-align: right; font-weight: 600;">$${premium.toFixed(0)}K</td>
                            <td style="padding: 10px; text-align: right;">${ivRank.toFixed(0)}%</td>
                            <td style="padding: 10px; text-align: center; color: ${sentColor}; font-weight: 600; text-transform: uppercase;">${r.sentiment || 'neutral'}</td>
                        </tr>`;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No results match your filters</div>';
                }
            } catch (e) {
                console.error('Failed to run screener:', e);
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--red);">Screener failed: ' + e.message + '</div>';
            }
        }

        // Smart Money Flow analyzer
        async function loadSmartMoneyFlow() {
            const ticker = document.getElementById('flow-ticker-input').value.trim().toUpperCase();
            if (!ticker) {
                alert('Please enter a ticker symbol');
                return;
            }

            const container = document.getElementById('smart-money-flow-container');
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">Analyzing flow...</div>';

            try {
                const res = await fetch(`${API_BASE}/options/smart-money/${ticker}`);
                const data = await res.json();

                if (data.ok && data.data) {
                    const flow = data.data;
                    const netFlow = flow.net_flow || 0;
                    const callFlow = flow.call_flow || 0;
                    const putFlow = flow.put_flow || 0;
                    const instRatio = flow.institutional_ratio || 0;

                    const flowColor = netFlow > 0 ? 'var(--green)' : netFlow < 0 ? 'var(--red)' : 'var(--text-muted)';
                    const flowLabel = netFlow > 0 ? 'NET INFLOW' : netFlow < 0 ? 'NET OUTFLOW' : 'NEUTRAL';

                    let html = `
                        <div class="grid grid-4" style="margin-bottom: 16px;">
                            <div style="text-align: center; padding: 12px; background: var(--bg-hover); border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">NET FLOW</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: ${flowColor};">$${Math.abs(netFlow / 1e6).toFixed(1)}M</div>
                                <div style="font-size: 0.65rem; color: ${flowColor};">${flowLabel}</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--bg-hover); border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">CALL FLOW</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--green);">$${(callFlow / 1e6).toFixed(1)}M</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--bg-hover); border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">PUT FLOW</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--red);">$${(putFlow / 1e6).toFixed(1)}M</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--bg-hover); border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">INSTITUTIONAL</div>
                                <div style="font-size: 1.25rem; font-weight: 700;">${(instRatio * 100).toFixed(0)}%</div>
                            </div>
                        </div>
                    `;

                    // Notable trades
                    const notable = flow.notable_trades || [];
                    if (notable.length > 0) {
                        html += '<div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 8px;">Notable Trades</div>';
                        html += '<div style="max-height: 200px; overflow-y: auto;">';
                        notable.slice(0, 8).forEach(t => {
                            const signalEmoji = t.signal?.includes('sweep') ? 'üî•' : t.signal?.includes('block') ? 'üü¶' : '‚Ä¢';
                            const premium = (t.premium || 0) / 1000;

                            html += `<div style="display: flex; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid var(--border);">
                                <span>${signalEmoji} $${t.strike || '--'} ${t.type || 'C'}</span>
                                <span style="font-weight: 600;">$${premium.toFixed(0)}K <span style="color: var(--text-muted); font-weight: normal; font-size: 0.75rem;">${t.signal || ''}</span></span>
                            </div>`;
                        });
                        html += '</div>';
                    }

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No flow data for ' + ticker + '</div>';
                }
            } catch (e) {
                console.error('Failed to load smart money flow:', e);
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--red);">Failed to analyze flow</div>';
            }
        }

        // Technical indicators loader
        async function loadTechnicalIndicators() {
            const ticker = document.getElementById('technical-ticker-input').value.trim().toUpperCase();
            if (!ticker) {
                alert('Please enter a ticker symbol');
                return;
            }

            try {
                // Show loading state
                document.getElementById('technical-indicators-container').innerHTML =
                    '<div style="color: var(--text-muted); font-size: 0.8125rem;">Loading...</div>';

                // Fetch technical indicators
                const res = await fetch(`${API_BASE}/options/technical/${ticker}`);
                const data = await res.json();

                if (!data.ok || data.data.error) {
                    throw new Error(data.data?.error || 'Failed to load technical indicators');
                }

                const tech = data.data;

                // Determine trend color
                const trendColors = {
                    'bullish': 'var(--green)',
                    'bearish': 'var(--red)',
                    'neutral': 'var(--text-muted)',
                    'sideways': 'var(--text-muted)'
                };
                const trendColor = trendColors[tech.trend?.toLowerCase()] || 'var(--text-muted)';

                // RSI color coding
                let rsiColor = 'var(--text)';
                if (tech.rsi >= 70) rsiColor = 'var(--red)';
                else if (tech.rsi <= 30) rsiColor = 'var(--green)';

                // Build HTML
                let html = `
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">TREND</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: ${trendColor}; text-transform: uppercase;">
                            ${tech.trend || 'N/A'}
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">Price: $${tech.price?.toFixed(2) || '--'}</div>
                    </div>
                    <div class="sidebar-item">
                        <span class="sidebar-label">SMA 20</span>
                        <span class="sidebar-value">${tech.sma_20 ? '$' + tech.sma_20.toFixed(2) : '--'}</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="sidebar-label">SMA 50</span>
                        <span class="sidebar-value">${tech.sma_50 ? '$' + tech.sma_50.toFixed(2) : '--'}</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="sidebar-label">SMA 200</span>
                        <span class="sidebar-value">${tech.sma_200 ? '$' + tech.sma_200.toFixed(2) : '--'}</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="sidebar-label">RSI (14)</span>
                        <span class="sidebar-value" style="color: ${rsiColor}; font-weight: 600;">${tech.rsi?.toFixed(1) || '--'}</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="sidebar-label">MACD</span>
                        <span class="sidebar-value">${tech.macd?.toFixed(2) || '--'}</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="sidebar-label">Signal</span>
                        <span class="sidebar-value">${tech.macd_signal?.toFixed(2) || '--'}</span>
                    </div>
                `;

                // Add signals if available
                if (tech.signals && tech.signals.length > 0) {
                    html += `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">ACTIVE SIGNALS</div>
                            ${tech.signals.map(signal => `
                                <div style="font-size: 0.75rem; padding: 4px 8px; background: var(--bg-hover); border-radius: 4px; margin-bottom: 4px;">
                                    ${signal}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                document.getElementById('technical-indicators-container').innerHTML = html;

            } catch (e) {
                console.error('Failed to load technical indicators:', e);
                document.getElementById('technical-indicators-container').innerHTML =
                    '<div style="color: var(--red); font-size: 0.8125rem;">Failed to load: ' + e.message + '</div>';
            }
        }

        async function refreshAll() {
            console.log('üîÑ refreshAll() called');
            document.getElementById('last-update').textContent = 'Refreshing...';

            await Promise.all([
                fetchHealth(),
                fetchScan(),
                fetchConvictionAlerts(),
                fetchSupplyChain(),
                fetchEarnings(),
                fetchEvolution(),
                fetchParameters(),
                fetchCorrelations(),
                fetchThemes(),
                fetchMARadar(),
                fetchDeals(),
                fetchContractThemes(),
                fetchRecentContracts(),
                fetchPatentThemes(),
                fetchThemeRadar(),
                fetchThemeAlerts(),
                fetchTrades(),
                fetchUnusualOptions(),
            ]);

            document.getElementById('last-update').textContent = new Date().toLocaleTimeString('en-MY', {
                timeZone: 'Asia/Kuala_Lumpur',
                hour: '2-digit',
                minute: '2-digit'
            }) + ' MYT';
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            refreshAll();

            // Auto-refresh unusual options every 5 minutes
            setInterval(fetchUnusualOptions, 300000);

            // Initialize sync client
            setTimeout(() => {
                syncClient.connect();
            }, 1000);
        });

        // Also refresh AI advisor after trades are loaded
        setTimeout(() => {
            if (typeof refreshAIAdvisor === 'function') {
                refreshAIAdvisor();
            }
        }, 2000);
    </script>
</body>
</html>
