<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Scanner</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìà</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #09090b;
            --bg-card: #18181b;
            --bg-hover: #27272a;
            --border: #27272a;
            --text: #fafafa;
            --text-muted: #a1a1aa;
            --green: #22c55e;
            --green-bg: rgba(34, 197, 94, 0.1);
            --red: #ef4444;
            --red-bg: rgba(239, 68, 68, 0.1);
            --blue: #3b82f6;
            --blue-bg: rgba(59, 130, 246, 0.1);
            --yellow: #eab308;
            --yellow-bg: rgba(234, 179, 8, 0.1);
            --purple: #a855f7;
            --purple-bg: rgba(168, 85, 247, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .market-pulse {
            display: flex;
            gap: 24px;
            font-size: 0.875rem;
        }

        .pulse-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pulse-label { color: var(--text-muted); }
        .pulse-value { font-weight: 600; }
        .pulse-value.up { color: var(--green); }
        .pulse-value.down { color: var(--red); }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
        }

        .btn-primary {
            background: var(--blue);
            color: white;
        }

        .btn-primary:hover { opacity: 0.9; }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        .btn-ghost:hover {
            background: var(--bg-hover);
            color: var(--text);
        }

        .update-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Sync Status */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--bg-hover);
            border-radius: 4px;
            cursor: pointer;
        }

        .sync-status:hover {
            background: var(--bg-card);
        }

        /* Sync Notifications */
        .sync-notification {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            min-width: 280px;
            max-width: 350px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
            transition: opacity 0.3s, transform 0.3s;
        }

        .sync-notification-success {
            border-left: 3px solid var(--green);
        }

        .sync-notification-warning {
            border-left: 3px solid var(--yellow);
        }

        .sync-notification-danger {
            border-left: 3px solid var(--red);
        }

        .sync-notification-info {
            border-left: 3px solid var(--blue);
        }

        .sync-notification-title {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .sync-notification-message {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Tabs */
        .tabs {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
        }

        .tabs-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 4px;
        }

        .tab {
            padding: 12px 20px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
        }

        .tab:hover { color: var(--text); }
        .tab.active {
            color: var(--text);
            border-bottom-color: var(--blue);
        }

        /* Main */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Grid */
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }
        .grid-sidebar { grid-template-columns: 1fr 320px; }

        @media (max-width: 1024px) {
            .grid-2, .grid-3, .grid-4, .grid-5, .grid-sidebar { grid-template-columns: 1fr; }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-body { padding: 20px; }
        .card-body.no-padding { padding: 0; }

        /* Stats */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .stat-value.green { color: var(--green); }
        .stat-value.red { color: var(--red); }
        .stat-value.blue { color: var(--blue); }

        /* Top Picks */
        .top-pick {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
        }

        .top-pick:hover { background: var(--bg-hover); }
        .top-pick:last-child { border-bottom: none; }

        .pick-rank {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--bg-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 12px;
        }

        .pick-rank.gold { background: var(--yellow-bg); color: var(--yellow); }
        .pick-rank.silver { background: var(--blue-bg); color: var(--blue); }
        .pick-rank.bronze { background: var(--purple-bg); color: var(--purple); }

        .pick-info { flex: 1; }

        .pick-ticker {
            font-weight: 600;
            font-size: 0.9375rem;
        }

        .pick-name {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .pick-score {
            text-align: right;
        }

        .pick-score-value {
            font-size: 1.125rem;
            font-weight: 700;
        }

        .pick-score-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .pick-theme {
            margin-left: 16px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 500;
            background: var(--blue-bg);
            color: var(--blue);
        }

        /* Theme Pills */
        .themes-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .theme-pill {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid var(--border);
            background: var(--bg-card);
        }

        .theme-pill:hover { border-color: var(--blue); }
        .theme-pill.active {
            background: var(--blue);
            border-color: var(--blue);
            color: white;
        }

        .theme-pill .count {
            margin-left: 6px;
            opacity: 0.7;
        }

        /* Theme Cards */
        .theme-stocks {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }

        .theme-stock {
            background: var(--bg-hover);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
        }

        .theme-stock:hover {
            background: var(--border);
        }

        .theme-stock-ticker {
            font-weight: 600;
            font-size: 0.9375rem;
            margin-bottom: 4px;
        }

        .theme-stock-change {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .theme-stock-change.up { color: var(--green); }
        .theme-stock-change.down { color: var(--red); }

        /* Table */
        .table-wrapper { overflow-x: auto; }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .table tr:hover { background: var(--bg-hover); }
        .table tr:last-child td { border-bottom: none; }

        .ticker-cell {
            font-weight: 600;
            color: var(--blue);
            cursor: pointer;
        }

        .ticker-cell:hover { text-decoration: underline; }

        .score-bar {
            width: 60px;
            height: 6px;
            background: var(--bg-hover);
            border-radius: 3px;
            overflow: hidden;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .score-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--blue), var(--green));
            border-radius: 3px;
        }

        /* Sidebar */
        .sidebar-card {
            margin-bottom: 16px;
        }

        .sidebar-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-item:last-child { border-bottom: none; }

        .sidebar-label {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .sidebar-value {
            font-size: 0.875rem;
            font-weight: 600;
        }

        /* Fear & Greed Gauge */
        .gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .gauge {
            width: 160px;
            height: 80px;
            position: relative;
        }

        .gauge-bg {
            width: 160px;
            height: 80px;
            border-radius: 80px 80px 0 0;
            background: linear-gradient(90deg, var(--red), var(--yellow), var(--green));
            position: relative;
            overflow: hidden;
        }

        .gauge-bg::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 50px;
            background: var(--bg-card);
            border-radius: 50px 50px 0 0;
        }

        .gauge-needle {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 4px;
            height: 60px;
            background: var(--text);
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(var(--rotation, 0deg));
            border-radius: 2px;
        }

        .gauge-value {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 16px;
        }

        .gauge-label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Alerts */
        .alert {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.8125rem;
            margin-bottom: 12px;
        }

        .alert.warning {
            background: var(--yellow-bg);
            border: 1px solid rgba(234, 179, 8, 0.3);
        }

        .alert.info {
            background: var(--blue-bg);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .alert-icon { font-size: 1rem; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 24px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover { color: var(--text); }

        .modal-body { padding: 24px; }

        /* Loading */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-hover) 25%, var(--border) 50%, var(--bg-hover) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content { flex-wrap: wrap; }
            .market-pulse { display: none; }
            .main { padding: 16px; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span>üìà</span>
                <span>Stock Scanner</span>
            </div>

            <div class="market-pulse" id="market-pulse">
                <div class="pulse-item">
                    <span class="pulse-label">SPY</span>
                    <span class="pulse-value" id="spy-change">--</span>
                </div>
                <div class="pulse-item">
                    <span class="pulse-label">QQQ</span>
                    <span class="pulse-value" id="qqq-change">--</span>
                </div>
                <div class="pulse-item">
                    <span class="pulse-label">VIX</span>
                    <span class="pulse-value" id="vix-value">--</span>
                </div>
                <div class="pulse-item">
                    <span class="pulse-label">Fear/Greed</span>
                    <span class="pulse-value" id="fear-greed">--</span>
                </div>
            </div>

            <div class="header-actions">
                <div class="sync-status" title="Telegram Sync Status">
                    <span id="sync-status-indicator" style="font-size: 0.75rem; color: var(--text-muted);">‚óã</span>
                    <span id="sync-status-text" style="font-size: 0.7rem; color: var(--text-muted);">OFFLINE</span>
                </div>
                <span class="update-time">Updated: <span id="last-update">--:--</span></span>
                <button class="btn btn-ghost" onclick="refreshAll()">‚Üª Refresh</button>
                <a href="https://t.me/Stocks_Story_Bot" target="_blank" class="btn btn-primary">Open Bot</a>
            </div>
        </div>
    </header>

    <!-- Tabs -->
    <nav class="tabs">
        <div class="tabs-inner">
            <div class="tab active" data-tab="overview">Overview</div>
            <div class="tab" data-tab="scan">Scan Results</div>
            <div class="tab" data-tab="watchlist">Watchlist</div>
            <div class="tab" data-tab="learning">Learning</div>
            <div class="tab" data-tab="intelligence">Intelligence</div>
            <div class="tab" data-tab="themes">Themes</div>
            <div class="tab" data-tab="themeradar">Theme Radar</div>
            <div class="tab" data-tab="sec">SEC Intel</div>
            <div class="tab" data-tab="trades">Trades</div>
            <div class="tab" data-tab="analytics">Analytics</div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <!-- Stats Row -->
            <div class="stats-row">
                <div class="stat">
                    <div class="stat-label">Stocks Scanned</div>
                    <div class="stat-value blue" id="stat-scanned">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Hot Opportunities</div>
                    <div class="stat-value green" id="stat-hot">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Developing</div>
                    <div class="stat-value" id="stat-developing">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Watchlist</div>
                    <div class="stat-value" id="stat-watchlist">0</div>
                </div>
            </div>

            <div class="grid grid-sidebar">
                <!-- Main Column -->
                <div>
                    <!-- Alerts -->
                    <div id="alerts-container"></div>

                    <!-- Top Opportunities -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">üéØ Top Opportunities</div>
                            <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="fetchScan()">Refresh</button>
                        </div>
                        <div class="card-body no-padding" id="top-picks">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìä</div>
                                <div>Loading opportunities...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Hot Themes -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üî• Hot Themes</div>
                        </div>
                        <div class="card-body">
                            <div class="themes-row" id="theme-pills">
                                
                            </div>
                            <div id="theme-stocks" style="margin-top: 20px;">
                                <div class="theme-stocks" id="theme-stocks-grid">
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div>
                    <!-- Fear & Greed -->
                    <div class="card sidebar-card">
                        <div class="card-header">
                            <div class="card-title">Fear & Greed</div>
                        </div>
                        <div class="card-body">
                            <div class="gauge-container">
                                <div class="gauge">
                                    <div class="gauge-bg"></div>
                                    <div class="gauge-needle" id="gauge-needle" style="--rotation: 0deg;"></div>
                                </div>
                                <div class="gauge-value" id="fg-value">--</div>
                                <div class="gauge-label" id="fg-label">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Market Health -->
                    <div class="card sidebar-card">
                        <div class="card-header">
                            <div class="card-title">Market Health</div>
                        </div>
                        <div class="card-body">
                            <div class="sidebar-item">
                                <span class="sidebar-label">Breadth Score</span>
                                <span class="sidebar-value" id="breadth-score">--</span>
                            </div>
                            <div class="sidebar-item">
                                <span class="sidebar-label">Advance/Decline</span>
                                <span class="sidebar-value" id="adv-dec">--</span>
                            </div>
                            <div class="sidebar-item">
                                <span class="sidebar-label">New Highs/Lows</span>
                                <span class="sidebar-value" id="hi-lo">--</span>
                            </div>
                            <div class="sidebar-item">
                                <span class="sidebar-label">Put/Call Ratio</span>
                                <span class="sidebar-value" id="put-call">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- High Conviction Alerts -->
                    <div class="card sidebar-card">
                        <div class="card-header">
                            <div class="card-title">üéØ High Conviction</div>
                            <button class="btn btn-ghost" style="padding: 2px 8px; font-size: 0.7rem;" onclick="fetchConvictionAlerts()">Refresh</button>
                        </div>
                        <div class="card-body" id="conviction-alerts-container">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading multi-signal alerts...</div>
                        </div>
                    </div>

                    <!-- Supply Chain Opportunities -->
                    <div class="card sidebar-card">
                        <div class="card-header">
                            <div class="card-title">üîó Supply Chain</div>
                            <button class="btn btn-ghost" style="padding: 2px 8px; font-size: 0.7rem;" onclick="fetchSupplyChain()">Refresh</button>
                        </div>
                        <div class="card-body" id="supplychain-container">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading lagging opportunities...</div>
                        </div>
                    </div>

                    <!-- Upcoming Earnings -->
                    <div class="card sidebar-card">
                        <div class="card-header">
                            <div class="card-title">üìÖ Earnings Soon</div>
                        </div>
                        <div class="card-body" id="earnings-sidebar">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading...</div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Quick Actions</div>
                        </div>
                        <div class="card-body" style="display: flex; flex-direction: column; gap: 8px;">
                            <button class="btn btn-primary" onclick="triggerScan('indices')" style="width: 100%;">üîÑ Scan S&P + NASDAQ (~600)</button>
                            <button class="btn btn-ghost" onclick="triggerScan('full')" style="width: 100%;">üåê Full Scan (300M+ mcap)</button>
                            <button class="btn btn-ghost" onclick="fetchScan()" style="width: 100%;">üìä Refresh Results</button>
                            <button class="btn btn-ghost" onclick="fetchBriefing()" style="width: 100%;">ü§ñ AI Briefing</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scan Results Tab -->
        <div id="scan" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìä Scan Results</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" style="padding: 4px 12px; font-size: 0.75rem;" onclick="triggerScan('indices')">üîÑ Scan</button>
                        <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="triggerScan('full')">üåê Full</button>
                        <select id="filter-strength" class="btn btn-ghost" onchange="filterTable()">
                            <option value="">All Strength</option>
                            <option value="hot">Hot</option>
                            <option value="developing">Developing</option>
                            <option value="watchlist">Watchlist</option>
                        </select>
                        <select id="filter-theme" class="btn btn-ghost" onchange="filterTable()">
                            <option value="">All Themes</option>
                            
                        </select>
                    </div>
                </div>
                <div class="card-body no-padding">
                    <div class="table-wrapper">
                        <table class="table" id="scan-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Ticker</th>
                                    <th>Score</th>
                                    <th>Strength</th>
                                    <th>Theme</th>
                                    <th>Change</th>
                                    <th>Volume</th>
                                    <th>RS</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="scan-table-body">
                                
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Watchlist Tab -->
        <div id="watchlist" class="tab-content">
            <!-- Statistics Row -->
            <div class="stats-row" style="margin-bottom: 16px;">
                <div class="stat">
                    <div class="stat-label">Total Items</div>
                    <div class="stat-value blue" id="watchlist-stat-total">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Ready to Trade</div>
                    <div class="stat-value green" id="watchlist-stat-ready">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">High Priority</div>
                    <div class="stat-value yellow" id="watchlist-stat-high">0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">‚≠ê Watchlist</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" style="padding: 4px 12px; font-size: 0.75rem;" onclick="updateAllPrices()">‚Üª Update Prices</button>
                        <select id="watchlist-filter-priority" class="btn btn-ghost" onchange="filterWatchlist()">
                            <option value="">All Priorities</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                        <input type="text" id="watchlist-search" placeholder="Search..."
                               style="padding: 4px 12px; font-size: 0.75rem; background: var(--bg-hover); border: 1px solid var(--border); border-radius: 6px; color: var(--text);"
                               oninput="searchWatchlist(this.value)">
                    </div>
                </div>
                <div class="card-body no-padding">
                    <div class="table-wrapper">
                        <table class="table" id="watchlist-table">
                            <thead>
                                <tr>
                                    <th>Ticker</th>
                                    <th>Price</th>
                                    <th>Change</th>
                                    <th>Priority</th>
                                    <th>Score</th>
                                    <th>Quality</th>
                                    <th>Ready</th>
                                    <th>X Sentiment</th>
                                    <th>AI Decision</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="watchlist-table-body">
                                <tr>
                                    <td colspan="10" style="text-align: center; color: var(--text-muted); padding: 24px;">
                                        Loading watchlist...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Learning System Tab -->
        <div id="learning" class="tab-content">
            <!-- Status Row -->
            <div class="stats-row" style="margin-bottom: 16px;">
                <div class="stat">
                    <div class="stat-label">Total Trades</div>
                    <div class="stat-value blue" id="learning-stat-trades">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Learning Active</div>
                    <div class="stat-value green" id="learning-stat-active">‚úó</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Circuit Breaker</div>
                    <div class="stat-value" id="learning-stat-breaker">üü¢ OK</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Current Regime</div>
                    <div class="stat-value purple" id="learning-stat-regime">unknown</div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="card" style="margin-bottom: 16px;">
                <div class="card-header">
                    <div class="card-title">üìä Performance Metrics</div>
                    <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="refreshLearningDashboard()">‚Üª Refresh</button>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <!-- Sharpe Ratio -->
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">Sharpe Ratio</div>
                            <div style="font-size: 2rem; font-weight: 700;" id="metric-sharpe">0.00</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);" id="metric-sharpe-target">Target: 1.50</div>
                        </div>

                        <!-- Win Rate -->
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">Win Rate</div>
                            <div style="font-size: 2rem; font-weight: 700;" id="metric-winrate">0%</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">Target: 65%</div>
                        </div>

                        <!-- Profit Factor -->
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">Profit Factor</div>
                            <div style="font-size: 2rem; font-weight: 700;" id="metric-pf">0.00</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">Target: 2.00</div>
                        </div>

                        <!-- Max Drawdown -->
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">Max Drawdown</div>
                            <div style="font-size: 2rem; font-weight: 700;" id="metric-dd">0%</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">Limit: 15%</div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <!-- Component Weights -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">‚öñÔ∏è Component Weights</div>
                        <span style="font-size: 0.75rem; color: var(--text-muted);" id="weights-confidence">Confidence: 0%</span>
                    </div>
                    <div class="card-body">
                        <canvas id="weights-chart" style="max-height: 250px;"></canvas>
                    </div>
                </div>

                <!-- Component Performance -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üéØ Component Performance</div>
                        <span style="font-size: 0.75rem; color: var(--text-muted);">Win Probability</span>
                    </div>
                    <div class="card-body">
                        <canvas id="component-performance-chart" style="max-height: 250px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Weights Evolution Over Time -->
            <div class="card" style="margin-bottom: 16px;">
                <div class="card-header">
                    <div class="card-title">üìà Weight Evolution Over Time</div>
                    <span style="font-size: 0.75rem; color: var(--text-muted);">Last 50 trades</span>
                </div>
                <div class="card-body">
                    <canvas id="weights-evolution-chart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- Regime Timeline -->
            <div class="card" style="margin-bottom: 16px;">
                <div class="card-header">
                    <div class="card-title">üîÑ Market Regime Detection</div>
                    <span style="font-size: 0.75rem; color: var(--text-muted);" id="regime-confidence">Confidence: 0%</span>
                </div>
                <div class="card-body">
                    <div id="regime-timeline" style="min-height: 100px;">
                        <div style="color: var(--text-muted); text-align: center; padding: 24px;">
                            Loading regime data...
                        </div>
                    </div>
                    <div style="margin-top: 16px;">
                        <canvas id="regime-probabilities-chart" style="max-height: 200px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Meta-Learner (Tier 4) -->
            <div class="card" style="margin-bottom: 16px;" id="meta-learner-section">
                <div class="card-header">
                    <div class="card-title">üß† Meta-Learner (Tier 4)</div>
                    <span style="font-size: 0.75rem; color: var(--text-muted);">Ensemble Performance</span>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <canvas id="learner-selection-chart" style="max-height: 250px;"></canvas>
                        </div>
                        <div>
                            <canvas id="learner-performance-chart" style="max-height: 250px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">‚öôÔ∏è Controls</div>
                </div>
                <div class="card-body">
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="toggleCircuitBreaker()">Toggle Circuit Breaker</button>
                        <button class="btn btn-ghost" onclick="exportLearningData()">Export Data</button>
                        <button class="btn btn-ghost" onclick="viewFullReport()">View Full Report</button>
                        <button class="btn btn-ghost" onclick="refreshLearningDashboard()">Refresh Dashboard</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Intelligence Tab -->
        <div id="intelligence" class="tab-content">
            <!-- Header Stats -->
            <div class="stats-row" style="margin-bottom: 16px;">
                <div class="stat">
                    <div class="stat-label">Gov Contracts</div>
                    <div class="stat-value blue" id="intel-contracts">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Recent Patents</div>
                    <div class="stat-value green" id="intel-patents">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">X Sentiment</div>
                    <div class="stat-value purple" id="intel-x-sentiment">N/A</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Trends Breakouts</div>
                    <div class="stat-value yellow" id="intel-trends">0</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <!-- X Sentiment Chart -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ùïè X Sentiment (xAI)</div>
                        <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="refreshXSentiment()">‚Üª</button>
                    </div>
                    <div class="card-body">
                        <canvas id="xSentimentChart" style="max-height: 250px;"></canvas>
                        <div id="xSentimentList" style="margin-top: 12px; max-height: 200px; overflow-y: auto;">
                            <div style="color: var(--text-muted); font-size: 0.8125rem; text-align: center; padding: 20px;">
                                Set XAI_API_KEY to enable X Intelligence
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Google Trends Chart -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üîç Google Trends</div>
                        <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="refreshGoogleTrends()">‚Üª</button>
                    </div>
                    <div class="card-body">
                        <canvas id="trendsChart" style="max-height: 250px;"></canvas>
                        <div id="trendsBreakoutList" style="margin-top: 12px;">
                            <div style="color: var(--text-muted); font-size: 0.8125rem; text-align: center; padding: 20px;">
                                Loading trends data...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <!-- Government Contracts -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üèõÔ∏è Government Contracts</div>
                        <span style="font-size: 0.75rem; color: var(--text-muted);">Last 6 months</span>
                    </div>
                    <div class="card-body">
                        <canvas id="contractsChart" style="max-height: 250px;"></canvas>
                        <div id="gov-contracts-list" style="margin-top: 12px; max-height: 200px; overflow-y: auto;">
                            <div style="color: var(--text-muted); font-size: 0.8125rem; text-align: center; padding: 20px;">
                                Loading contracts data...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Patent Activity -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìú Patent Activity</div>
                        <span style="font-size: 0.75rem; color: var(--text-muted);">Last 6 months</span>
                    </div>
                    <div class="card-body">
                        <canvas id="patentsChart" style="max-height: 250px;"></canvas>
                        <div id="patent-list" style="margin-top: 12px; max-height: 200px; overflow-y: auto;">
                            <div style="color: var(--text-muted); font-size: 0.8125rem; text-align: center; padding: 20px;">
                                Set PATENTSVIEW_API_KEY to enable patent tracking
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Supply Chain Relationships -->
            <div class="card" style="margin-bottom: 16px;">
                <div class="card-header">
                    <div class="card-title">üîó Supply Chain Relationships</div>
                    <div style="display: flex; gap: 8px;">
                        <select id="theme-selector" style="padding: 4px 8px; border-radius: 4px; background: var(--bg-card); color: var(--text); border: 1px solid var(--border);">
                            <option value="ai_infrastructure">AI Infrastructure</option>
                            <option value="nuclear_energy">Nuclear Energy</option>
                            <option value="defense_tech">Defense Tech</option>
                            <option value="ev_battery">EV/Battery</option>
                            <option value="biotech_glp1">Biotech (GLP-1)</option>
                            <option value="cybersecurity">Cybersecurity</option>
                        </select>
                        <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="loadSupplyChain()">Load</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="supplyChainViz" style="min-height: 300px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;" id="supply-chain-grid">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Catalyst Sources Breakdown -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üéØ Catalyst Sources Distribution</div>
                    <span style="font-size: 0.75rem; color: var(--text-muted);">From latest scan</span>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <canvas id="catalystChart" style="max-height: 300px;"></canvas>
                        <div id="catalystBreakdownList">
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg); border-radius: 4px;">
                                    <span>üì∞ News</span>
                                    <span id="catalyst-news">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg); border-radius: 4px;">
                                    <span>üèõÔ∏è Gov Contracts</span>
                                    <span id="catalyst-contracts">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg); border-radius: 4px;">
                                    <span>üìú Patents</span>
                                    <span id="catalyst-patents">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg); border-radius: 4px;">
                                    <span>üìã SEC Filings</span>
                                    <span id="catalyst-sec">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg); border-radius: 4px;">
                                    <span>üë§ Insider Activity</span>
                                    <span id="catalyst-insider">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Themes Tab -->
        <div id="themes" class="tab-content">
            <div class="themes-row" style="margin-bottom: 24px;" id="all-themes">
                
            </div>

            <div class="grid grid-3" id="theme-cards">
                
            </div>
        </div>

        <!-- Theme Radar Tab (Theme Intelligence Hub) -->
        <div id="themeradar" class="tab-content">
            <div class="grid grid-3">
                <!-- Theme Radar Visual -->
                <div class="card" style="grid-column: span 2;">
                    <div class="card-header">
                        <div class="card-title">üì° Theme Radar</div>
                        <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="fetchThemeRadar()">Refresh</button>
                    </div>
                    <div class="card-body" id="theme-radar-container">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px;" id="theme-radar-grid">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading theme radar...</div>
                        </div>
                    </div>
                </div>

                <!-- Theme Alerts -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üö® Theme Alerts</div>
                    </div>
                    <div class="card-body" id="theme-alerts-container">
                        <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading alerts...</div>
                    </div>
                </div>
            </div>

            <!-- Theme Lifecycle Summary -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">üìä Theme Lifecycle Summary</div>
                    <button class="btn btn-primary" style="padding: 4px 12px; font-size: 0.75rem;" onclick="runThemeAnalysis()">Run Full Analysis</button>
                </div>
                <div class="card-body">
                    <div class="grid grid-5" id="lifecycle-summary">
                        <div class="stat" style="text-align: center;">
                            <div style="font-size: 1.5rem;">üå±</div>
                            <div class="stat-value" id="emerging-count">-</div>
                            <div class="stat-label">Emerging</div>
                        </div>
                        <div class="stat" style="text-align: center;">
                            <div style="font-size: 1.5rem;">üöÄ</div>
                            <div class="stat-value green" id="accelerating-count">-</div>
                            <div class="stat-label">Accelerating</div>
                        </div>
                        <div class="stat" style="text-align: center;">
                            <div style="font-size: 1.5rem;">üî•</div>
                            <div class="stat-value yellow" id="peak-count">-</div>
                            <div class="stat-label">At Peak</div>
                        </div>
                        <div class="stat" style="text-align: center;">
                            <div style="font-size: 1.5rem;">üìâ</div>
                            <div class="stat-value red" id="declining-count">-</div>
                            <div class="stat-label">Declining</div>
                        </div>
                        <div class="stat" style="text-align: center;">
                            <div style="font-size: 1.5rem;">üíÄ</div>
                            <div class="stat-value" id="dead-count">-</div>
                            <div class="stat-label">Dead</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Theme Details Table -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">üìã All Themes</div>
                </div>
                <div class="card-body no-padding">
                    <div class="table-container">
                        <table class="data-table" id="themes-detail-table">
                            <thead>
                                <tr>
                                    <th>Theme</th>
                                    <th>Lifecycle</th>
                                    <th>Score</th>
                                    <th>Velocity</th>
                                    <th>Tickers</th>
                                </tr>
                            </thead>
                            <tbody id="themes-detail-body">
                                <tr><td colspan="5" style="text-align: center; color: var(--text-muted);">Click "Refresh" to load data</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Ticker Theme Lookup -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">üéØ Ticker Theme Boost</div>
                </div>
                <div class="card-body">
                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <input type="text" id="ticker-theme-input" placeholder="Enter ticker (e.g., NVDA)..."
                            style="flex: 1; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.875rem;">
                        <button class="btn btn-primary" onclick="lookupTickerTheme()">Check Boost</button>
                    </div>
                    <div id="ticker-theme-result" style="font-size: 0.8125rem;"></div>
                </div>
            </div>
        </div>

        <!-- SEC Intelligence Tab -->
        <div id="sec" class="tab-content">
            <div class="grid grid-3">
                <!-- M&A Radar -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üîç M&A Radar</div>
                        <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="fetchMARadar()">Refresh</button>
                    </div>
                    <div class="card-body" id="ma-radar-container">
                        <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading M&A activity...</div>
                    </div>
                </div>

                <!-- Active Deals -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ü§ù Active Deals</div>
                        <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="fetchDeals()">Refresh</button>
                    </div>
                    <div class="card-body" id="deals-container">
                        <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading deals...</div>
                    </div>
                </div>

                <!-- Quick Lookup -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìã SEC Lookup</div>
                    </div>
                    <div class="card-body">
                        <div style="margin-bottom: 12px;">
                            <input type="text" id="sec-ticker-input" placeholder="Enter ticker..."
                                style="width: 100%; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.875rem;">
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-ghost" onclick="lookupSECFilings()" style="flex: 1;">Filings</button>
                            <button class="btn btn-ghost" onclick="lookupMACheck()" style="flex: 1;">M&A Check</button>
                            <button class="btn btn-ghost" onclick="lookupInsider()" style="flex: 1;">Insider</button>
                        </div>
                        <div id="sec-lookup-result" style="margin-top: 12px; font-size: 0.8125rem;"></div>
                    </div>
                </div>
            </div>

            <!-- Deal Tracker Table -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">üìä Deal Tracker</div>
                    <button class="btn btn-primary" style="padding: 4px 12px; font-size: 0.75rem;" onclick="showAddDealModal()">+ Add Deal</button>
                </div>
                <div class="card-body no-padding">
                    <div class="table-container">
                        <table class="data-table" id="deals-table">
                            <thead>
                                <tr>
                                    <th>Target</th>
                                    <th>Acquirer</th>
                                    <th>Deal $</th>
                                    <th>Current</th>
                                    <th>Spread</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="deals-table-body">
                                <tr><td colspan="6" style="text-align: center; color: var(--text-muted);">No deals tracked. Click + Add Deal to start.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recent SEC Filings Feed -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">üìÑ Recent Filings Feed</div>
                </div>
                <div class="card-body" id="filings-feed">
                    <div style="color: var(--text-muted); font-size: 0.8125rem;">Select a ticker above to view filings...</div>
                </div>
            </div>

            <!-- Government Contracts Section -->
            <div style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">
                <h3 style="font-size: 1rem; margin-bottom: 16px; color: var(--text);">üèõÔ∏è Government Contracts</h3>
                <p style="color: var(--text-muted); font-size: 0.8125rem; margin-bottom: 16px;">
                    Track federal spending on defense, tech, and infrastructure. Government contracts often signal sector momentum.
                </p>
                <div class="grid grid-3">
                    <!-- Contract Themes -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìä Theme Spending</div>
                            <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="fetchContractThemes()">Refresh</button>
                        </div>
                        <div class="card-body" id="contract-themes-container">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading contract data...</div>
                        </div>
                    </div>

                    <!-- Recent Contracts -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìã Recent Awards</div>
                            <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="fetchRecentContracts()">Refresh</button>
                        </div>
                        <div class="card-body" id="recent-contracts-container">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading recent contracts...</div>
                        </div>
                    </div>

                    <!-- Company Lookup -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üîç Company Lookup</div>
                        </div>
                        <div class="card-body">
                            <div style="margin-bottom: 12px;">
                                <input type="text" id="contract-ticker-input" placeholder="Enter ticker (e.g., LMT)..."
                                    style="width: 100%; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.875rem;">
                            </div>
                            <button class="btn btn-primary" onclick="lookupCompanyContracts()" style="width: 100%;">Search Contracts</button>
                            <div id="contract-lookup-result" style="margin-top: 12px; font-size: 0.8125rem;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patent Intelligence Section -->
            <div style="margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">
                <h3 style="font-size: 1rem; margin-bottom: 16px; color: var(--text);">üî¨ Patent Intelligence</h3>
                <p style="color: var(--text-muted); font-size: 0.8125rem; margin-bottom: 16px;">
                    Patents are filed 6-12 months before product launches. Track R&D activity as a leading indicator.
                </p>
                <div class="grid grid-3">
                    <!-- Patent Themes -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üè∑Ô∏è Theme Activity</div>
                            <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="fetchPatentThemes()">Refresh</button>
                        </div>
                        <div class="card-body" id="patent-themes-container">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading patent themes...</div>
                        </div>
                    </div>

                    <!-- Patent Lookup -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üîç Company Patents</div>
                        </div>
                        <div class="card-body">
                            <div style="margin-bottom: 12px;">
                                <input type="text" id="patent-ticker-input" placeholder="Enter ticker (e.g., NVDA)..."
                                    style="width: 100%; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.875rem;">
                            </div>
                            <button class="btn btn-primary" onclick="lookupCompanyPatents()" style="width: 100%;">Search Patents</button>
                            <div id="patent-lookup-result" style="margin-top: 12px; font-size: 0.8125rem;"></div>
                        </div>
                    </div>

                    <!-- Patent Stats -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìä Why Patents Matter</div>
                        </div>
                        <div class="card-body" style="font-size: 0.8125rem; color: var(--text-muted);">
                            <div style="margin-bottom: 8px;"><strong style="color: var(--green);">üìà Leading Indicator</strong><br>Patent filings precede product launches by 6-12 months</div>
                            <div style="margin-bottom: 8px;"><strong style="color: var(--blue);">üí∞ R&D Investment</strong><br>Surge in patents = heavy investment in area</div>
                            <div><strong style="color: var(--yellow);">üéØ Theme Discovery</strong><br>Track emerging tech before it hits the market</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trades Tab - Professional Trading Dashboard -->
        <div id="trades" class="tab-content">
            <!-- Enhanced Stats Row -->
            <div class="stats-row" style="grid-template-columns: repeat(6, 1fr);">
                <div class="stat">
                    <div class="stat-label">Open Positions</div>
                    <div class="stat-value blue" id="trade-positions-count">--</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Watchlist</div>
                    <div class="stat-value" id="trade-watchlist-count">--</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Total P&L</div>
                    <div class="stat-value" id="trade-total-pnl">--</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-value green" id="trade-win-rate">--</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Portfolio Risk</div>
                    <div class="stat-value" id="trade-risk-level">--</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Alerts</div>
                    <div class="stat-value red" id="trade-high-risk">--</div>
                </div>
            </div>

            <!-- Risk Alerts Banner -->
            <div id="trade-alerts-container"></div>

            <!-- Main 3-Column Layout -->
            <div style="display: grid; grid-template-columns: 1fr 380px; gap: 20px; margin-top: 20px;">
                <!-- Left Column - Positions & Journal -->
                <div>
                    <!-- AI Trade Advisor -->
                    <div class="card" style="margin-bottom: 20px; border-left: 3px solid var(--purple);">
                        <div class="card-header">
                            <div class="card-title">ü§ñ AI Trade Advisor</div>
                            <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="refreshAIAdvisor()">Refresh</button>
                        </div>
                        <div class="card-body" id="ai-advisor-container">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;" id="ai-recommendations">
                                <div style="background: var(--bg-hover); padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">PRIORITY ACTION</div>
                                    <div style="font-size: 1.1rem; font-weight: 600;" id="ai-priority-action">--</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">MARKET REGIME</div>
                                    <div style="font-size: 1.1rem; font-weight: 600;" id="ai-market-regime">--</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">OVERALL STANCE</div>
                                    <div style="font-size: 1.1rem; font-weight: 600;" id="ai-stance">--</div>
                                </div>
                            </div>
                            <div style="margin-top: 16px; padding: 12px; background: var(--bg-hover); border-radius: 8px;">
                                <div style="font-size: 0.8125rem; color: var(--text-muted);" id="ai-insight">Click refresh to get AI-powered trading insights based on your positions and market conditions...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Position Cards Grid -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">üìä Open Positions</div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="scanAllPositions()">üîç Scan All</button>
                                <button class="btn btn-primary" style="padding: 4px 12px; font-size: 0.75rem;" onclick="showAddTradeModal()">+ Add Trade</button>
                            </div>
                        </div>
                        <div class="card-body" id="position-cards-container">
                            <div style="color: var(--text-muted); text-align: center; padding: 40px;">Loading positions...</div>
                        </div>
                    </div>

                    <!-- Smart Trade Journal -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">üìì Trade Journal</div>
                            <div style="display: flex; gap: 8px;">
                                <select id="journal-filter" style="background: var(--bg-hover); border: 1px solid var(--border); color: var(--text); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;" onchange="filterJournal()">
                                    <option value="all">All Entries</option>
                                    <option value="trade">Trades</option>
                                    <option value="note">Notes</option>
                                    <option value="lesson">Lessons</option>
                                    <option value="mistake">Mistakes</option>
                                </select>
                                <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="showAddJournalEntry()">+ Add Entry</button>
                            </div>
                        </div>
                        <div class="card-body" id="journal-container" style="max-height: 400px; overflow-y: auto;">
                            <div style="color: var(--text-muted); text-align: center; padding: 20px;">Loading journal...</div>
                        </div>
                    </div>

                    <!-- Watchlist -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìã Watchlist</div>
                        </div>
                        <div class="card-body" id="watchlist-cards-container">
                            <div style="color: var(--text-muted); text-align: center; padding: 20px;">Loading watchlist...</div>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div>
                    <!-- Quick Actions -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">‚ö° Quick Actions</div>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <button class="btn btn-primary" style="padding: 10px;" onclick="showAddTradeModal()">üìù Add Trade</button>
                                <button class="btn btn-ghost" style="padding: 10px;" onclick="showBuyModal()">üí∞ Log Buy</button>
                                <button class="btn btn-ghost" style="padding: 10px;" onclick="showSellModal()">üíµ Log Sell</button>
                                <button class="btn btn-ghost" style="padding: 10px;" onclick="fetchDailyReport()">üìä Report</button>
                            </div>
                            <button class="btn btn-ghost" style="width: 100%; margin-top: 8px; padding: 10px;" onclick="showAddJournalEntry()">üìì Add Journal Entry</button>
                        </div>
                    </div>

                    <!-- Portfolio Summary with Charts -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">üíº Portfolio Overview</div>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">INVESTED</div>
                                    <div style="font-size: 1.1rem; font-weight: 600;" id="portfolio-invested">--</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">CURRENT</div>
                                    <div style="font-size: 1.1rem; font-weight: 600;" id="portfolio-value">--</div>
                                </div>
                            </div>
                            <div style="background: var(--bg-hover); padding: 16px; border-radius: 8px; text-align: center; margin-bottom: 16px;">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">TOTAL P&L</div>
                                <div style="font-size: 1.5rem; font-weight: 700;" id="portfolio-pnl">--</div>
                            </div>
                            <!-- Theme Concentration -->
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">THEME CONCENTRATION</div>
                            <div id="theme-concentration-chart" style="margin-bottom: 12px;">
                                <div style="color: var(--text-muted); font-size: 0.75rem;">No positions</div>
                            </div>
                        </div>
                    </div>

                    <!-- Scaling Opportunities -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">üìà Scale Signals</div>
                        </div>
                        <div class="card-body" id="scale-opportunities">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">Run scan to detect opportunities...</div>
                        </div>
                    </div>

                    <!-- Performance Metrics -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <div class="card-title">üìà Performance</div>
                        </div>
                        <div class="card-body">
                            <div class="sidebar-item">
                                <span class="sidebar-label">Avg Win</span>
                                <span class="sidebar-value green" id="perf-avg-win">--</span>
                            </div>
                            <div class="sidebar-item">
                                <span class="sidebar-label">Avg Loss</span>
                                <span class="sidebar-value red" id="perf-avg-loss">--</span>
                            </div>
                            <div class="sidebar-item">
                                <span class="sidebar-label">Profit Factor</span>
                                <span class="sidebar-value" id="perf-profit-factor">--</span>
                            </div>
                            <div class="sidebar-item">
                                <span class="sidebar-label">Best Trade</span>
                                <span class="sidebar-value green" id="perf-best">--</span>
                            </div>
                            <div class="sidebar-item">
                                <span class="sidebar-label">Worst Trade</span>
                                <span class="sidebar-value red" id="perf-worst">--</span>
                            </div>
                            <div class="sidebar-item">
                                <span class="sidebar-label">Avg Hold Time</span>
                                <span class="sidebar-value" id="perf-hold-time">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üïê Activity Feed</div>
                        </div>
                        <div class="card-body" id="recent-activity" style="max-height: 200px; overflow-y: auto;">
                            <div style="color: var(--text-muted); font-size: 0.8125rem;">No recent activity</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="grid grid-2">
                <!-- Evolution Engine -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üß¨ Evolution Engine</div>
                    </div>
                    <div class="card-body">
                        <div class="sidebar-item">
                            <span class="sidebar-label">Learning Cycles</span>
                            <span class="sidebar-value" id="evo-cycles">--</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="sidebar-label">Overall Accuracy</span>
                            <span class="sidebar-value" id="evo-accuracy">--</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="sidebar-label">Calibration Score</span>
                            <span class="sidebar-value" id="evo-calibration">--</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="sidebar-label">Last Evolution</span>
                            <span class="sidebar-value" id="evo-last">--</span>
                        </div>
                    </div>
                </div>

                <!-- Adaptive Weights -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">‚öñÔ∏è Adaptive Weights</div>
                    </div>
                    <div class="card-body" id="weights-container">
                        <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading...</div>
                    </div>
                </div>

                <!-- Parameter Learning -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">‚öôÔ∏è Parameter Learning</div>
                    </div>
                    <div class="card-body">
                        <div class="sidebar-item">
                            <span class="sidebar-label">Total Parameters</span>
                            <span class="sidebar-value" id="param-total">--</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="sidebar-label">Parameters Learned</span>
                            <span class="sidebar-value" id="param-learned">--</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="sidebar-label">Learning Progress</span>
                            <span class="sidebar-value" id="param-progress">--</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="sidebar-label">Avg Confidence</span>
                            <span class="sidebar-value" id="param-confidence">--</span>
                        </div>
                    </div>
                </div>

                <!-- Correlations -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üîó Correlations</div>
                    </div>
                    <div class="card-body" id="correlations-container">
                        <div style="color: var(--text-muted); font-size: 0.8125rem;">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- AI Briefing -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title">ü§ñ AI Market Briefing</div>
                    <button class="btn btn-ghost" style="padding: 4px 12px; font-size: 0.75rem;" onclick="fetchBriefing()">Refresh</button>
                </div>
                <div class="card-body" id="briefing-container">
                    <div style="color: var(--text-muted); font-size: 0.8125rem;">Click refresh to generate AI briefing...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">Stock Details</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                Loading...
            </div>
        </div>
    </div>

    <!-- Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        // Auto-detect API base URL from current location
        const API_BASE = `${window.location.protocol}//${window.location.host}/api`;

        // =============================================================================
        // SOCKET.IO SYNC CLIENT
        // =============================================================================

        class SyncClient {
            constructor() {
                this.socket = null;
                this.clientId = null;
                this.connected = false;
                this.eventHandlers = {};
            }

            connect() {
                try {
                    // Connect to same origin (API server) with Socket.IO
                    const serverUrl = API_BASE.replace('/api', '');
                    const isSecure = window.location.protocol === 'https:';
                    console.log('Connecting to sync server:', serverUrl);

                    this.socket = io(serverUrl, {
                        transports: ['polling'],  // Polling only - WebSocket upgrade fails on Railway
                        secure: isSecure,
                        reconnection: true,
                        reconnectionAttempts: 3,
                        reconnectionDelay: 3000,
                        reconnectionDelayMax: 10000,
                        timeout: 10000,
                    });

                    // Connection events
                    this.socket.on('connect', () => this.onConnect());
                    this.socket.on('disconnect', (reason) => this.onDisconnect(reason));
                    this.socket.on('connect_error', (error) => this.onError(error));

                    // Sync events
                    this.socket.on('connected', (data) => this.handleConnected(data));
                    this.socket.on('sync_history', (data) => this.handleSyncHistory(data));
                    this.socket.on('sync_event', (data) => this.handleSyncEvent(data));
                    this.socket.on('status', (data) => this.handleStatus(data));
                    this.socket.on('heartbeat_ack', () => {});
                    this.socket.on('error', (data) => console.debug('Sync error:', data));

                } catch (e) {
                    console.debug('Sync server unavailable');
                    this.updateSyncStatus('unavailable');
                }
            }

            onConnect() {
                console.log('Real-time sync connected');
                this.connected = true;
                this.failCount = 0;
                this.updateSyncStatus('connected');
            }

            onDisconnect(reason) {
                console.debug('Sync disconnected:', reason);
                this.connected = false;
                this.updateSyncStatus('disconnected');
            }

            onError(error) {
                this.failCount = (this.failCount || 0) + 1;
                if (this.failCount <= 2) {
                    console.debug('Sync connection attempt', this.failCount);
                }
                if (this.failCount >= 3) {
                    // Give up quietly - sync is optional
                    this.updateSyncStatus('unavailable');
                    if (this.socket) {
                        this.socket.disconnect();
                    }
                    return;
                }
                this.updateSyncStatus('error');
            }

            handleConnected(data) {
                this.clientId = data.client_id;
                console.log('Sync client ID:', this.clientId);
                this.showNotification('Sync Connected', 'Real-time Telegram sync active', 'success');
            }

            handleSyncHistory(data) {
                const events = data.events || [];
                console.log(`Received ${events.length} historical events`);
                events.forEach(event => this.processEvent(event, false));
            }

            handleSyncEvent(data) {
                const event = data.event;
                if (event) {
                    this.processEvent(event, true);
                }
            }

            handleStatus(data) {
                this.updateSyncStatusDetails(data);
            }

            processEvent(event, notify = true) {
                const eventType = event.event_type;
                const source = event.source;
                const payload = event.payload || {};

                console.log(`Sync event: ${eventType} from ${source}`);

                // Handle different event types
                switch (eventType) {
                    case 'trade_created':
                        if (source === 'telegram' && notify) {
                            this.showNotification('Trade Added (Telegram)', `${payload.ticker} added to watchlist`, 'info');
                            fetchTrades();
                        }
                        break;

                    case 'buy_executed':
                        if (source === 'telegram' && notify) {
                            this.showNotification('Buy Executed (Telegram)', `${payload.shares} ${payload.ticker} @ $${payload.price}`, 'success');
                            fetchTrades();
                        }
                        break;

                    case 'sell_executed':
                        if (source === 'telegram' && notify) {
                            this.showNotification('Sell Executed (Telegram)', `${payload.shares} ${payload.ticker} @ $${payload.price}`, 'warning');
                            fetchTrades();
                        }
                        break;

                    case 'exit_signal':
                        if (notify) {
                            this.showNotification('Exit Signal', `${payload.ticker}: ${payload.signal_type}`, 'danger');
                        }
                        break;

                    case 'journal_added':
                        if (source === 'telegram' && notify) {
                            this.showNotification('Journal Entry (Telegram)', `${payload.entry_type}: ${(payload.content || '').slice(0, 50)}...`, 'info');
                            fetchJournal();
                        }
                        break;

                    case 'command_received':
                        if (notify) {
                            this.showNotification('Telegram Command', `/${payload.command} ${payload.args || ''}`, 'info');
                            addSyncActivityItem(`Telegram: /${payload.command} ${payload.args || ''}`, 'command');
                        }
                        break;

                    case 'scan_completed':
                        if (notify) {
                            this.showNotification('Scan Complete', `${payload.positions_scanned} positions, ${payload.signals_count} signals`, 'info');
                        }
                        break;
                }

                // Add to sync activity
                if (source === 'telegram' && notify) {
                    addSyncActivityItem(this.formatEventMessage(event), eventType.replace('_', '-'));
                }

                // Acknowledge event
                if (event.ack_required) {
                    this.send({ type: 'ack', event_id: event.id });
                }
            }

            formatEventMessage(event) {
                const p = event.payload;
                const formatters = {
                    'trade_created': () => `Added ${p.ticker} to watchlist`,
                    'buy_executed': () => `Bought ${p.shares} ${p.ticker} @ $${p.price}`,
                    'sell_executed': () => `Sold ${p.shares} ${p.ticker} @ $${p.price}`,
                    'exit_signal': () => `Exit signal for ${p.ticker}: ${p.signal_type}`,
                    'journal_added': () => `Journal: ${p.entry_type} - ${p.content?.slice(0, 30)}...`,
                    'command_received': () => `Command: /${p.command}`,
                    'scan_completed': () => `Scan: ${p.positions_scanned} positions`,
                };
                const formatter = formatters[event.event_type];
                return formatter ? formatter() : event.event_type;
            }

            send(data) {
                if (this.socket && this.connected) {
                    this.socket.emit('message', data);
                }
            }

            // Publish event to server
            publish(eventType, payload) {
                if (this.socket && this.connected) {
                    this.socket.emit('publish', {
                        event_type: eventType,
                        payload: payload
                    });
                }
            }

            // Request sync status
            requestStatus() {
                if (this.socket && this.connected) {
                    this.socket.emit('get_status');
                }
            }

            // Acknowledge event receipt
            ack(eventId) {
                if (this.socket && this.connected) {
                    this.socket.emit('ack', { event_id: eventId });
                }
            }

            updateSyncStatus(status) {
                const indicator = document.getElementById('sync-status-indicator');
                const text = document.getElementById('sync-status-text');

                if (!indicator || !text) return;

                const statusConfig = {
                    'connected': { color: 'var(--green)', text: 'SYNCED', icon: '‚óè' },
                    'disconnected': { color: 'var(--yellow)', text: 'OFFLINE', icon: '‚óã' },
                    'error': { color: 'var(--red)', text: 'ERROR', icon: '‚úï' },
                    'unavailable': { color: 'var(--text-muted)', text: 'N/A', icon: '‚óã' },
                };

                const config = statusConfig[status] || statusConfig.disconnected;
                indicator.style.color = config.color;
                indicator.textContent = config.icon;
                text.textContent = config.text;
                text.style.color = config.color;
            }

            updateSyncStatusDetails(status) {
                const el = document.getElementById('sync-details');
                if (el) {
                    el.innerHTML = `
                        <div>Clients: ${status.connected_clients || 0}</div>
                        <div>Events: ${status.total_events || 0}</div>
                    `;
                }
            }

            showNotification(title, message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `sync-notification sync-notification-${type}`;
                notification.innerHTML = `
                    <div class="sync-notification-title">${title}</div>
                    <div class="sync-notification-message">${message}</div>
                `;

                // Add to container
                let container = document.getElementById('sync-notifications');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'sync-notifications';
                    container.style.cssText = 'position: fixed; top: 70px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 8px;';
                    document.body.appendChild(container);
                }
                container.appendChild(notification);

                // Auto-remove after 5 seconds
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            }
        }

        // Global sync client
        const syncClient = new SyncClient();

        // Sync activity helper
        function addSyncActivityItem(message, type = 'sync') {
            const activityItems = window.activityItems || [];
            activityItems.unshift({
                message: `[SYNC] ${message}`,
                type: type,
                timestamp: new Date().toISOString()
            });
            window.activityItems = activityItems;
            if (typeof renderActivityFeed === 'function') {
                renderActivityFeed();
            }
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                switchTab(tabId);
            });
        });

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // Load watchlist when tab is activated
            if (tabId === 'watchlist') {
                loadWatchlist();
            }

            // Load learning dashboard when tab is activated
            if (tabId === 'learning') {
                if (typeof initLearningDashboard === 'function') {
                    initLearningDashboard();
                }
            }

            // Load intelligence dashboard when tab is activated
            if (tabId === 'intelligence') {
                if (typeof initIntelligenceDashboard === 'function') {
                    initIntelligenceDashboard();
                }
            }
        }

        // Modal
        function openModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal-overlay').classList.add('active');
        }

        function closeModal(e) {
            if (!e || e.target === document.getElementById('modal-overlay')) {
                document.getElementById('modal-overlay').classList.remove('active');
            }
        }

        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

        // Show ticker details
        async function showTicker(ticker) {
            openModal(ticker, '<div style="text-align: center; padding: 20px;">Loading...</div>');
            try {
                const res = await fetch(`${API_BASE}/ticker/${ticker}`);
                const data = await res.json();
                if (data.ok && data.stock) {
                    const s = data.stock;
                    const content = `
                        <div style="display: grid; gap: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: 700;">${s.ticker}</div>
                                    <div style="color: var(--text-muted);">${s.sector || 'N/A'}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.25rem; font-weight: 600;">Score: ${(s.story_score || 0).toFixed(1)}</div>
                                    <div style="color: var(--text-muted);">${s.story_strength || 'N/A'}</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Change</div>
                                    <div style="font-weight: 600; color: ${(s.change_pct || 0) >= 0 ? 'var(--green)' : 'var(--red)'};">${(s.change_pct || 0) >= 0 ? '+' : ''}${(s.change_pct || 0).toFixed(2)}%</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Volume</div>
                                    <div style="font-weight: 600;">${formatVolume(s.volume || 0)}</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">RS Rating</div>
                                    <div style="font-weight: 600;">${(s.rs_rating || 0).toFixed(0)}</div>
                                </div>
                            </div>
                            ${s.hottest_theme ? `<div style="padding: 8px 12px; background: var(--blue-bg); border-radius: 8px; font-size: 0.875rem;"><strong>Theme:</strong> ${s.hottest_theme}</div>` : ''}
                            ${s.catalyst ? `<div style="padding: 8px 12px; background: var(--yellow-bg); border-radius: 8px; font-size: 0.875rem;"><strong>Catalyst:</strong> ${s.catalyst}</div>` : ''}
                        </div>
                    `;
                    document.getElementById('modal-body').innerHTML = content;
                }
            } catch (e) {
                document.getElementById('modal-body').innerHTML = '<div style="color: var(--red);">Failed to load data</div>';
            }
        }

        function formatVolume(vol) {
            if (vol >= 1e9) return (vol / 1e9).toFixed(1) + 'B';
            if (vol >= 1e6) return (vol / 1e6).toFixed(1) + 'M';
            if (vol >= 1e3) return (vol / 1e3).toFixed(1) + 'K';
            return vol.toString();
        }

        // Fetch functions
        async function fetchHealth() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();
                if (data.ok) {
                    const fg = data.fear_greed || {};
                    const breadth = data.breadth || {};
                    const raw = data.raw_data || {};

                    // Market pulse - calculate from raw data
                    const spy = raw.spy_20d_return || 0;
                    const qqq = spy;  // Use SPY as proxy
                    document.getElementById('spy-change').textContent = (spy >= 0 ? '+' : '') + spy.toFixed(2) + '%';
                    document.getElementById('spy-change').className = 'pulse-value ' + (spy >= 0 ? 'up' : 'down');
                    document.getElementById('qqq-change').textContent = (qqq >= 0 ? '+' : '') + qqq.toFixed(2) + '%';
                    document.getElementById('qqq-change').className = 'pulse-value ' + (qqq >= 0 ? 'up' : 'down');
                    document.getElementById('vix-value').textContent = (raw.vix || 0).toFixed(1);

                    // Fear & Greed
                    const fgScore = fg.score || data.overall_score || 50;
                    document.getElementById('fg-value').textContent = fgScore.toFixed(0);
                    document.getElementById('fear-greed').textContent = fgScore.toFixed(0);
                    const fgLabel = fg.label || (fgScore <= 25 ? 'Extreme Fear' : fgScore <= 45 ? 'Fear' : fgScore <= 55 ? 'Neutral' : fgScore <= 75 ? 'Greed' : 'Extreme Greed');
                    document.getElementById('fg-label').textContent = fgLabel;
                    const rotation = (fgScore - 50) * 1.8; // -90 to 90 degrees
                    document.getElementById('gauge-needle').style.setProperty('--rotation', rotation + 'deg');

                    // Health metrics from breadth
                    document.getElementById('breadth-score').textContent = (breadth.breadth_score || 0).toFixed(0) + '%';
                    document.getElementById('adv-dec').textContent = (breadth.advance_decline_ratio || 0).toFixed(2);
                    document.getElementById('hi-lo').textContent = `${breadth.new_highs || 0} / ${breadth.new_lows || 0}`;
                    document.getElementById('put-call').textContent = (raw.vix_term_ratio || 0).toFixed(2);
                }
            } catch (e) { console.warn('Health fetch failed:', e); }
        }

        async function fetchScan() {
            try {
                const res = await fetch(`${API_BASE}/scan`);
                const data = await res.json();
                if (data.ok && data.stocks) {
                    renderTopPicks(data.stocks);
                    renderScanTable(data.stocks);

                    // Update stats
                    document.getElementById('stat-scanned').textContent = data.stocks.length;
                    document.getElementById('stat-hot').textContent = data.stocks.filter(s => s.story_strength === 'hot').length;
                    document.getElementById('stat-developing').textContent = data.stocks.filter(s => s.story_strength === 'developing').length;
                    document.getElementById('stat-watchlist').textContent = data.stocks.filter(s => s.story_strength === 'watchlist').length;
                }
            } catch (e) { console.warn('Scan fetch failed:', e); }
        }

        async function triggerScan(mode = 'indices') {
            const btn = event.target;
            const originalText = btn.textContent;
            const modeLabel = mode === 'full' ? 'Full Universe' : mode === 'indices' ? 'S&P+NASDAQ' : 'Quick';
            btn.textContent = `‚è≥ Scanning ${modeLabel}...`;
            btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/scan/trigger?mode=${mode}`, { method: 'POST' });
                const data = await res.json();

                if (data.ok) {
                    btn.textContent = `‚úÖ ${data.scanned} stocks!`;
                    // Refresh the scan data
                    await fetchScan();
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 2000);
                } else {
                    btn.textContent = '‚ùå ' + (data.error || 'Failed').substring(0, 20);
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 3000);
                }
            } catch (e) {
                console.warn('Trigger scan failed:', e);
                btn.textContent = '‚ùå Error';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 3000);
            }
        }

        function renderTopPicks(stocks) {
            const top = stocks.slice(0, 10);
            if (top.length === 0) {
                document.getElementById('top-picks').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div style="margin-bottom: 8px;">No scan data available</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Run /scan on Telegram or wait for scheduled scan</div>
                    </div>`;
                return;
            }

            document.getElementById('top-picks').innerHTML = top.map((s, i) => {
                const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                return `
                    <div class="top-pick" onclick="showTicker('${s.ticker}')">
                        <div class="pick-rank ${rankClass}">${i + 1}</div>
                        <div class="pick-info">
                            <div class="pick-ticker">${s.ticker}</div>
                            <div class="pick-name">${s.story_strength || 'N/A'}</div>
                        </div>
                        <div class="pick-score">
                            <div class="pick-score-value">${(s.story_score || 0).toFixed(0)}</div>
                            <div class="pick-score-label">score</div>
                        </div>
                        ${s.hottest_theme ? `<div class="pick-theme">${s.hottest_theme}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderScanTable(stocks) {
            window.scanData = stocks;
            filterTable();
        }

        function filterTable() {
            const strength = document.getElementById('filter-strength').value;
            const theme = document.getElementById('filter-theme').value;

            let filtered = window.scanData || [];
            if (strength) filtered = filtered.filter(s => s.story_strength === strength);
            if (theme) filtered = filtered.filter(s => s.hottest_theme === theme);

            document.getElementById('scan-table-body').innerHTML = filtered.map((s, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td class="ticker-cell" onclick="showTicker('${s.ticker}')">${s.ticker}</td>
                    <td>
                        <span class="score-bar"><span class="score-bar-fill" style="width: ${Math.min(s.story_score || 0, 100)}%"></span></span>
                        ${(s.story_score || 0).toFixed(0)}
                    </td>
                    <td>${s.story_strength || '-'}</td>
                    <td>${s.hottest_theme || '-'}</td>
                    <td style="color: ${(s.change_pct || 0) >= 0 ? 'var(--green)' : 'var(--red)'};">${(s.change_pct || 0) >= 0 ? '+' : ''}${(s.change_pct || 0).toFixed(2)}%</td>
                    <td>${formatVolume(s.volume || 0)}</td>
                    <td>${(s.rs_rating || 0).toFixed(0)}</td>
                    <td>
                        <button class="btn btn-ghost" style="padding: 2px 8px; font-size: 0.75rem;" onclick='addToWatchlist(${JSON.stringify(s)})'>+ Watchlist</button>
                    </td>
                </tr>
            `).join('');
        }

        async function fetchConvictionAlerts() {
            try {
                document.getElementById('conviction-alerts-container').innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">Scanning signals...</div>';
                const res = await fetch(`${API_BASE}/conviction/alerts?min_score=60`);
                const data = await res.json();

                if (data.ok && data.alerts && data.alerts.length > 0) {
                    const recEmoji = {
                        'STRONG BUY': 'üü¢üü¢',
                        'BUY': 'üü¢',
                        'WATCH': 'üü°',
                        'HOLD': '‚ö™',
                        'AVOID': 'üî¥'
                    };

                    let html = '';
                    data.alerts.slice(0, 5).forEach(a => {
                        const emoji = recEmoji[a.recommendation] || '‚ö™';
                        html += `<div class="sidebar-item" style="cursor: pointer; padding: 8px 0; border-bottom: 1px solid var(--border);" onclick="showConvictionDetail('${a.ticker}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">${a.ticker}</span>
                                <span style="font-size: 0.875rem;">${emoji} ${a.conviction_score.toFixed(0)}</span>
                            </div>
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 2px;">
                                ${a.bullish_signals} bullish ‚Ä¢ ${a.recommendation}
                            </div>
                        </div>`;
                    });
                    document.getElementById('conviction-alerts-container').innerHTML = html;
                } else {
                    document.getElementById('conviction-alerts-container').innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">No high-conviction setups. Signals need to align.</div>';
                }
            } catch (e) {
                console.warn('Conviction alerts fetch failed:', e);
                document.getElementById('conviction-alerts-container').innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">Could not load conviction data</div>';
            }
        }

        async function showConvictionDetail(ticker) {
            try {
                const res = await fetch(`${API_BASE}/conviction/${ticker}`);
                const data = await res.json();

                if (data.ok) {
                    const recEmoji = {'STRONG BUY': 'üü¢üü¢', 'BUY': 'üü¢', 'WATCH': 'üü°', 'HOLD': '‚ö™', 'AVOID': 'üî¥'};
                    let msg = `üéØ ${ticker} CONVICTION: ${data.conviction_score.toFixed(0)}/100\n`;
                    msg += `Recommendation: ${data.recommendation} ${recEmoji[data.recommendation] || ''}\n\n`;

                    msg += `Signals:\n`;
                    if (data.signals.insider) msg += `‚Ä¢ Insider: ${data.signals.insider.score.toFixed(0)} (${data.signals.insider.signal})\n`;
                    if (data.signals.options) msg += `‚Ä¢ Options: ${data.signals.options.score.toFixed(0)} (${data.signals.options.signal})\n`;
                    if (data.signals.patents) msg += `‚Ä¢ Patents: ${data.signals.patents.score.toFixed(0)} (${data.signals.patents.signal})\n`;
                    if (data.signals.contracts) msg += `‚Ä¢ Contracts: ${data.signals.contracts.score.toFixed(0)} (${data.signals.contracts.signal})\n`;
                    if (data.signals.sentiment) msg += `‚Ä¢ Sentiment: ${data.signals.sentiment.score.toFixed(0)} (${data.signals.sentiment.signal})\n`;
                    if (data.signals.technical) msg += `‚Ä¢ Technical: ${data.signals.technical.score.toFixed(0)} (${data.signals.technical.signal})\n`;

                    if (data.warnings && data.warnings.length > 0) {
                        msg += `\nWarnings: ${data.warnings.join(', ')}`;
                    }

                    alert(msg);
                }
            } catch (e) {
                console.warn('Conviction detail fetch failed:', e);
            }
        }

        // Supply Chain Discovery Functions
        async function fetchSupplyChain() {
            try {
                document.getElementById('supplychain-container').innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">ü§ñ AI analyzing market data...</div>';

                // Try AI-driven discovery first
                let data = null;
                try {
                    const aiRes = await fetch(`${API_BASE}/supplychain/ai-discover`);
                    data = await aiRes.json();
                } catch (e) {
                    console.warn('AI discovery failed, trying static:', e);
                }

                // Fallback to static themes if AI fails
                if (!data || !data.ok || !data.opportunities || data.opportunities.length === 0) {
                    const staticRes = await fetch(`${API_BASE}/supplychain/themes`);
                    data = await staticRes.json();
                    data.isStatic = true;
                }

                if (data.ok) {
                    let html = '';

                    // AI-driven opportunities
                    if (data.opportunities && data.opportunities.length > 0) {
                        const themeGroups = {};
                        for (const opp of data.opportunities) {
                            const theme = opp.theme || 'Unknown';
                            if (!themeGroups[theme]) themeGroups[theme] = [];
                            themeGroups[theme].push(opp);
                        }

                        for (const [theme, opps] of Object.entries(themeGroups).slice(0, 4)) {
                            const topOpp = opps[0];
                            const confEmoji = topOpp.confidence > 75 ? 'üî•' : topOpp.confidence > 50 ? 'üå±' : 'üëÄ';

                            html += `<div class="sidebar-item" style="cursor: pointer; padding: 8px 0; border-bottom: 1px solid var(--border);" onclick="showAIOpportunity('${encodeURIComponent(JSON.stringify(opps.slice(0, 5)))}')">
                                <div>
                                    <span style="font-weight: 600;">${confEmoji} ${theme}</span>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">${opps.length} opportunities</div>
                                    <div style="font-size: 0.7rem; color: var(--green);">Top: ${opps.slice(0, 2).map(o => o.ticker).join(', ')}</div>
                                </div>
                            </div>`;
                        }

                        html += `<div style="font-size: 0.7rem; color: var(--blue); margin-top: 8px;">ü§ñ AI-analyzed ‚Ä¢ ${data.opportunities.length} total</div>`;
                    }
                    // Static theme mapping
                    else if (data.themes && data.themes.length > 0) {
                        const stageEmoji = {'emerging': 'üå±', 'accelerating': 'üöÄ', 'mainstream': 'üåä', 'late': 'üçÇ'};

                        for (const theme of data.themes.slice(0, 5)) {
                            const emoji = stageEmoji[theme.lifecycle_stage] || '‚ö™';
                            html += `<div class="sidebar-item" style="cursor: pointer; padding: 8px 0; border-bottom: 1px solid var(--border);" onclick="showSupplyChainDetail('${theme.theme_id}')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <span style="font-weight: 600;">${emoji} ${theme.theme_name}</span>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">${theme.laggard_count} lagging plays</div>
                                    </div>
                                    <span style="color: var(--green); font-size: 0.8rem;">${theme.opportunity_score?.toFixed(0) || '--'}</span>
                                </div>
                            </div>`;
                        }

                        html += `<div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 8px;">Total: ${data.total_opportunities} opportunities</div>`;
                    } else {
                        html = '<div style="color: var(--text-muted); font-size: 0.8125rem;">No lagging plays found.</div>';
                    }

                    document.getElementById('supplychain-container').innerHTML = html;
                } else {
                    document.getElementById('supplychain-container').innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">No lagging plays found. Run a scan first.</div>';
                }
            } catch (e) {
                console.warn('Supply chain fetch failed:', e);
                document.getElementById('supplychain-container').innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">Could not load supply chain data</div>';
            }
        }

        function showAIOpportunity(encodedData) {
            try {
                const opps = JSON.parse(decodeURIComponent(encodedData));
                let msg = 'ü§ñ AI SUPPLY CHAIN OPPORTUNITIES\n\n';

                for (const opp of opps) {
                    msg += `‚Ä¢ ${opp.ticker} (${opp.role || opp.source})\n`;
                    if (opp.connection) msg += `  Connection: ${opp.connection}\n`;
                    if (opp.catalyst) msg += `  Catalyst: ${opp.catalyst}\n`;
                    if (opp.thesis) msg += `  Thesis: ${opp.thesis}\n`;
                    if (opp.opportunity_score) msg += `  Score: ${opp.opportunity_score}/100\n`;
                    msg += '\n';
                }

                alert(msg);
            } catch (e) {
                console.warn('Failed to parse AI opportunity:', e);
            }
        }

        async function showSupplyChainDetail(themeId) {
            try {
                const res = await fetch(`${API_BASE}/supplychain/${themeId}`);
                const data = await res.json();

                if (data.ok && data.theme) {
                    const theme = data.theme;
                    let msg = `üîó SUPPLY CHAIN: ${theme.theme_name}\n`;
                    msg += `Stage: ${theme.lifecycle_stage.toUpperCase()}\n`;
                    msg += `Opportunity: ${theme.opportunity_score.toFixed(0)}/100\n\n`;

                    msg += `Lagging Plays (${theme.laggard_count} stocks):\n`;

                    // Show suppliers that haven't moved
                    const allNodes = [...(theme.suppliers || []), ...(theme.equipment || []), ...(theme.materials || []), ...(theme.beneficiaries || []), ...(theme.infrastructure || [])];
                    const laggards = allNodes.filter(n => !n.has_moved).sort((a, b) => b.opportunity_score - a.opportunity_score).slice(0, 8);

                    for (const node of laggards) {
                        const perf = node.price_performance_30d >= 0 ? '+' + node.price_performance_30d.toFixed(1) : node.price_performance_30d.toFixed(1);
                        msg += `‚Ä¢ ${node.ticker} (${node.role}): Story ${node.story_score.toFixed(0)}, 30d: ${perf}%\n`;
                    }

                    msg += `\nValidation:\n`;
                    msg += `‚Ä¢ Patents: ${theme.patent_validation.toFixed(0)}/100\n`;
                    msg += `‚Ä¢ Contracts: ${theme.contract_validation.toFixed(0)}/100\n`;
                    msg += `‚Ä¢ Insider: ${theme.insider_validation.toFixed(0)}/100\n`;
                    msg += `\n${theme.estimated_runway}`;

                    alert(msg);
                }
            } catch (e) {
                console.warn('Supply chain detail fetch failed:', e);
            }
        }

        async function fetchEarnings() {
            try {
                const res = await fetch(`${API_BASE}/earnings`);
                const data = await res.json();
                if (data.ok && data.earnings) {
                    const upcoming = data.earnings.slice(0, 5);
                    if (upcoming.length === 0) {
                        document.getElementById('earnings-sidebar').innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">No upcoming earnings</div>';
                        return;
                    }
                    document.getElementById('earnings-sidebar').innerHTML = upcoming.map(e => `
                        <div class="sidebar-item" style="cursor: pointer;" onclick="showTicker('${e.ticker}')">
                            <span style="font-weight: 600;">${e.ticker}</span>
                            <span style="font-size: 0.75rem; color: ${e.days_until === 0 ? 'var(--red)' : e.days_until === 1 ? 'var(--yellow)' : 'var(--text-muted)'};">
                                ${e.days_until === 0 ? 'TODAY' : e.days_until === 1 ? 'Tomorrow' : e.days_until + 'd'}
                            </span>
                        </div>
                    `).join('');

                    // Show alert if earnings today
                    const today = data.earnings.filter(e => e.days_until === 0);
                    if (today.length > 0) {
                        document.getElementById('alerts-container').innerHTML = `
                            <div class="alert warning">
                                <span class="alert-icon">‚ö†Ô∏è</span>
                                <span><strong>${today.length} stock(s)</strong> report earnings today: ${today.map(e => e.ticker).join(', ')}</span>
                            </div>
                        `;
                    }
                }
            } catch (e) { console.warn('Earnings fetch failed:', e); }
        }

        async function fetchEvolution() {
            try {
                const statusRes = await fetch(`${API_BASE}/evolution/status`);
                const status = await statusRes.json();
                if (status.ok) {
                    document.getElementById('evo-cycles').textContent = status.learning_cycles || 0;
                    document.getElementById('evo-accuracy').textContent = ((status.overall_accuracy || 0) * 100).toFixed(1) + '%';
                    document.getElementById('evo-calibration').textContent = ((status.calibration_score || 0) * 100).toFixed(1) + '%';
                    document.getElementById('evo-last').textContent = status.last_evolution || 'Never';
                }

                const weightsRes = await fetch(`${API_BASE}/evolution/weights`);
                const weights = await weightsRes.json();
                if (weights.ok && weights.weights) {
                    const w = weights.weights;
                    document.getElementById('weights-container').innerHTML = Object.entries(w).slice(0, 6).map(([k, v]) => `
                        <div class="sidebar-item">
                            <span class="sidebar-label">${k.replace(/_/g, ' ')}</span>
                            <span class="sidebar-value">${(v * 100).toFixed(0)}%</span>
                        </div>
                    `).join('');
                }
            } catch (e) { console.warn('Evolution fetch failed:', e); }
        }

        async function fetchParameters() {
            try {
                const res = await fetch(`${API_BASE}/parameters/status`);
                const data = await res.json();
                if (data.ok) {
                    const p = data.parameters || {};
                    document.getElementById('param-total').textContent = p.total || 0;
                    document.getElementById('param-learned').textContent = p.learned || 0;
                    document.getElementById('param-progress').textContent = ((p.learning_progress || 0) * 100).toFixed(0) + '%';
                    document.getElementById('param-confidence').textContent = ((p.avg_confidence || 0) * 100).toFixed(0) + '%';
                }
            } catch (e) { console.warn('Parameters fetch failed:', e); }
        }

        async function fetchCorrelations() {
            try {
                const res = await fetch(`${API_BASE}/evolution/correlations`);
                const data = await res.json();
                if (data.ok && data.correlations) {
                    const corrs = Object.entries(data.correlations).slice(0, 5);
                    if (corrs.length === 0) {
                        document.getElementById('correlations-container').innerHTML = '<div style="color: var(--text-muted); font-size: 0.8125rem;">No correlations discovered yet</div>';
                        return;
                    }
                    document.getElementById('correlations-container').innerHTML = corrs.map(([pair, value]) => `
                        <div class="sidebar-item">
                            <span class="sidebar-label">${pair}</span>
                            <span class="sidebar-value" style="color: ${value >= 0.5 ? 'var(--green)' : value <= -0.5 ? 'var(--red)' : 'var(--text)'};">${(value * 100).toFixed(0)}%</span>
                        </div>
                    `).join('');
                }
            } catch (e) { console.warn('Correlations fetch failed:', e); }
        }

        async function fetchThemes() {
            try {
                const res = await fetch(`${API_BASE}/themes/list`);
                const data = await res.json();
                if (data.ok && data.themes) {
                    window.themesData = data.themes;
                }
            } catch (e) { console.warn('Themes fetch failed:', e); }
        }

        function selectTheme(themeName) {
            // Highlight selected pill
            document.querySelectorAll('.theme-pill').forEach(pill => {
                pill.classList.toggle('active', pill.textContent.includes(themeName));
            });

            // Show theme stocks
            const themes = window.themesData || {};
            const theme = themes[themeName];
            if (theme && theme.tickers) {
                document.getElementById('theme-stocks-grid').innerHTML = theme.tickers.slice(0, 12).map(ticker => `
                    <div class="theme-stock" onclick="showTicker('${ticker}')">
                        <div class="theme-stock-ticker">${ticker}</div>
                    </div>
                `).join('');
            }
        }

        async function fetchBriefing() {
            document.getElementById('briefing-container').innerHTML = '<div style="color: var(--text-muted);">Generating AI briefing...</div>';
            try {
                const res = await fetch(`${API_BASE}/briefing`);
                const data = await res.json();
                if (data.ok && data.briefing) {
                    document.getElementById('briefing-container').innerHTML = `
                        <div style="white-space: pre-wrap; line-height: 1.7; font-size: 0.875rem;">${data.briefing}</div>
                    `;
                }
            } catch (e) {
                document.getElementById('briefing-container').innerHTML = '<div style="color: var(--red);">Failed to generate briefing</div>';
            }
        }

        // SEC EDGAR Functions
        async function fetchMARadar() {
            try {
                const res = await fetch(`${API_BASE}/sec/ma-radar`);
                const data = await res.json();

                if (data.ok && data.radar) {
                    let html = '';
                    if (data.radar.length === 0) {
                        html = '<div style="color: var(--text-muted);">No M&A activity detected</div>';
                    } else {
                        data.radar.slice(0, 8).forEach(item => {
                            const color = item.score >= 50 ? 'var(--red)' : item.score >= 25 ? 'var(--yellow)' : 'var(--green)';
                            const level = item.score >= 50 ? 'HIGH' : item.score >= 25 ? 'MED' : 'LOW';
                            html += `<div class="sidebar-item" style="cursor: pointer;" onclick="lookupMACheckFor('${item.ticker}')">
                                <span class="sidebar-label">${item.ticker}</span>
                                <span class="sidebar-value" style="color: ${color};">${level} ${item.score}%</span>
                            </div>`;
                        });
                    }
                    document.getElementById('ma-radar-container').innerHTML = html;
                }
            } catch (e) { console.warn('M&A radar fetch failed:', e); }
        }

        async function fetchDeals() {
            try {
                const res = await fetch(`${API_BASE}/sec/deals`);
                const data = await res.json();

                if (data.ok) {
                    // Update deals container
                    let html = '';
                    if (!data.deals || data.deals.length === 0) {
                        html = '<div style="color: var(--text-muted);">No deals tracked</div>';
                        document.getElementById('deals-container').innerHTML = html;
                        document.getElementById('deals-table-body').innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">No deals tracked. Click + Add Deal to start.</td></tr>';
                        return;
                    }

                    // Summary in sidebar
                    data.deals.forEach(deal => {
                        const spreadColor = deal.spread_pct > 5 ? 'var(--green)' : deal.spread_pct > 2 ? 'var(--yellow)' : 'var(--text-muted)';
                        html += `<div class="sidebar-item">
                            <span class="sidebar-label">${deal.target} ‚Üê ${deal.acquirer}</span>
                            <span class="sidebar-value" style="color: ${spreadColor};">+${deal.spread_pct.toFixed(1)}%</span>
                        </div>`;
                    });
                    document.getElementById('deals-container').innerHTML = html;

                    // Table
                    let tableHtml = '';
                    data.deals.forEach(deal => {
                        const statusEmoji = deal.status === 'approved' ? 'üü¢' : deal.status === 'pending' ? 'üü°' : '‚ö™';
                        const spreadColor = deal.spread_pct > 5 ? 'var(--green)' : deal.spread_pct > 2 ? 'var(--yellow)' : 'var(--text-muted)';
                        tableHtml += `<tr>
                            <td><strong>${deal.target}</strong></td>
                            <td>${deal.acquirer}</td>
                            <td>$${deal.deal_price.toFixed(2)}</td>
                            <td>$${deal.current_price.toFixed(2)}</td>
                            <td style="color: ${spreadColor};">+${deal.spread_pct.toFixed(1)}%</td>
                            <td>${statusEmoji} ${deal.status}</td>
                        </tr>`;
                    });
                    document.getElementById('deals-table-body').innerHTML = tableHtml;
                }
            } catch (e) { console.warn('Deals fetch failed:', e); }
        }

        async function lookupSECFilings() {
            const ticker = document.getElementById('sec-ticker-input').value.trim().toUpperCase();
            if (!ticker) { alert('Enter a ticker'); return; }

            document.getElementById('sec-lookup-result').innerHTML = '<div style="color: var(--text-muted);">Loading...</div>';

            try {
                const res = await fetch(`${API_BASE}/sec/filings/${ticker}`);
                const data = await res.json();

                if (data.ok && data.filings) {
                    let html = `<div style="margin-bottom: 8px; font-weight: 600;">${ticker} - ${data.count} filings</div>`;
                    data.filings.slice(0, 10).forEach(f => {
                        const emoji = f.form_type.includes('8-K') ? '‚ö°' : f.form_type.includes('DEFM') ? 'üîî' : f.form_type === '4' ? 'üë§' : 'üìÑ';
                        html += `<div style="margin-bottom: 6px;">
                            ${emoji} <strong>${f.form_type}</strong> - ${f.filed_date}
                            <a href="${f.url}" target="_blank" style="color: var(--blue); margin-left: 8px;">View</a>
                        </div>`;
                    });
                    document.getElementById('filings-feed').innerHTML = html;
                    document.getElementById('sec-lookup-result').innerHTML = `<div style="color: var(--green);">Found ${data.count} filings</div>`;
                } else {
                    document.getElementById('sec-lookup-result').innerHTML = '<div style="color: var(--red);">No filings found</div>';
                }
            } catch (e) {
                document.getElementById('sec-lookup-result').innerHTML = '<div style="color: var(--red);">Error fetching filings</div>';
            }
        }

        async function lookupMACheck() {
            const ticker = document.getElementById('sec-ticker-input').value.trim().toUpperCase();
            if (!ticker) { alert('Enter a ticker'); return; }
            lookupMACheckFor(ticker);
        }

        async function lookupMACheckFor(ticker) {
            document.getElementById('sec-lookup-result').innerHTML = '<div style="color: var(--text-muted);">Analyzing M&A activity...</div>';

            try {
                const res = await fetch(`${API_BASE}/sec/ma-check/${ticker}`);
                const data = await res.json();

                if (data.ok) {
                    const color = data.ma_score >= 50 ? 'var(--red)' : data.ma_score >= 25 ? 'var(--yellow)' : 'var(--green)';
                    const level = data.ma_score >= 50 ? 'HIGH' : data.ma_score >= 25 ? 'MEDIUM' : 'LOW';
                    let html = `<div style="margin-bottom: 8px;">
                        <strong>${ticker}</strong> M&A Probability: <span style="color: ${color}; font-weight: 600;">${level} (${data.ma_score}/100)</span>
                    </div>`;
                    if (data.signals && data.signals.length > 0) {
                        html += '<div style="margin-top: 8px;">';
                        data.signals.forEach(s => {
                            html += `<div style="margin-bottom: 4px;">‚Ä¢ ${s}</div>`;
                        });
                        html += '</div>';
                    } else {
                        html += '<div style="color: var(--text-muted);">No M&A signals detected</div>';
                    }
                    document.getElementById('sec-lookup-result').innerHTML = html;
                }
            } catch (e) {
                document.getElementById('sec-lookup-result').innerHTML = '<div style="color: var(--red);">Error checking M&A</div>';
            }
        }

        async function lookupInsider() {
            const ticker = document.getElementById('sec-ticker-input').value.trim().toUpperCase();
            if (!ticker) { alert('Enter a ticker'); return; }

            document.getElementById('sec-lookup-result').innerHTML = '<div style="color: var(--text-muted);">Loading insider data...</div>';

            try {
                const res = await fetch(`${API_BASE}/sec/insider/${ticker}`);
                const data = await res.json();

                if (data.ok) {
                    let html = `<div style="margin-bottom: 8px;"><strong>${ticker}</strong> - ${data.count} Form 4 filings (90 days)</div>`;
                    if (data.transactions && data.transactions.length > 0) {
                        data.transactions.slice(0, 5).forEach(t => {
                            html += `<div style="margin-bottom: 4px;">üë§ ${t.date} - <a href="${t.url}" target="_blank" style="color: var(--blue);">View</a></div>`;
                        });
                    } else {
                        html += '<div style="color: var(--text-muted);">No recent insider transactions</div>';
                    }
                    document.getElementById('sec-lookup-result').innerHTML = html;
                }
            } catch (e) {
                document.getElementById('sec-lookup-result').innerHTML = '<div style="color: var(--red);">Error fetching insider data</div>';
            }
        }

        function showAddDealModal() {
            const target = prompt('Target ticker (e.g., VMW):');
            if (!target) return;
            const acquirer = prompt('Acquirer ticker (e.g., AVGO):');
            if (!acquirer) return;
            const price = prompt('Deal price (e.g., 142.50):');
            if (!price) return;

            addDeal(target, acquirer, parseFloat(price));
        }

        async function addDeal(target, acquirer, dealPrice) {
            try {
                const res = await fetch(`${API_BASE}/sec/deals/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target, acquirer, deal_price: dealPrice })
                });
                const data = await res.json();

                if (data.ok) {
                    alert(data.message);
                    fetchDeals();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Failed to add deal');
            }
        }

        // Government Contracts Functions
        async function fetchContractThemes() {
            try {
                document.getElementById('contract-themes-container').innerHTML = '<div style="color: var(--text-muted);">Loading...</div>';
                const res = await fetch(`${API_BASE}/contracts/themes`);
                const data = await res.json();

                if (data.ok && data.themes) {
                    let html = '';
                    const sortedThemes = Object.entries(data.themes)
                        .filter(([_, info]) => info.total_value > 0)
                        .sort((a, b) => b[1].total_value - a[1].total_value)
                        .slice(0, 8);

                    sortedThemes.forEach(([theme, info]) => {
                        const trendEmoji = info.trend === 'increasing' ? 'üìà' : info.trend === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';
                        const trendColor = info.trend === 'increasing' ? 'var(--green)' : info.trend === 'decreasing' ? 'var(--red)' : 'var(--text-muted)';
                        const valueB = (info.total_value / 1e9).toFixed(1);

                        html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <div>
                                <div style="font-weight: 500;">${theme.replace(/_/g, ' ').toUpperCase()}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${info.contract_count || 0} contracts</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600;">$${valueB}B</div>
                                <div style="font-size: 0.75rem; color: ${trendColor};">${trendEmoji} ${info.mom_change > 0 ? '+' : ''}${(info.mom_change || 0).toFixed(0)}% MoM</div>
                            </div>
                        </div>`;
                    });

                    document.getElementById('contract-themes-container').innerHTML = html || '<div style="color: var(--text-muted);">No contract data</div>';
                } else {
                    document.getElementById('contract-themes-container').innerHTML = '<div style="color: var(--text-muted);">Contracts API not configured</div>';
                }
            } catch (e) {
                console.warn('Contract themes fetch failed:', e);
                document.getElementById('contract-themes-container').innerHTML = '<div style="color: var(--text-muted);">Could not load contract data</div>';
            }
        }

        async function fetchRecentContracts() {
            try {
                document.getElementById('recent-contracts-container').innerHTML = '<div style="color: var(--text-muted);">Loading...</div>';
                const res = await fetch(`${API_BASE}/contracts/recent`);
                const data = await res.json();

                if (data.ok && data.contracts) {
                    let html = '';
                    data.contracts.slice(0, 6).forEach(c => {
                        const valueM = (c.amount / 1e6).toFixed(1);
                        html += `<div style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <div style="font-weight: 500; font-size: 0.8125rem;">${c.recipient || 'Unknown'}</div>
                            <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                                <span style="font-size: 0.75rem; color: var(--text-muted);">${c.agency || 'Federal'}</span>
                                <span style="font-weight: 600; color: var(--green);">$${valueM}M</span>
                            </div>
                        </div>`;
                    });
                    document.getElementById('recent-contracts-container').innerHTML = html || '<div style="color: var(--text-muted);">No recent contracts</div>';
                } else {
                    document.getElementById('recent-contracts-container').innerHTML = '<div style="color: var(--text-muted);">No data</div>';
                }
            } catch (e) {
                console.warn('Recent contracts fetch failed:', e);
                document.getElementById('recent-contracts-container').innerHTML = '<div style="color: var(--text-muted);">Could not load contracts</div>';
            }
        }

        async function lookupCompanyContracts() {
            const ticker = document.getElementById('contract-ticker-input').value.trim().toUpperCase();
            if (!ticker) { alert('Enter a ticker'); return; }

            document.getElementById('contract-lookup-result').innerHTML = '<div style="color: var(--text-muted);">Searching contracts...</div>';

            try {
                const res = await fetch(`${API_BASE}/contracts/company/${ticker}`);
                const data = await res.json();

                if (data.ok && data.activity) {
                    const a = data.activity;
                    const valueB = (a.total_value / 1e9).toFixed(2);
                    const signalPct = Math.round((a.signal_strength || 0) * 100);

                    let html = `
                        <div style="background: var(--bg-hover); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                            <div style="font-size: 1.25rem; font-weight: 700; color: var(--green);">$${valueB}B</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Total Contract Value</div>
                            <div style="margin-top: 8px; font-size: 0.875rem;">${a.contract_count || 0} contracts ‚Ä¢ Signal: ${signalPct}%</div>
                        </div>`;

                    if (a.top_agencies && a.top_agencies.length > 0) {
                        html += '<div style="margin-bottom: 8px;"><strong>Top Agencies:</strong></div>';
                        a.top_agencies.slice(0, 3).forEach(agency => {
                            html += `<div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">‚Ä¢ ${agency}</div>`;
                        });
                    }

                    document.getElementById('contract-lookup-result').innerHTML = html;
                } else {
                    document.getElementById('contract-lookup-result').innerHTML = `<div style="color: var(--text-muted);">No contract data for ${ticker}</div>`;
                }
            } catch (e) {
                document.getElementById('contract-lookup-result').innerHTML = '<div style="color: var(--red);">Error fetching contracts</div>';
            }
        }

        // Patent Intelligence Functions
        async function fetchPatentThemes() {
            try {
                document.getElementById('patent-themes-container').innerHTML = '<div style="color: var(--text-muted);">Loading...</div>';
                const res = await fetch(`${API_BASE}/patents/themes`);
                const data = await res.json();

                if (data.ok && data.themes) {
                    let html = '';
                    const sortedThemes = Object.entries(data.themes)
                        .sort((a, b) => b[1].patent_count - a[1].patent_count)
                        .slice(0, 8);

                    sortedThemes.forEach(([theme, info]) => {
                        const trendEmoji = info.trend === 'increasing' ? 'üìà' : info.trend === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';
                        const trendColor = info.trend === 'increasing' ? 'var(--green)' : info.trend === 'decreasing' ? 'var(--red)' : 'var(--text-muted)';
                        const signalPct = Math.round((info.signal_strength || 0) * 100);

                        html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <div>
                                <div style="font-weight: 500;">${theme.replace(/_/g, ' ').toUpperCase()}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${info.patent_count} patents</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: ${trendColor};">${trendEmoji} ${info.yoy_change > 0 ? '+' : ''}${(info.yoy_change || 0).toFixed(0)}% YoY</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Signal: ${signalPct}%</div>
                            </div>
                        </div>`;
                    });

                    document.getElementById('patent-themes-container').innerHTML = html || '<div style="color: var(--text-muted);">No patent data</div>';
                } else {
                    document.getElementById('patent-themes-container').innerHTML = '<div style="color: var(--text-muted);">Patent API not configured</div>';
                }
            } catch (e) {
                console.warn('Patent themes fetch failed:', e);
                document.getElementById('patent-themes-container').innerHTML = '<div style="color: var(--text-muted);">Could not load patent data</div>';
            }
        }

        async function lookupCompanyPatents() {
            const ticker = document.getElementById('patent-ticker-input').value.trim().toUpperCase();
            if (!ticker) { alert('Enter a ticker'); return; }

            document.getElementById('patent-lookup-result').innerHTML = '<div style="color: var(--text-muted);">Searching patents...</div>';

            try {
                const res = await fetch(`${API_BASE}/patents/company/${ticker}`);
                const data = await res.json();

                if (data.ok && data.activity) {
                    const a = data.activity;
                    const trendEmoji = a.trend === 'increasing' ? 'üìà' : a.trend === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';
                    const trendColor = a.trend === 'increasing' ? 'var(--green)' : a.trend === 'decreasing' ? 'var(--red)' : 'var(--text-muted)';

                    let html = `
                        <div style="background: var(--bg-hover); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text);">${a.patent_count}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Patents (3 years)</div>
                            <div style="margin-top: 8px; color: ${trendColor};">${trendEmoji} ${a.yoy_change > 0 ? '+' : ''}${(a.yoy_change || 0).toFixed(0)}% YoY</div>
                        </div>`;

                    if (a.top_keywords && a.top_keywords.length > 0) {
                        html += '<div style="margin-bottom: 8px;"><strong>Top Keywords:</strong></div>';
                        html += '<div style="display: flex; flex-wrap: wrap; gap: 4px;">';
                        a.top_keywords.slice(0, 6).forEach(kw => {
                            html += `<span style="background: var(--bg); padding: 2px 8px; border-radius: 4px; font-size: 0.7rem;">${kw}</span>`;
                        });
                        html += '</div>';
                    }

                    if (a.recent_patents && a.recent_patents.length > 0) {
                        html += '<div style="margin-top: 12px;"><strong>Recent Patents:</strong></div>';
                        a.recent_patents.slice(0, 3).forEach(p => {
                            html += `<div style="margin-top: 6px; font-size: 0.75rem; color: var(--text-muted);">‚Ä¢ ${p.title || p.patent_id}</div>`;
                        });
                    }

                    document.getElementById('patent-lookup-result').innerHTML = html;
                } else {
                    document.getElementById('patent-lookup-result').innerHTML = `<div style="color: var(--text-muted);">No patent data for ${ticker}</div>`;
                }
            } catch (e) {
                document.getElementById('patent-lookup-result').innerHTML = '<div style="color: var(--red);">Error fetching patents</div>';
            }
        }

        // Theme Intelligence Hub Functions
        async function fetchThemeRadar() {
            try {
                const res = await fetch(`${API_BASE}/theme-intel/radar`);
                const data = await res.json();

                if (data.ok && data.radar) {
                    const lifecycleEmoji = {
                        'emerging': 'üå±',
                        'accelerating': 'üöÄ',
                        'peak': 'üî•',
                        'declining': 'üìâ',
                        'dead': 'üíÄ'
                    };
                    const lifecycleColor = {
                        'emerging': 'var(--blue)',
                        'accelerating': 'var(--green)',
                        'peak': 'var(--yellow)',
                        'declining': 'var(--red)',
                        'dead': 'var(--text-muted)'
                    };

                    let html = '';
                    data.radar.forEach(theme => {
                        const emoji = lifecycleEmoji[theme.lifecycle] || '‚ö™';
                        const color = lifecycleColor[theme.lifecycle] || 'var(--text-muted)';
                        const trendArrow = theme.trend > 0 ? '‚Üë' : theme.trend < 0 ? '‚Üì' : '‚Üí';
                        const trendColor = theme.trend > 0 ? 'var(--green)' : theme.trend < 0 ? 'var(--red)' : 'var(--text-muted)';

                        html += `<div style="background: var(--bg-hover); border-radius: 8px; padding: 12px; border-left: 3px solid ${color};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <span style="font-weight: 600;">${emoji} ${theme.theme_name}</span>
                                <span style="color: ${trendColor};">${trendArrow}</span>
                            </div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: ${color};">${theme.score.toFixed(0)}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">${theme.lifecycle.toUpperCase()}</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">${theme.tickers.slice(0, 4).join(', ')}</div>
                        </div>`;
                    });

                    document.getElementById('theme-radar-grid').innerHTML = html || '<div style="color: var(--text-muted);">No theme data available</div>';

                    // Update lifecycle counts if summary available
                    const lifecycleCounts = { emerging: 0, accelerating: 0, peak: 0, declining: 0, dead: 0 };
                    data.radar.forEach(t => {
                        if (lifecycleCounts[t.lifecycle] !== undefined) {
                            lifecycleCounts[t.lifecycle]++;
                        }
                    });
                    document.getElementById('emerging-count').textContent = lifecycleCounts.emerging;
                    document.getElementById('accelerating-count').textContent = lifecycleCounts.accelerating;
                    document.getElementById('peak-count').textContent = lifecycleCounts.peak;
                    document.getElementById('declining-count').textContent = lifecycleCounts.declining;
                    document.getElementById('dead-count').textContent = lifecycleCounts.dead;

                    // Update table
                    let tableHtml = '';
                    data.radar.forEach(theme => {
                        const emoji = lifecycleEmoji[theme.lifecycle] || '‚ö™';
                        const color = lifecycleColor[theme.lifecycle] || 'var(--text-muted)';
                        const trendStr = theme.trend > 0 ? `+${theme.trend.toFixed(1)}` : theme.trend.toFixed(1);
                        const trendColor = theme.trend > 0 ? 'var(--green)' : theme.trend < 0 ? 'var(--red)' : 'var(--text-muted)';

                        tableHtml += `<tr>
                            <td><strong>${theme.theme_name}</strong></td>
                            <td>${emoji} <span style="color: ${color};">${theme.lifecycle}</span></td>
                            <td>${theme.score.toFixed(0)}</td>
                            <td style="color: ${trendColor};">${trendStr}</td>
                            <td style="font-size: 0.75rem;">${theme.tickers.slice(0, 5).join(', ')}</td>
                        </tr>`;
                    });
                    document.getElementById('themes-detail-body').innerHTML = tableHtml || '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No data</td></tr>';
                }
            } catch (e) {
                console.warn('Theme radar fetch failed:', e);
                document.getElementById('theme-radar-grid').innerHTML = '<div style="color: var(--red);">Failed to load theme radar</div>';
            }
        }

        async function fetchThemeAlerts() {
            try {
                const res = await fetch(`${API_BASE}/theme-intel/alerts`);
                const data = await res.json();

                if (data.ok) {
                    let html = '';
                    if (!data.alerts || data.alerts.length === 0) {
                        html = '<div style="color: var(--text-muted);">No alerts in last 24h</div>';
                    } else {
                        data.alerts.slice(0, 10).forEach(alert => {
                            const typeEmoji = {
                                'breakout': 'üí•',
                                'acceleration': 'üöÄ',
                                'rotation_in': 'üìà',
                                'rotation_out': 'üìâ'
                            }[alert.alert_type] || '‚ö™';
                            const severityColor = {
                                'high': 'var(--red)',
                                'medium': 'var(--yellow)',
                                'low': 'var(--green)'
                            }[alert.severity] || 'var(--text-muted)';

                            html += `<div style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>${typeEmoji} <strong>${alert.theme_name}</strong></span>
                                    <span style="font-size: 0.75rem; padding: 2px 6px; background: ${severityColor}20; color: ${severityColor}; border-radius: 4px;">${alert.severity.toUpperCase()}</span>
                                </div>
                                <div style="font-size: 0.8125rem; color: var(--text-muted); margin-top: 4px;">${alert.message}</div>
                            </div>`;
                        });
                    }
                    document.getElementById('theme-alerts-container').innerHTML = html;
                }
            } catch (e) {
                console.warn('Theme alerts fetch failed:', e);
            }
        }

        async function runThemeAnalysis() {
            document.getElementById('theme-radar-grid').innerHTML = '<div style="color: var(--text-muted);">Running full analysis... This may take 1-2 minutes.</div>';

            try {
                const res = await fetch(`${API_BASE}/theme-intel/run-analysis`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quick: true })
                });
                const data = await res.json();

                if (data.ok) {
                    alert(`Analysis complete! Found ${data.alerts_count} alerts.`);
                    fetchThemeRadar();
                    fetchThemeAlerts();
                } else {
                    alert('Analysis failed: ' + data.error);
                }
            } catch (e) {
                alert('Failed to run analysis');
            }
        }

        async function lookupTickerTheme() {
            const ticker = document.getElementById('ticker-theme-input').value.trim().toUpperCase();
            if (!ticker) { alert('Enter a ticker'); return; }

            document.getElementById('ticker-theme-result').innerHTML = '<div style="color: var(--text-muted);">Loading...</div>';

            try {
                const res = await fetch(`${API_BASE}/theme-intel/ticker/${ticker}`);
                const data = await res.json();

                if (data.ok) {
                    const boostColor = data.boost > 0 ? 'var(--green)' : data.boost < 0 ? 'var(--red)' : 'var(--text-muted)';
                    const boostSign = data.boost > 0 ? '+' : '';

                    let html = `<div style="margin-bottom: 12px;">
                        <strong>${ticker}</strong> Theme Boost: <span style="color: ${boostColor}; font-weight: 700; font-size: 1.25rem;">${boostSign}${data.boost} pts</span>
                    </div>`;

                    if (data.themes && data.themes.length > 0) {
                        html += '<div style="margin-top: 12px;">';
                        data.themes.forEach(theme => {
                            const lifecycleEmoji = {
                                'emerging': 'üå±',
                                'accelerating': 'üöÄ',
                                'peak': 'üî•',
                                'declining': 'üìâ',
                                'dead': 'üíÄ'
                            }[theme.lifecycle] || '‚ö™';
                            const themeBoostColor = theme.boost > 0 ? 'var(--green)' : theme.boost < 0 ? 'var(--red)' : 'var(--text-muted)';

                            html += `<div style="padding: 8px; background: var(--bg-hover); border-radius: 6px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>${lifecycleEmoji} ${theme.theme_name}</span>
                                    <span style="color: ${themeBoostColor};">${theme.boost > 0 ? '+' : ''}${theme.boost}</span>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Score: ${theme.score.toFixed(0)} | ${theme.lifecycle}</div>
                            </div>`;
                        });
                        html += '</div>';
                    } else {
                        html += `<div style="color: var(--text-muted);">${data.reason}</div>`;
                    }

                    document.getElementById('ticker-theme-result').innerHTML = html;
                } else {
                    document.getElementById('ticker-theme-result').innerHTML = `<div style="color: var(--red);">Error: ${data.error}</div>`;
                }
            } catch (e) {
                document.getElementById('ticker-theme-result').innerHTML = '<div style="color: var(--red);">Failed to lookup ticker</div>';
            }
        }

        // =============================================================================
        // TRADE MANAGEMENT FUNCTIONS
        // =============================================================================

        // Store positions globally for filtering
        let allPositions = [];
        let allWatchlist = [];
        let journalEntries = [];

        async function fetchTrades() {
            try {
                // Fetch positions
                const posRes = await fetch(`${API_BASE}/trades/positions`);
                const posData = await posRes.json();

                if (posData.ok) {
                    allPositions = posData.positions || [];
                    document.getElementById('trade-positions-count').textContent = posData.count || 0;
                    renderPositionCards(allPositions);
                    updatePortfolioSummary(allPositions);
                    renderThemeConcentration(allPositions);
                    updatePerformanceMetrics(allPositions);
                }

                // Fetch watchlist
                const watchRes = await fetch(`${API_BASE}/trades/watchlist`);
                const watchData = await watchRes.json();

                if (watchData.ok) {
                    allWatchlist = watchData.watchlist || [];
                    document.getElementById('trade-watchlist-count').textContent = watchData.count || 0;
                    renderWatchlistCards(allWatchlist);
                }

                // Fetch risk
                const riskRes = await fetch(`${API_BASE}/trades/risk`);
                const riskData = await riskRes.json();

                if (riskData.ok) {
                    const riskColors = {
                        'critical': 'var(--red)',
                        'high': 'var(--red)',
                        'elevated': 'var(--yellow)',
                        'moderate': 'var(--green)',
                        'low': 'var(--text-muted)',
                        'none': 'var(--green)'
                    };
                    const riskLevel = riskData.overall_risk || 'none';
                    document.getElementById('trade-risk-level').textContent = riskLevel.toUpperCase();
                    document.getElementById('trade-risk-level').style.color = riskColors[riskLevel] || 'var(--text)';
                    document.getElementById('trade-high-risk').textContent = riskData.high_risk_count || 0;

                    // Show risk alerts
                    renderTradeAlerts(riskData.high_risk_trades || []);
                }

                // Fetch journal
                fetchJournal();

                // Fetch activity
                fetchActivityFeed();

            } catch (e) {
                console.warn('Trades fetch failed:', e);
            }
        }

        function renderPositionCards(positions) {
            const container = document.getElementById('position-cards-container');
            if (!positions || positions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 40px;">No open positions. Click "+ Add Trade" to start tracking.</div>';
                return;
            }

            const riskColors = {
                'critical': '#ef4444',
                'high': '#f97316',
                'elevated': '#eab308',
                'moderate': '#22c55e',
                'low': '#6b7280',
                'none': '#10b981'
            };

            container.innerHTML = positions.map(pos => {
                const pnlPct = pos.pnl_pct || 0;
                const pnlValue = pos.pnl_value || 0;
                const pnlColor = pnlPct >= 0 ? 'var(--green)' : 'var(--red)';
                const riskLevel = pos.current_risk_level || 'none';
                const riskColor = riskColors[riskLevel] || riskColors.none;
                const storyScore = pos.story_score || 0;
                const exitConf = pos.composite_exit_confidence || 0;
                const daysHeld = pos.days_held || 0;
                const theme = pos.theme || 'No Theme';

                // Calculate profit target progress (assuming 20% target for visual)
                const profitTarget = 20;
                const progressPct = Math.min(100, Math.max(0, (pnlPct / profitTarget) * 100));
                const progressColor = pnlPct >= profitTarget ? 'var(--green)' : pnlPct >= 0 ? 'var(--blue)' : 'var(--red)';

                return `<div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 4px solid ${riskColor};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div style="cursor: pointer;" onclick="showTradeDetail('${pos.id}')">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.25rem; font-weight: 700;">${pos.ticker}</span>
                                <span style="font-size: 0.7rem; padding: 2px 6px; background: ${riskColor}20; color: ${riskColor}; border-radius: 4px;">${riskLevel.toUpperCase()}</span>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${theme} ‚Ä¢ ${daysHeld}d held</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${pnlColor};">${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(1)}%</div>
                            <div style="font-size: 0.8rem; color: ${pnlColor};">$${pnlValue >= 0 ? '+' : ''}${pnlValue.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        </div>
                    </div>

                    <!-- Story Score Bar -->
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">
                            <span>Story Score</span>
                            <span>${storyScore.toFixed(0)}/100</span>
                        </div>
                        <div style="height: 4px; background: var(--bg-hover); border-radius: 2px; overflow: hidden;">
                            <div style="height: 100%; width: ${storyScore}%; background: linear-gradient(90deg, var(--blue), var(--purple));"></div>
                        </div>
                    </div>

                    <!-- Profit Target Progress -->
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">
                            <span>Profit Target</span>
                            <span>${pnlPct.toFixed(1)}% / ${profitTarget}%</span>
                        </div>
                        <div style="height: 4px; background: var(--bg-hover); border-radius: 2px; overflow: hidden;">
                            <div style="height: 100%; width: ${progressPct}%; background: ${progressColor}; transition: width 0.3s;"></div>
                        </div>
                    </div>

                    <!-- Position Details -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; font-size: 0.75rem;">
                        <div style="background: var(--bg-hover); padding: 8px; border-radius: 6px; text-align: center;">
                            <div style="color: var(--text-muted);">Shares</div>
                            <div style="font-weight: 600;">${pos.total_shares}</div>
                        </div>
                        <div style="background: var(--bg-hover); padding: 8px; border-radius: 6px; text-align: center;">
                            <div style="color: var(--text-muted);">Avg Cost</div>
                            <div style="font-weight: 600;">$${(pos.average_cost || 0).toFixed(2)}</div>
                        </div>
                        <div style="background: var(--bg-hover); padding: 8px; border-radius: 6px; text-align: center;">
                            <div style="color: var(--text-muted);">Current</div>
                            <div style="font-weight: 600;">$${(pos.current_price || 0).toFixed(2)}</div>
                        </div>
                        <div style="background: var(--bg-hover); padding: 8px; border-radius: 6px; text-align: center;">
                            <div style="color: var(--text-muted);">Exit Conf</div>
                            <div style="font-weight: 600; color: ${exitConf > 60 ? 'var(--yellow)' : 'var(--text)'};">${exitConf.toFixed(0)}%</div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" style="flex: 1; padding: 8px; font-size: 0.75rem;" onclick="showBuyModalFor('${pos.id}', '${pos.ticker}')">üìà Scale In</button>
                        <button class="btn btn-ghost" style="flex: 1; padding: 8px; font-size: 0.75rem;" onclick="showSellModalFor('${pos.id}', '${pos.ticker}', ${pos.total_shares})">üìâ Scale Out</button>
                        <button class="btn btn-ghost" style="padding: 8px; font-size: 0.75rem;" onclick="scanSinglePosition('${pos.id}')">üîç</button>
                    </div>
                </div>`;
            }).join('');
        }

        async function scanSinglePosition(tradeId) {
            try {
                const res = await fetch(`${API_BASE}/trades/scan`);
                const data = await res.json();
                if (data.ok) {
                    const position = (data.positions || []).find(p => p.id === tradeId);
                    if (position) {
                        let msg = `Scan Results for ${position.ticker}:\n\n`;
                        if (position.exit_signals && position.exit_signals.length > 0) {
                            msg += 'Exit Signals:\n';
                            position.exit_signals.forEach(s => {
                                msg += `- ${s.signal_type}: ${s.reason} (${s.confidence}%)\n`;
                            });
                        } else {
                            msg += 'No exit signals detected.\n';
                        }
                        if (position.scale_in?.should_scale) {
                            msg += `\nScale In: +${position.scale_in.size_pct}%`;
                        }
                        if (position.scale_out?.should_scale) {
                            msg += `\nScale Out: -${position.scale_out.size_pct}%`;
                        }
                        alert(msg);
                    }
                }
            } catch (e) {
                alert('Scan failed');
            }
        }

        function renderWatchlistCards(watchlist) {
            const container = document.getElementById('watchlist-cards-container');
            if (!watchlist || watchlist.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">Watchlist empty. Add tickers to track potential trades.</div>';
                return;
            }

            const strategyColors = {
                'conservative': 'var(--blue)',
                'aggressive': 'var(--red)',
                'core_trade': 'var(--purple)',
                'momentum': 'var(--yellow)'
            };

            container.innerHTML = `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                ${watchlist.map(item => {
                    const strategy = item.scaling_plan?.strategy || 'conservative';
                    const strategyColor = strategyColors[strategy] || 'var(--blue)';
                    const theme = item.theme || 'No Theme';

                    return `<div style="background: var(--bg-hover); border: 1px solid var(--border); border-radius: 10px; padding: 14px; border-top: 3px solid ${strategyColor};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div>
                                <div style="font-size: 1.1rem; font-weight: 700;">${item.ticker}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${theme}</div>
                            </div>
                            <span style="font-size: 0.65rem; padding: 2px 6px; background: ${strategyColor}20; color: ${strategyColor}; border-radius: 4px; text-transform: capitalize;">${strategy}</span>
                        </div>
                        ${item.thesis ? `<div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px; line-height: 1.4; max-height: 40px; overflow: hidden;">${item.thesis}</div>` : ''}
                        <div style="display: flex; gap: 6px;">
                            <button class="btn btn-primary" style="flex: 1; padding: 6px; font-size: 0.7rem;" onclick="showBuyModalFor('${item.id}', '${item.ticker}')">Enter</button>
                            <button class="btn btn-ghost" style="padding: 6px; font-size: 0.7rem;" onclick="deleteTrade('${item.id}')">‚úï</button>
                        </div>
                    </div>`;
                }).join('')}
            </div>`;
        }

        function renderTradeAlerts(highRiskTrades) {
            const container = document.getElementById('trade-alerts-container');
            if (!highRiskTrades || highRiskTrades.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = highRiskTrades.map(trade => `
                <div class="alert ${trade.risk_level === 'critical' ? 'alert-danger' : 'alert-warning'}" style="margin-bottom: 12px;">
                    <span class="alert-icon">${trade.risk_level === 'critical' ? 'üî¥' : '‚ö†Ô∏è'}</span>
                    <span><strong>${trade.ticker}</strong>: ${trade.risk_level.toUpperCase()} risk (${trade.confidence.toFixed(0)}%) - ${trade.urgency}</span>
                </div>
            `).join('');
        }

        function updatePortfolioSummary(positions) {
            let totalInvested = 0;
            let currentValue = 0;

            positions.forEach(pos => {
                totalInvested += (pos.average_cost || 0) * (pos.total_shares || 0);
                currentValue += (pos.current_price || pos.average_cost || 0) * (pos.total_shares || 0);
            });

            const totalPnl = currentValue - totalInvested;
            const pnlPct = totalInvested > 0 ? (totalPnl / totalInvested) * 100 : 0;

            document.getElementById('portfolio-invested').textContent = '$' + totalInvested.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('portfolio-value').textContent = '$' + currentValue.toLocaleString(undefined, {maximumFractionDigits: 0});

            const pnlEl = document.getElementById('portfolio-pnl');
            pnlEl.textContent = `${totalPnl >= 0 ? '+' : ''}$${totalPnl.toLocaleString(undefined, {maximumFractionDigits: 0})} (${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(1)}%)`;
            pnlEl.style.color = totalPnl >= 0 ? 'var(--green)' : 'var(--red)';
        }

        async function scanAllPositions() {
            document.getElementById('scale-opportunities').innerHTML = '<div style="color: var(--text-muted);">Scanning positions...</div>';

            try {
                const res = await fetch(`${API_BASE}/trades/scan`);
                const data = await res.json();

                if (data.ok) {
                    // Update scale opportunities
                    let scaleHtml = '';
                    const positions = data.positions || [];

                    const scaleIns = positions.filter(p => p.scale_in?.should_scale);
                    const scaleOuts = positions.filter(p => p.scale_out?.should_scale);

                    if (scaleIns.length > 0) {
                        scaleHtml += '<div style="margin-bottom: 12px;"><strong style="color: var(--green);">üìà Scale In:</strong></div>';
                        scaleIns.forEach(p => {
                            scaleHtml += `<div class="sidebar-item">
                                <span class="sidebar-label">${p.ticker}</span>
                                <span class="sidebar-value" style="color: var(--green);">+${p.scale_in.size_pct.toFixed(0)}%</span>
                            </div>`;
                        });
                    }

                    if (scaleOuts.length > 0) {
                        scaleHtml += '<div style="margin-bottom: 12px; margin-top: 16px;"><strong style="color: var(--yellow);">üìâ Scale Out:</strong></div>';
                        scaleOuts.forEach(p => {
                            scaleHtml += `<div class="sidebar-item">
                                <span class="sidebar-label">${p.ticker}</span>
                                <span class="sidebar-value" style="color: var(--yellow);">-${p.scale_out.size_pct.toFixed(0)}%</span>
                            </div>`;
                        });
                    }

                    if (!scaleHtml) {
                        scaleHtml = '<div style="color: var(--text-muted); font-size: 0.8125rem;">No scaling opportunities detected</div>';
                    }

                    document.getElementById('scale-opportunities').innerHTML = scaleHtml;

                    // Refresh positions table with updated risk levels
                    fetchTrades();
                }
            } catch (e) {
                console.warn('Scan failed:', e);
                document.getElementById('scale-opportunities').innerHTML = '<div style="color: var(--red);">Scan failed</div>';
            }
        }

        function showAddTradeModal() {
            const ticker = prompt('Ticker symbol:');
            if (!ticker) return;

            const thesis = prompt('Investment thesis (why this trade?):');
            const theme = prompt('Theme (e.g., AI Infrastructure):') || '';
            const strategy = prompt('Strategy (conservative/aggressive/core_trade/momentum):') || 'conservative';

            addTrade(ticker.toUpperCase(), thesis, theme, strategy);
        }

        async function addTrade(ticker, thesis, theme, strategy) {
            try {
                const res = await fetch(`${API_BASE}/trades/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker, thesis, theme, strategy })
                });
                const data = await res.json();

                if (data.ok) {
                    alert(`Added ${ticker} to watchlist`);
                    fetchTrades();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Failed to add trade');
            }
        }

        function showBuyModal() {
            const ticker = prompt('Ticker symbol:');
            if (!ticker) return;

            showBuyModalFor(null, ticker.toUpperCase());
        }

        function showBuyModalFor(tradeId, ticker) {
            const shares = prompt(`Shares to buy for ${ticker}:`);
            if (!shares) return;

            const price = prompt(`Price per share for ${ticker}:`);
            if (!price) return;

            const reason = prompt('Reason for buy:') || 'Manual entry';

            executeBuy(tradeId, ticker, parseInt(shares), parseFloat(price), reason);
        }

        async function executeBuy(tradeId, ticker, shares, price, reason) {
            try {
                let url = `${API_BASE}/trades/${tradeId}/buy`;

                // If no tradeId, first create the trade
                if (!tradeId) {
                    const createRes = await fetch(`${API_BASE}/trades/create`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ticker, thesis: reason })
                    });
                    const createData = await createRes.json();
                    if (!createData.ok) {
                        alert('Error creating trade: ' + createData.error);
                        return;
                    }
                    tradeId = createData.trade.id;
                    url = `${API_BASE}/trades/${tradeId}/buy`;
                }

                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shares, price, reason })
                });
                const data = await res.json();

                if (data.ok) {
                    alert(data.message);
                    fetchTrades();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Failed to execute buy');
            }
        }

        function showSellModal() {
            const ticker = prompt('Ticker symbol to sell:');
            if (!ticker) return;

            // Find trade by ticker
            alert('Please use the Sell button on a specific position');
        }

        function showSellModalFor(tradeId, ticker, maxShares) {
            const shares = prompt(`Shares to sell for ${ticker} (max: ${maxShares}):`);
            if (!shares) return;

            const price = prompt(`Price per share for ${ticker}:`);
            if (!price) return;

            const reason = prompt('Reason for sell:') || 'Manual exit';

            executeSell(tradeId, parseInt(shares), parseFloat(price), reason);
        }

        async function executeSell(tradeId, shares, price, reason) {
            try {
                const res = await fetch(`${API_BASE}/trades/${tradeId}/sell`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shares, price, reason })
                });
                const data = await res.json();

                if (data.ok) {
                    alert(data.message);
                    fetchTrades();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Failed to execute sell');
            }
        }

        async function deleteTrade(tradeId) {
            if (!confirm('Remove this trade from watchlist?')) return;

            try {
                const res = await fetch(`${API_BASE}/trades/${tradeId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();

                if (data.ok) {
                    fetchTrades();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Failed to delete trade');
            }
        }

        async function showTradeDetail(tradeId) {
            openModal('Trade Details', '<div style="text-align: center; padding: 20px;">Loading...</div>');

            try {
                const res = await fetch(`${API_BASE}/trades/${tradeId}`);
                const data = await res.json();

                if (data.ok && data.trade) {
                    const t = data.trade;
                    const pnlPct = t.unrealized_pnl_pct || ((t.current_price - t.average_cost) / t.average_cost * 100) || 0;
                    const pnlColor = pnlPct >= 0 ? 'var(--green)' : 'var(--red)';

                    const content = `
                        <div style="display: grid; gap: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: 700;">${t.ticker}</div>
                                    <div style="color: var(--text-muted);">${t.theme || 'No theme'}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.25rem; font-weight: 600; color: ${pnlColor};">${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(1)}%</div>
                                    <div style="color: var(--text-muted);">${t.status}</div>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Shares</div>
                                    <div style="font-weight: 600;">${t.total_shares}</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Avg Cost</div>
                                    <div style="font-weight: 600;">$${(t.average_cost || 0).toFixed(2)}</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Current</div>
                                    <div style="font-weight: 600;">$${(t.current_price || 0).toFixed(2)}</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Days Held</div>
                                    <div style="font-weight: 600;">${t.days_held}</div>
                                </div>
                            </div>

                            ${t.thesis ? `<div style="padding: 12px; background: var(--bg-hover); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Thesis</div>
                                <div style="font-size: 0.875rem;">${t.thesis}</div>
                            </div>` : ''}

                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Risk Level</div>
                                    <div style="font-weight: 600;">${(t.current_risk_level || 'none').toUpperCase()}</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Exit Confidence</div>
                                    <div style="font-weight: 600;">${(t.composite_exit_confidence || 0).toFixed(0)}%</div>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Strategy</div>
                                    <div style="font-weight: 600; text-transform: capitalize;">${t.scaling_plan?.strategy || 'conservative'}</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Scale-ins</div>
                                    <div style="font-weight: 600;">${t.scale_ins_used || 0}/${t.scaling_plan?.max_scale_ins || 3}</div>
                                </div>
                                <div style="background: var(--bg-hover); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Scale-outs</div>
                                    <div style="font-weight: 600;">${t.scale_outs_used || 0}</div>
                                </div>
                            </div>

                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <button class="btn btn-primary" onclick="showBuyModalFor('${t.id}', '${t.ticker}')" style="flex: 1;">Add Shares</button>
                                <button class="btn btn-ghost" onclick="showSellModalFor('${t.id}', '${t.ticker}', ${t.total_shares})" style="flex: 1;">Sell Shares</button>
                            </div>
                        </div>
                    `;
                    document.getElementById('modal-body').innerHTML = content;
                }
            } catch (e) {
                document.getElementById('modal-body').innerHTML = '<div style="color: var(--red);">Failed to load trade details</div>';
            }
        }

        async function fetchDailyReport() {
            openModal('Daily Report', '<div style="text-align: center; padding: 20px;">Generating report...</div>');

            try {
                const res = await fetch(`${API_BASE}/trades/daily-report`);
                const data = await res.json();

                if (data.ok && data.report) {
                    document.getElementById('modal-body').innerHTML = `
                        <div style="white-space: pre-wrap; line-height: 1.7; font-size: 0.875rem; font-family: monospace;">${data.report}</div>
                    `;
                } else {
                    document.getElementById('modal-body').innerHTML = '<div style="color: var(--red);">Failed to generate report</div>';
                }
            } catch (e) {
                document.getElementById('modal-body').innerHTML = '<div style="color: var(--red);">Failed to generate report</div>';
            }
        }

        // =============================================================================
        // AI ADVISOR FUNCTIONS
        // =============================================================================

        async function refreshAIAdvisor() {
            document.getElementById('ai-insight').innerHTML = '<span style="color: var(--text-muted);">Analyzing positions...</span>';

            try {
                // Get risk assessment for AI insights
                const riskRes = await fetch(`${API_BASE}/trades/risk`);
                const riskData = await riskRes.json();

                // Get scan data for market context
                const scanRes = await fetch(`${API_BASE}/trades/scan`);
                const scanData = await scanRes.json();

                if (riskData.ok && scanData.ok) {
                    const positions = scanData.positions || [];
                    const highRisk = riskData.high_risk_trades || [];

                    // Determine priority action
                    let priorityAction = 'HOLD';
                    let priorityColor = 'var(--text)';
                    if (highRisk.length > 0) {
                        const critical = highRisk.filter(t => t.risk_level === 'critical');
                        if (critical.length > 0) {
                            priorityAction = `EXIT ${critical[0].ticker}`;
                            priorityColor = 'var(--red)';
                        } else {
                            priorityAction = `REVIEW ${highRisk[0].ticker}`;
                            priorityColor = 'var(--yellow)';
                        }
                    } else {
                        const scaleIns = positions.filter(p => p.scale_in?.should_scale);
                        if (scaleIns.length > 0) {
                            priorityAction = `SCALE IN ${scaleIns[0].ticker}`;
                            priorityColor = 'var(--green)';
                        }
                    }

                    // Determine market regime based on positions
                    let regime = 'NEUTRAL';
                    let regimeColor = 'var(--text-muted)';
                    const avgPnl = positions.length > 0 ? positions.reduce((sum, p) => sum + (p.pnl_pct || 0), 0) / positions.length : 0;
                    if (avgPnl > 5) {
                        regime = 'BULLISH';
                        regimeColor = 'var(--green)';
                    } else if (avgPnl < -5) {
                        regime = 'BEARISH';
                        regimeColor = 'var(--red)';
                    }

                    // Determine overall stance
                    let stance = 'NEUTRAL';
                    let stanceColor = 'var(--text-muted)';
                    const riskLevel = riskData.overall_risk || 'none';
                    if (riskLevel === 'critical' || riskLevel === 'high') {
                        stance = 'DEFENSIVE';
                        stanceColor = 'var(--red)';
                    } else if (riskLevel === 'elevated') {
                        stance = 'CAUTIOUS';
                        stanceColor = 'var(--yellow)';
                    } else if (positions.length > 0 && avgPnl > 0) {
                        stance = 'AGGRESSIVE';
                        stanceColor = 'var(--green)';
                    }

                    document.getElementById('ai-priority-action').innerHTML = `<span style="color: ${priorityColor};">${priorityAction}</span>`;
                    document.getElementById('ai-market-regime').innerHTML = `<span style="color: ${regimeColor};">${regime}</span>`;
                    document.getElementById('ai-stance').innerHTML = `<span style="color: ${stanceColor};">${stance}</span>`;

                    // Generate insight
                    let insight = '';
                    if (positions.length === 0) {
                        insight = 'No open positions. Consider scanning for high-conviction setups with strong story scores.';
                    } else if (highRisk.length > 0) {
                        insight = `${highRisk.length} position(s) require attention. ${highRisk[0].ticker} shows ${highRisk[0].risk_level} risk level (${highRisk[0].confidence}% confidence). Consider reducing exposure.`;
                    } else {
                        const winners = positions.filter(p => (p.pnl_pct || 0) > 0);
                        const losers = positions.filter(p => (p.pnl_pct || 0) < 0);
                        insight = `Portfolio is ${winners.length > losers.length ? 'performing well' : 'mixed'}. ${winners.length} winners, ${losers.length} losers. `;
                        if (avgPnl > 10) {
                            insight += 'Consider taking partial profits on extended positions.';
                        } else if (avgPnl < -5) {
                            insight += 'Review stop levels and thesis integrity for underperformers.';
                        } else {
                            insight += 'Continue monitoring story developments and technical levels.';
                        }
                    }
                    document.getElementById('ai-insight').innerHTML = insight;
                }
            } catch (e) {
                console.warn('AI Advisor refresh failed:', e);
                document.getElementById('ai-insight').innerHTML = '<span style="color: var(--red);">Failed to load AI insights</span>';
            }
        }

        // =============================================================================
        // JOURNAL FUNCTIONS
        // =============================================================================

        async function fetchJournal() {
            try {
                const res = await fetch(`${API_BASE}/trades/journal`);
                const data = await res.json();

                if (data.ok) {
                    journalEntries = data.entries || [];
                    renderJournal(journalEntries);
                } else {
                    // Journal endpoint might not exist yet, show empty state
                    journalEntries = [];
                    renderJournal([]);
                }
            } catch (e) {
                console.warn('Journal fetch failed:', e);
                journalEntries = [];
                renderJournal([]);
            }
        }

        function filterJournal() {
            const filter = document.getElementById('journal-filter').value;
            if (filter === 'all') {
                renderJournal(journalEntries);
            } else {
                renderJournal(journalEntries.filter(e => e.entry_type === filter));
            }
        }

        function renderJournal(entries) {
            const container = document.getElementById('journal-container');

            if (!entries || entries.length === 0) {
                container.innerHTML = `<div style="text-align: center; padding: 30px;">
                    <div style="font-size: 2rem; margin-bottom: 8px;">üìì</div>
                    <div style="color: var(--text-muted);">No journal entries yet.</div>
                    <div style="color: var(--text-muted); font-size: 0.8rem; margin-top: 4px;">Document your trades, lessons, and insights.</div>
                </div>`;
                return;
            }

            const typeIcons = {
                'trade': 'üíπ',
                'note': 'üìù',
                'lesson': 'üí°',
                'mistake': '‚ö†Ô∏è'
            };
            const typeColors = {
                'trade': 'var(--blue)',
                'note': 'var(--text-muted)',
                'lesson': 'var(--green)',
                'mistake': 'var(--red)'
            };

            container.innerHTML = entries.map(entry => {
                const icon = typeIcons[entry.entry_type] || 'üìù';
                const color = typeColors[entry.entry_type] || 'var(--text-muted)';
                const date = new Date(entry.timestamp).toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
                const time = new Date(entry.timestamp).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});

                return `<div style="padding: 12px; background: var(--bg-hover); border-radius: 8px; margin-bottom: 10px; border-left: 3px solid ${color};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.1rem;">${icon}</span>
                            ${entry.ticker ? `<span style="font-weight: 600;">${entry.ticker}</span>` : ''}
                            <span style="font-size: 0.7rem; padding: 2px 6px; background: ${color}20; color: ${color}; border-radius: 4px; text-transform: capitalize;">${entry.entry_type}</span>
                        </div>
                        <span style="font-size: 0.7rem; color: var(--text-muted);">${date} ${time}</span>
                    </div>
                    <div style="font-size: 0.85rem; line-height: 1.5;">${entry.content}</div>
                    ${entry.tags && entry.tags.length > 0 ? `<div style="margin-top: 8px; display: flex; gap: 4px; flex-wrap: wrap;">
                        ${entry.tags.map(tag => `<span style="font-size: 0.65rem; padding: 2px 6px; background: var(--bg-card); border-radius: 4px; color: var(--text-muted);">#${tag}</span>`).join('')}
                    </div>` : ''}
                </div>`;
            }).join('');
        }

        function showAddJournalEntry() {
            const entryType = prompt('Entry type (trade/note/lesson/mistake):', 'note') || 'note';
            const validTypes = ['trade', 'note', 'lesson', 'mistake'];
            if (!validTypes.includes(entryType.toLowerCase())) {
                alert('Invalid type. Use: trade, note, lesson, or mistake');
                return;
            }

            const ticker = prompt('Ticker (optional, press Enter to skip):') || '';
            const content = prompt('Entry content:');
            if (!content) return;

            const tagsStr = prompt('Tags (comma-separated, optional):') || '';
            const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];

            addJournalEntry(entryType.toLowerCase(), content, ticker.toUpperCase() || null, tags);
        }

        async function addJournalEntry(entryType, content, ticker = null, tags = []) {
            try {
                const res = await fetch(`${API_BASE}/trades/journal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ entry_type: entryType, content, ticker, tags })
                });
                const data = await res.json();

                if (data.ok) {
                    fetchJournal();
                    // Also add to activity feed
                    addActivityItem(`Added ${entryType} journal entry${ticker ? ` for ${ticker}` : ''}`);
                } else {
                    alert('Failed to add entry: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed to add journal entry');
            }
        }

        // =============================================================================
        // THEME CONCENTRATION
        // =============================================================================

        function renderThemeConcentration(positions) {
            const container = document.getElementById('theme-concentration-chart');

            if (!positions || positions.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.75rem;">No positions to analyze</div>';
                return;
            }

            // Group by theme
            const themeValues = {};
            let totalValue = 0;

            positions.forEach(pos => {
                const theme = pos.theme || 'No Theme';
                const value = (pos.current_price || pos.average_cost || 0) * (pos.total_shares || 0);
                themeValues[theme] = (themeValues[theme] || 0) + value;
                totalValue += value;
            });

            if (totalValue === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.75rem;">No position values</div>';
                return;
            }

            // Sort by value
            const sortedThemes = Object.entries(themeValues).sort((a, b) => b[1] - a[1]);

            // Theme colors
            const themeColors = [
                'var(--blue)', 'var(--purple)', 'var(--green)', 'var(--yellow)',
                'var(--red)', 'var(--cyan)', 'var(--pink)', 'var(--text-muted)'
            ];

            container.innerHTML = sortedThemes.map(([theme, value], i) => {
                const pct = (value / totalValue * 100).toFixed(1);
                const color = themeColors[i % themeColors.length];

                return `<div style="margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.7rem; margin-bottom: 2px;">
                        <span style="color: ${color};">${theme}</span>
                        <span>${pct}%</span>
                    </div>
                    <div style="height: 6px; background: var(--bg-hover); border-radius: 3px; overflow: hidden;">
                        <div style="height: 100%; width: ${pct}%; background: ${color}; transition: width 0.3s;"></div>
                    </div>
                </div>`;
            }).join('');
        }

        // =============================================================================
        // PERFORMANCE METRICS
        // =============================================================================

        function updatePerformanceMetrics(positions) {
            // Calculate from positions
            const wins = positions.filter(p => (p.pnl_pct || 0) > 0);
            const losses = positions.filter(p => (p.pnl_pct || 0) < 0);

            const avgWin = wins.length > 0 ? wins.reduce((sum, p) => sum + (p.pnl_pct || 0), 0) / wins.length : 0;
            const avgLoss = losses.length > 0 ? losses.reduce((sum, p) => sum + Math.abs(p.pnl_pct || 0), 0) / losses.length : 0;

            const totalWins = wins.reduce((sum, p) => sum + (p.pnl_value || 0), 0);
            const totalLosses = Math.abs(losses.reduce((sum, p) => sum + (p.pnl_value || 0), 0));
            const profitFactor = totalLosses > 0 ? (totalWins / totalLosses).toFixed(2) : (totalWins > 0 ? '‚àû' : '--');

            const allPnl = positions.map(p => p.pnl_pct || 0);
            const bestTrade = allPnl.length > 0 ? Math.max(...allPnl) : 0;
            const worstTrade = allPnl.length > 0 ? Math.min(...allPnl) : 0;

            const avgHoldTime = positions.length > 0 ? Math.round(positions.reduce((sum, p) => sum + (p.days_held || 0), 0) / positions.length) : 0;

            document.getElementById('perf-avg-win').textContent = avgWin > 0 ? `+${avgWin.toFixed(1)}%` : '--';
            document.getElementById('perf-avg-loss').textContent = avgLoss > 0 ? `-${avgLoss.toFixed(1)}%` : '--';
            document.getElementById('perf-profit-factor').textContent = profitFactor;
            document.getElementById('perf-best').textContent = bestTrade > 0 ? `+${bestTrade.toFixed(1)}%` : '--';
            document.getElementById('perf-worst').textContent = worstTrade < 0 ? `${worstTrade.toFixed(1)}%` : '--';
            document.getElementById('perf-hold-time').textContent = avgHoldTime > 0 ? `${avgHoldTime}d` : '--';
        }

        // =============================================================================
        // ACTIVITY FEED
        // =============================================================================

        let activityItems = [];

        async function fetchActivityFeed() {
            try {
                const res = await fetch(`${API_BASE}/trades/activity`);
                const data = await res.json();

                if (data.ok) {
                    activityItems = data.activities || [];
                    renderActivityFeed();
                } else {
                    // Activity endpoint might not exist, use local tracking
                    renderActivityFeed();
                }
            } catch (e) {
                // Fallback to showing recent local activity
                renderActivityFeed();
            }
        }

        function renderActivityFeed() {
            const container = document.getElementById('recent-activity');

            if (activityItems.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.8rem;">No recent activity</div>';
                return;
            }

            container.innerHTML = activityItems.slice(0, 10).map(item => {
                const time = item.timestamp ? new Date(item.timestamp).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) : 'now';
                const typeEmoji = {
                    'buy': 'üìà',
                    'sell': 'üìâ',
                    'create': '‚ûï',
                    'delete': 'üóëÔ∏è',
                    'scan': 'üîç',
                    'journal': 'üìì'
                }[item.type] || '‚Ä¢';

                return `<div style="padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 0.8rem;">
                    <span>${typeEmoji}</span>
                    <span>${item.message}</span>
                    <span style="color: var(--text-muted); font-size: 0.7rem; float: right;">${time}</span>
                </div>`;
            }).join('');
        }

        function addActivityItem(message, type = 'general') {
            activityItems.unshift({
                message,
                type,
                timestamp: new Date().toISOString()
            });
            renderActivityFeed();
        }

        async function refreshAll() {
            document.getElementById('last-update').textContent = 'Refreshing...';

            await Promise.all([
                fetchHealth(),
                fetchScan(),
                fetchConvictionAlerts(),
                fetchSupplyChain(),
                fetchEarnings(),
                fetchEvolution(),
                fetchParameters(),
                fetchCorrelations(),
                fetchThemes(),
                fetchMARadar(),
                fetchDeals(),
                fetchContractThemes(),
                fetchRecentContracts(),
                fetchPatentThemes(),
                fetchThemeRadar(),
                fetchThemeAlerts(),
                fetchTrades(),
            ]);

            document.getElementById('last-update').textContent = new Date().toLocaleTimeString('en-MY', {
                timeZone: 'Asia/Kuala_Lumpur',
                hour: '2-digit',
                minute: '2-digit'
            }) + ' MYT';
        }

        // =============================================================================
        // WATCHLIST FUNCTIONS
        // =============================================================================

        window.watchlistData = [];

        async function loadWatchlist() {
            try {
                const res = await fetch(`${API_BASE}/watchlist/`);
                const data = await res.json();

                if (data.ok) {
                    window.watchlistData = data.items || [];

                    // Update statistics
                    const stats = data.statistics || {};
                    document.getElementById('watchlist-stat-total').textContent = stats.total_items || 0;
                    document.getElementById('watchlist-stat-ready').textContent = stats.ready_to_trade || 0;
                    document.getElementById('watchlist-stat-high').textContent = stats.by_priority?.high || 0;

                    renderWatchlistTable(window.watchlistData);
                } else {
                    console.warn('Load watchlist failed:', data.error);
                }
            } catch (e) {
                console.warn('Load watchlist error:', e);
                document.getElementById('watchlist-table-body').innerHTML =
                    '<tr><td colspan="10" style="text-align: center; color: var(--text-muted); padding: 24px;">Failed to load watchlist</td></tr>';
            }
        }

        async function addToWatchlist(stockData) {
            try {
                const res = await fetch(`${API_BASE}/watchlist/scan`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({results: [stockData]})
                });

                const data = await res.json();

                if (data.ok) {
                    addActivityItem(`Added ${stockData.ticker} to watchlist`, 'create');
                    await loadWatchlist();
                } else {
                    alert('Failed to add to watchlist: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Add to watchlist error:', e);
                alert('Failed to add to watchlist');
            }
        }

        function editWatchlistItem(ticker) {
            // Find the item
            const item = window.watchlistData.find(i => i.ticker === ticker);
            if (!item) return;

            const notes = prompt('Notes:', item.notes || '');
            if (notes === null) return; // Cancelled

            const thesis = prompt('Thesis:', item.thesis || '');
            if (thesis === null) return;

            const catalyst = prompt('Catalyst:', item.catalyst || '');
            if (catalyst === null) return;

            const priority = prompt('Priority (high/medium/low):', item.priority || 'medium');
            if (priority === null) return;

            const targetEntry = prompt('Target Entry Price:', item.target_entry || '');
            const stopLoss = prompt('Stop Loss:', item.stop_loss || '');

            updateWatchlistItem(ticker, {
                notes,
                thesis,
                catalyst,
                priority,
                target_entry: targetEntry ? parseFloat(targetEntry) : null,
                stop_loss: stopLoss ? parseFloat(stopLoss) : null
            });
        }

        async function updateWatchlistItem(ticker, updates) {
            try {
                const res = await fetch(`${API_BASE}/watchlist/${ticker}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updates)
                });

                const data = await res.json();

                if (data.ok) {
                    addActivityItem(`Updated ${ticker} in watchlist`, 'general');
                    await loadWatchlist();
                } else {
                    alert('Failed to update: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Update error:', e);
                alert('Failed to update watchlist item');
            }
        }

        async function deleteWatchlistItem(ticker) {
            if (!confirm(`Remove ${ticker} from watchlist?`)) return;

            try {
                const res = await fetch(`${API_BASE}/watchlist/${ticker}`, {
                    method: 'DELETE'
                });

                const data = await res.json();

                if (data.ok) {
                    addActivityItem(`Removed ${ticker} from watchlist`, 'delete');
                    await loadWatchlist();
                } else {
                    alert('Failed to delete: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Delete error:', e);
                alert('Failed to delete watchlist item');
            }
        }

        async function updateSentiment(ticker) {
            try {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = 'Updating...';

                const res = await fetch(`${API_BASE}/watchlist/update/sentiment/${ticker}`, {
                    method: 'POST'
                });

                const data = await res.json();

                if (data.ok) {
                    btn.textContent = '‚úì Updated';
                    addActivityItem(`Updated X sentiment for ${ticker}`, 'general');
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                        loadWatchlist();
                    }, 1500);
                } else {
                    btn.textContent = '‚ùå Failed';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 2000);
                }
            } catch (e) {
                console.error('Update sentiment error:', e);
                alert('Failed to update sentiment');
            }
        }

        async function updateAI(ticker) {
            try {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = 'Analyzing...';

                const res = await fetch(`${API_BASE}/watchlist/update/ai/${ticker}`, {
                    method: 'POST'
                });

                const data = await res.json();

                if (data.ok) {
                    btn.textContent = '‚úì Updated';
                    addActivityItem(`Updated AI analysis for ${ticker}`, 'general');
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                        loadWatchlist();
                    }, 1500);
                } else {
                    btn.textContent = '‚ùå Failed';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 2000);
                }
            } catch (e) {
                console.error('Update AI error:', e);
                alert('Failed to update AI analysis');
            }
        }

        async function updateAllPrices() {
            try {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = 'Updating...';

                const res = await fetch(`${API_BASE}/watchlist/update/prices`, {
                    method: 'POST'
                });

                const data = await res.json();

                if (data.ok) {
                    btn.textContent = '‚úì Updated';
                    addActivityItem('Updated all watchlist prices', 'general');
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                        loadWatchlist();
                    }, 1500);
                } else {
                    btn.textContent = '‚ùå Failed';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 2000);
                }
            } catch (e) {
                console.error('Update prices error:', e);
                alert('Failed to update prices');
            }
        }

        function filterWatchlist() {
            const priority = document.getElementById('watchlist-filter-priority').value;
            let filtered = window.watchlistData || [];

            if (priority) {
                filtered = filtered.filter(item => item.priority === priority);
            }

            renderWatchlistTable(filtered);
        }

        function searchWatchlist(query) {
            if (!query) {
                renderWatchlistTable(window.watchlistData);
                return;
            }

            const q = query.toLowerCase();
            const filtered = (window.watchlistData || []).filter(item =>
                item.ticker.toLowerCase().includes(q) ||
                (item.notes && item.notes.toLowerCase().includes(q)) ||
                (item.thesis && item.thesis.toLowerCase().includes(q)) ||
                (item.catalyst && item.catalyst.toLowerCase().includes(q))
            );

            renderWatchlistTable(filtered);
        }

        function renderWatchlistTable(items) {
            const tbody = document.getElementById('watchlist-table-body');

            if (!items || items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: var(--text-muted); padding: 24px;">No watchlist items</td></tr>';
                return;
            }

            // Sort by priority (high > medium > low) then by overall_score
            const sortedItems = [...items].sort((a, b) => {
                const priorityOrder = {high: 0, medium: 1, low: 2};
                const priorityDiff = (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99);
                if (priorityDiff !== 0) return priorityDiff;
                return (b.overall_score || 0) - (a.overall_score || 0);
            });

            tbody.innerHTML = sortedItems.map(item => {
                const priceColor = (item.price_change_pct || 0) >= 0 ? 'var(--green)' : 'var(--red)';
                const priceSign = (item.price_change_pct || 0) >= 0 ? '+' : '';

                const priorityColors = {
                    high: 'var(--red)',
                    medium: 'var(--yellow)',
                    low: 'var(--text-muted)'
                };

                const qualityColors = {
                    excellent: 'var(--green)',
                    good: 'var(--blue)',
                    fair: 'var(--yellow)',
                    poor: 'var(--red)',
                    unknown: 'var(--text-muted)'
                };

                const sentimentEmoji = {
                    bullish: 'üü¢',
                    neutral: '‚ö™',
                    bearish: 'üî¥'
                };

                const aiDecisionEmoji = {
                    buy: 'üü¢',
                    hold: '‚ö™',
                    sell: 'üî¥'
                };

                return `
                    <tr>
                        <td class="ticker-cell" onclick="showTicker('${item.ticker}')">${item.ticker}</td>
                        <td>$${item.current_price?.toFixed(2) || 'N/A'}</td>
                        <td style="color: ${priceColor};">${priceSign}${(item.price_change_pct || 0).toFixed(2)}%</td>
                        <td style="color: ${priorityColors[item.priority] || 'var(--text)'}; font-weight: 600;">${item.priority || 'medium'}</td>
                        <td>
                            <strong style="font-size: 1.1em; color: ${qualityColors[item.signal_quality] || 'var(--text)'};">
                                ${item.overall_score !== null && item.overall_score !== undefined ? item.overall_score + '/10' : 'N/A'}
                            </strong>
                        </td>
                        <td style="color: ${qualityColors[item.signal_quality] || 'var(--text)'};">${item.signal_quality || 'unknown'}</td>
                        <td style="text-align: center; font-size: 1.2em;">
                            ${item.setup_complete ? '<span style="color: var(--green);">‚úì</span>' : '<span style="color: var(--text-muted);">-</span>'}
                        </td>
                        <td>${sentimentEmoji[item.x_sentiment] || '‚ö™'} ${item.x_sentiment || 'neutral'}</td>
                        <td>${aiDecisionEmoji[item.ai_decision] || '‚ö™'} ${item.ai_decision || 'hold'}</td>
                        <td>
                            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                <button class="btn btn-ghost" style="padding: 2px 6px; font-size: 0.7rem;" onclick="editWatchlistItem('${item.ticker}')">Edit</button>
                                <button class="btn btn-ghost" style="padding: 2px 6px; font-size: 0.7rem;" onclick="updateSentiment('${item.ticker}')">üí¨ X</button>
                                <button class="btn btn-ghost" style="padding: 2px 6px; font-size: 0.7rem;" onclick="updateAI('${item.ticker}')">ü§ñ AI</button>
                                <button class="btn btn-ghost" style="padding: 2px 6px; font-size: 0.7rem; color: var(--red);" onclick="deleteWatchlistItem('${item.ticker}')">‚úï</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            refreshAll();

            // Initialize sync client
            setTimeout(() => {
                syncClient.connect();
            }, 1000);
        });
        // =============================================================================
        // LEARNING DASHBOARD FUNCTIONS
        // =============================================================================

        // Chart instances (global)
        let weightsChart = null;
        let componentPerfChart = null;
        let weightsEvolutionChart = null;
        let regimeProbsChart = null;
        let learnerSelectionChart = null;
        let learnerPerfChart = null;

        // Learning data cache
        let learningData = {
            statistics: null,
            weights: null,
            regime: null,
            performance: null
        };

        // Initialize learning dashboard when tab is activated
        function initLearningDashboard() {
            console.log('Initializing learning dashboard...');
            createAllCharts();
            refreshLearningDashboard();
        }

        // Create all chart instances
        function createAllCharts() {
            // Component Weights (Doughnut)
            const weightsCtx = document.getElementById('weights-chart');
            if (weightsCtx && !weightsChart) {
                weightsChart = new Chart(weightsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Theme', 'Technical', 'AI', 'Sentiment'],
                        datasets: [{
                            data: [30, 25, 25, 20],
                            backgroundColor: [
                                'rgba(168, 85, 247, 0.8)',
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(234, 179, 8, 0.8)'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { color: '#fafafa', font: { size: 12 } }
                            }
                        }
                    }
                });
            }

            // Component Performance (Bar)
            const compPerfCtx = document.getElementById('component-performance-chart');
            if (compPerfCtx && !componentPerfChart) {
                componentPerfChart = new Chart(compPerfCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Theme', 'Technical', 'AI', 'Sentiment'],
                        datasets: [{
                            label: 'Win Probability',
                            data: [0.65, 0.58, 0.62, 0.55],
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1,
                                ticks: {
                                    color: '#a1a1aa',
                                    callback: function(value) { return (value * 100) + '%'; }
                                },
                                grid: { color: '#27272a' }
                            },
                            x: {
                                ticks: { color: '#a1a1aa' },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }

            // Weights Evolution Over Time (Line)
            const weightsEvolCtx = document.getElementById('weights-evolution-chart');
            if (weightsEvolCtx && !weightsEvolutionChart) {
                weightsEvolutionChart = new Chart(weightsEvolCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Theme',
                                data: [],
                                borderColor: 'rgba(168, 85, 247, 1)',
                                backgroundColor: 'rgba(168, 85, 247, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Technical',
                                data: [],
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'AI',
                                data: [],
                                borderColor: 'rgba(34, 197, 94, 1)',
                                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Sentiment',
                                data: [],
                                borderColor: 'rgba(234, 179, 8, 1)',
                                backgroundColor: 'rgba(234, 179, 8, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1,
                                ticks: {
                                    color: '#a1a1aa',
                                    callback: function(value) { return (value * 100) + '%'; }
                                },
                                grid: { color: '#27272a' }
                            },
                            x: {
                                ticks: { color: '#a1a1aa' },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { color: '#fafafa', font: { size: 11 } }
                            }
                        }
                    }
                });
            }

            // Regime Probabilities (Bar)
            const regimeProbsCtx = document.getElementById('regime-probabilities-chart');
            if (regimeProbsCtx && !regimeProbsChart) {
                regimeProbsChart = new Chart(regimeProbsCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Bull', 'Bear', 'Choppy', 'Crisis', 'Theme'],
                        datasets: [{
                            label: 'Probability',
                            data: [0.2, 0.2, 0.2, 0.2, 0.2],
                            backgroundColor: [
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(234, 179, 8, 0.8)',
                                'rgba(220, 38, 38, 0.8)',
                                'rgba(168, 85, 247, 0.8)'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1,
                                ticks: {
                                    color: '#a1a1aa',
                                    callback: function(value) { return (value * 100) + '%'; }
                                },
                                grid: { color: '#27272a' }
                            },
                            x: {
                                ticks: { color: '#a1a1aa' },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }

            // Learner Selection (Doughnut)
            const learnerSelCtx = document.getElementById('learner-selection-chart');
            if (learnerSelCtx && !learnerSelectionChart) {
                learnerSelectionChart = new Chart(learnerSelCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Conservative', 'Aggressive', 'Balanced'],
                        datasets: [{
                            data: [33, 33, 34],
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(34, 197, 94, 0.8)'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { color: '#fafafa', font: { size: 12 } }
                            }
                        }
                    }
                });
            }

            // Learner Performance (Bar)
            const learnerPerfCtx = document.getElementById('learner-performance-chart');
            if (learnerPerfCtx && !learnerPerfChart) {
                learnerPerfChart = new Chart(learnerPerfCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Conservative', 'Aggressive', 'Balanced'],
                        datasets: [{
                            label: 'Sharpe Ratio',
                            data: [1.2, 0.9, 1.5],
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(34, 197, 94, 0.8)'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#a1a1aa' },
                                grid: { color: '#27272a' }
                            },
                            x: {
                                ticks: { color: '#a1a1aa' },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
        }

        // Refresh all learning data and charts
        async function refreshLearningDashboard() {
            try {
                const statsRes = await fetch(`${API_BASE}/learning/statistics`).catch(() => null);
                const weightsRes = await fetch(`${API_BASE}/learning/weights`).catch(() => null);
                const regimeRes = await fetch(`${API_BASE}/learning/regime`).catch(() => null);
                const perfRes = await fetch(`${API_BASE}/learning/performance`).catch(() => null);

                if (statsRes && statsRes.ok) {
                    learningData.statistics = await statsRes.json();
                    updateStatistics(learningData.statistics);

                    // Update meta-learner charts if Tier 4 data available
                    if (learningData.statistics.statistics?.meta_learner) {
                        updateMetaLearner(learningData.statistics.statistics.meta_learner);
                    }
                }

                if (weightsRes && weightsRes.ok) {
                    learningData.weights = await weightsRes.json();
                    updateWeights(learningData.weights);
                }

                if (regimeRes && regimeRes.ok) {
                    learningData.regime = await regimeRes.json();
                    updateRegime(learningData.regime);
                }

                if (perfRes && perfRes.ok) {
                    learningData.performance = await perfRes.json();
                    updatePerformance(learningData.performance);
                }
            } catch (error) {
                console.error('Error refreshing learning dashboard:', error);
            }
        }

        // Update functions
        function updateStatistics(data) {
            if (!data || !data.ok) return;
            const stats = data.statistics;
            if (!stats) return;

            document.getElementById('learning-stat-trades').textContent = stats.overview?.total_trades || 0;
            document.getElementById('learning-stat-active').textContent = stats.overview?.learning_active ? '‚úì' : '‚úó';

            const breakerEl = document.getElementById('learning-stat-breaker');
            if (stats.overview?.circuit_breaker_active) {
                breakerEl.textContent = 'üî¥ ACTIVE';
                breakerEl.style.color = 'var(--red)';
            } else {
                breakerEl.textContent = 'üü¢ OK';
                breakerEl.style.color = 'var(--green)';
            }

            document.getElementById('learning-stat-regime').textContent =
                (stats.overview?.current_regime || 'unknown').replace('_', ' ');
        }

        function updateWeights(data) {
            if (!data || !data.ok) return;
            const weights = data.weights;
            if (!weights || !weightsChart) return;

            weightsChart.data.datasets[0].data = [
                (weights.theme || 0.3) * 100,
                (weights.technical || 0.25) * 100,
                (weights.ai || 0.25) * 100,
                (weights.sentiment || 0.2) * 100
            ];
            weightsChart.update();

            const confidence = data.confidence || 0;
            document.getElementById('weights-confidence').textContent =
                `Confidence: ${(confidence * 100).toFixed(0)}%`;
        }

        function updateRegime(data) {
            if (!data || !data.ok) return;
            const regime = data.regime || 'unknown';
            const confidence = data.confidence || 0;

            document.getElementById('regime-confidence').textContent =
                `Confidence: ${(confidence * 100).toFixed(0)}%`;

            const timeline = document.getElementById('regime-timeline');
            const regimeColors = {
                'bull_momentum': '#22c55e',
                'bear_defensive': '#ef4444',
                'choppy_range': '#eab308',
                'crisis_mode': '#dc2626',
                'theme_driven': '#a855f7',
                'unknown': '#71717a'
            };

            const color = regimeColors[regime] || regimeColors.unknown;
            timeline.innerHTML = `
                <div style="padding: 16px; background: ${color}20; border-left: 4px solid ${color}; border-radius: 4px;">
                    <div style="font-size: 1.25rem; font-weight: 600; color: ${color}; margin-bottom: 8px;">
                        ${regime.replace('_', ' ').toUpperCase()}
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-muted);">
                        Confidence: ${(confidence * 100).toFixed(1)}%
                    </div>
                </div>
            `;

            // Update regime probabilities chart if available
            if (data.probabilities && regimeProbsChart) {
                const probs = data.probabilities;
                regimeProbsChart.data.datasets[0].data = [
                    probs.bull_momentum || 0,
                    probs.bear_defensive || 0,
                    probs.choppy_range || 0,
                    probs.crisis_mode || 0,
                    probs.theme_driven || 0
                ];
                regimeProbsChart.update();
            }
        }

        function updatePerformance(data) {
            if (!data || !data.ok) return;
            const metrics = data.metrics;
            if (!metrics) return;

            const sharpe = metrics.sharpe_ratio || 0;
            document.getElementById('metric-sharpe').textContent = sharpe.toFixed(2);
            document.getElementById('metric-sharpe').style.color =
                sharpe >= 1.5 ? 'var(--green)' : sharpe >= 0.8 ? 'var(--yellow)' : 'var(--red)';

            const winRate = metrics.win_rate || 0;
            document.getElementById('metric-winrate').textContent = (winRate * 100).toFixed(0) + '%';
            document.getElementById('metric-winrate').style.color =
                winRate >= 0.65 ? 'var(--green)' : winRate >= 0.55 ? 'var(--yellow)' : 'var(--red)';

            const pf = metrics.profit_factor || 0;
            document.getElementById('metric-pf').textContent = pf.toFixed(2);
            document.getElementById('metric-pf').style.color =
                pf >= 2.0 ? 'var(--green)' : pf >= 1.5 ? 'var(--yellow)' : 'var(--red)';

            const dd = Math.abs(metrics.max_drawdown || 0);
            document.getElementById('metric-dd').textContent = dd.toFixed(1) + '%';
            document.getElementById('metric-dd').style.color =
                dd <= 10 ? 'var(--green)' : dd <= 15 ? 'var(--yellow)' : 'var(--red)';

            // Update weights evolution chart if data available
            if (data.weights_history && weightsEvolutionChart) {
                updateWeightsEvolution(data.weights_history);
            }
        }

        function updateWeightsEvolution(history) {
            if (!history || !weightsEvolutionChart) return;

            // Extract last 50 data points
            const labels = [];
            const themeData = [];
            const technicalData = [];
            const aiData = [];
            const sentimentData = [];

            const maxPoints = 50;
            const startIdx = Math.max(0, history.length - maxPoints);

            for (let i = startIdx; i < history.length; i++) {
                const entry = history[i];
                labels.push(entry.trade_number || i + 1);
                themeData.push(entry.weights.theme || 0.3);
                technicalData.push(entry.weights.technical || 0.25);
                aiData.push(entry.weights.ai || 0.25);
                sentimentData.push(entry.weights.sentiment || 0.2);
            }

            weightsEvolutionChart.data.labels = labels;
            weightsEvolutionChart.data.datasets[0].data = themeData;
            weightsEvolutionChart.data.datasets[1].data = technicalData;
            weightsEvolutionChart.data.datasets[2].data = aiData;
            weightsEvolutionChart.data.datasets[3].data = sentimentData;
            weightsEvolutionChart.update();
        }

        function updateMetaLearner(data) {
            if (!data || !learnerSelectionChart || !learnerPerfChart) return;

            // Update learner selection frequency
            if (data.learner_selection) {
                const selection = data.learner_selection;
                learnerSelectionChart.data.datasets[0].data = [
                    selection.conservative || 0,
                    selection.aggressive || 0,
                    selection.balanced || 0
                ];
                learnerSelectionChart.update();
            }

            // Update learner performance
            if (data.learner_performance) {
                const perf = data.learner_performance;
                learnerPerfChart.data.datasets[0].data = [
                    perf.conservative?.sharpe || 0,
                    perf.aggressive?.sharpe || 0,
                    perf.balanced?.sharpe || 0
                ];
                learnerPerfChart.update();
            }
        }

        // Control functions
        async function toggleCircuitBreaker() {
            try {
                const currentActive = learningData.statistics?.statistics?.overview?.circuit_breaker_active || false;
                const res = await fetch(`${API_BASE}/learning/circuit-breaker`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({active: !currentActive})
                });

                if (res.ok) {
                    alert(`Circuit breaker ${!currentActive ? 'activated' : 'deactivated'}`);
                    refreshLearningDashboard();
                }
            } catch (error) {
                console.error('Toggle circuit breaker error:', error);
            }
        }

        async function exportLearningData() {
            try {
                const res = await fetch(`${API_BASE}/learning/statistics`);
                const data = await res.json();

                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `learning_data_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Export error:', error);
            }
        }

        async function viewFullReport() {
            try {
                const res = await fetch(`${API_BASE}/learning/report`);
                const data = await res.json();
                if (data.ok) {
                    const win = window.open('', '_blank', 'width=800,height=600');
                    win.document.write('<pre style="background: #09090b; color: #fafafa; padding: 20px; font-family: monospace;">' + data.report + '</pre>');
                }
            } catch (error) {
                console.error('View report error:', error);
            }
        }

        // =============================================================================
        // INTELLIGENCE DASHBOARD
        // =============================================================================

        let xSentimentChart, trendsChart, contractsChart, patentsChart, catalystChart;

        async function initIntelligenceDashboard() {
            // Initialize X Sentiment chart
            const xCtx = document.getElementById('xSentimentChart').getContext('2d');
            xSentimentChart = new Chart(xCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sentiment Score',
                        data: [],
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {color: '#fafafa'}
                        },
                        x: {ticks: {color: '#fafafa'}}
                    },
                    plugins: {
                        legend: {labels: {color: '#fafafa'}},
                        title: {
                            display: true,
                            text: 'X Sentiment Scores (Last 24h)',
                            color: '#fafafa'
                        }
                    }
                }
            });

            // Initialize Google Trends chart
            const trendsCtx = document.getElementById('trendsChart').getContext('2d');
            trendsChart = new Chart(trendsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Search Interest',
                        data: [],
                        backgroundColor: 'rgba(34, 197, 94, 0.5)',
                        borderColor: 'rgb(34, 197, 94)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {color: '#fafafa'}
                        },
                        x: {ticks: {color: '#fafafa'}}
                    },
                    plugins: {
                        legend: {labels: {color: '#fafafa'}},
                        title: {
                            display: true,
                            text: 'Google Trends - Search Interest',
                            color: '#fafafa'
                        }
                    }
                }
            });

            // Initialize Contracts chart
            const contractsCtx = document.getElementById('contractsChart').getContext('2d');
            contractsChart = new Chart(contractsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Contract Value ($M)',
                        data: [],
                        backgroundColor: 'rgba(168, 85, 247, 0.5)',
                        borderColor: 'rgb(168, 85, 247)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {color: '#fafafa'}
                        },
                        x: {ticks: {color: '#fafafa'}}
                    },
                    plugins: {
                        legend: {labels: {color: '#fafafa'}},
                        title: {
                            display: true,
                            text: 'Government Contracts',
                            color: '#fafafa'
                        }
                    }
                }
            });

            // Initialize Patents chart
            const patentsCtx = document.getElementById('patentsChart').getContext('2d');
            patentsChart = new Chart(patentsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Patent Filings',
                        data: [],
                        backgroundColor: 'rgba(251, 191, 36, 0.2)',
                        borderColor: 'rgb(251, 191, 36)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {color: '#fafafa'}
                        },
                        x: {ticks: {color: '#fafafa'}}
                    },
                    plugins: {
                        legend: {labels: {color: '#fafafa'}},
                        title: {
                            display: true,
                            text: 'Patent Activity',
                            color: '#fafafa'
                        }
                    }
                }
            });

            // Initialize Catalyst Sources chart
            const catalystCtx = document.getElementById('catalystChart').getContext('2d');
            catalystChart = new Chart(catalystCtx, {
                type: 'doughnut',
                data: {
                    labels: ['X Sentiment', 'Google Trends', 'Contracts', 'Patents', 'Supply Chain', 'News', 'SEC', 'Social', 'Price', 'Volume'],
                    datasets: [{
                        data: [10, 10, 10, 10, 10, 10, 10, 10, 10, 10],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(168, 85, 247, 0.8)',
                            'rgba(251, 191, 36, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(20, 184, 166, 0.8)',
                            'rgba(249, 115, 22, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(107, 114, 128, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {color: '#fafafa'}
                        },
                        title: {
                            display: true,
                            text: 'Catalyst Sources Distribution',
                            color: '#fafafa'
                        }
                    }
                }
            });

            // Load initial data
            await refreshXSentiment();
            await refreshGoogleTrends();
            await loadSupplyChain('ai_infrastructure');
            await loadCatalystBreakdown();
        }

        async function refreshXSentiment() {
            try {
                const res = await fetch(`${API_BASE}/intelligence/x-sentiment`);
                if (!res.ok) {
                    console.warn('X sentiment endpoint not available');
                    return;
                }

                const data = await res.json();

                // Update chart
                const tickers = data.tickers || [];
                xSentimentChart.data.labels = tickers.map(t => t.ticker);
                xSentimentChart.data.datasets[0].data = tickers.map(t => t.sentiment_score);
                xSentimentChart.update();

                // Update stats
                document.getElementById('xSentimentCount').textContent = tickers.length;

                // Update list
                const listEl = document.getElementById('xSentimentList');
                if (tickers.length > 0) {
                    listEl.innerHTML = tickers.slice(0, 5).map(t => `
                        <div class="p-3 bg-zinc-900 rounded border border-zinc-800">
                            <div class="flex justify-between items-center">
                                <span class="font-bold">${t.ticker}</span>
                                <span class="text-sm ${t.sentiment === 'bullish' ? 'text-green-400' : t.sentiment === 'bearish' ? 'text-red-400' : 'text-gray-400'}">
                                    ${t.sentiment.toUpperCase()}
                                </span>
                            </div>
                            <div class="text-sm text-gray-400 mt-1">${t.mentions} mentions ‚Ä¢ Score: ${t.sentiment_score.toFixed(2)}</div>
                            ${t.viral_posts.length > 0 ? `<div class="text-xs text-blue-400 mt-1">üî• ${t.viral_posts.length} viral posts</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    listEl.innerHTML = '<div class="text-gray-400">No X sentiment data available</div>';
                }
            } catch (error) {
                console.error('X sentiment error:', error);
            }
        }

        async function refreshGoogleTrends() {
            try {
                const res = await fetch(`${API_BASE}/intelligence/google-trends`);
                if (!res.ok) {
                    console.warn('Google Trends endpoint not available');
                    return;
                }

                const data = await res.json();

                // Update chart
                const tickers = data.tickers || [];
                trendsChart.data.labels = tickers.map(t => t.ticker);
                trendsChart.data.datasets[0].data = tickers.map(t => t.search_interest);
                trendsChart.update();

                // Update stats
                const breakouts = tickers.filter(t => t.is_breakout);
                document.getElementById('trendsBreakouts').textContent = breakouts.length;

                // Update breakout list
                const listEl = document.getElementById('trendsBreakoutList');
                if (breakouts.length > 0) {
                    listEl.innerHTML = breakouts.slice(0, 5).map(t => `
                        <div class="p-3 bg-zinc-900 rounded border border-zinc-800">
                            <div class="flex justify-between items-center">
                                <span class="font-bold">${t.ticker}</span>
                                <span class="text-sm text-yellow-400">üî• BREAKOUT</span>
                            </div>
                            <div class="text-sm text-gray-400 mt-1">
                                Search Interest: ${t.search_interest}/100 ‚Ä¢ ${t.trend_direction === 'rising' ? 'üìà' : '‚û°Ô∏è'} ${t.trend_direction.toUpperCase()}
                            </div>
                        </div>
                    `).join('');
                } else {
                    listEl.innerHTML = '<div class="text-gray-400">No breakouts detected</div>';
                }
            } catch (error) {
                console.error('Google Trends error:', error);
            }
        }

        async function loadSupplyChain(themeId) {
            try {
                const res = await fetch(`${API_BASE}/intelligence/supply-chain/${themeId}`);
                if (!res.ok) {
                    console.warn('Supply chain endpoint not available');
                    return;
                }

                const data = await res.json();
                const chain = data.chain || {};

                // Update supply chain visualizer
                const vizEl = document.getElementById('supplyChainViz');
                vizEl.innerHTML = Object.entries(chain).map(([role, tickers]) => `
                    <div class="mb-4">
                        <div class="text-sm font-semibold text-blue-400 mb-2">${role.toUpperCase()}</div>
                        <div class="flex flex-wrap gap-2">
                            ${tickers.map(ticker => `
                                <span class="px-3 py-1 bg-zinc-900 border border-zinc-800 rounded text-sm">${ticker}</span>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Supply chain error:', error);
            }
        }

        async function loadCatalystBreakdown() {
            try {
                const res = await fetch(`${API_BASE}/intelligence/catalyst-breakdown`);
                if (!res.ok) {
                    console.warn('Catalyst breakdown endpoint not available');
                    return;
                }

                const data = await res.json();
                const sources = data.sources || {};

                // Update chart
                const labels = Object.keys(sources);
                const values = Object.values(sources);
                catalystChart.data.labels = labels;
                catalystChart.data.datasets[0].data = values;
                catalystChart.update();

                // Update breakdown list
                const listEl = document.getElementById('catalystBreakdownList');
                listEl.innerHTML = labels.map((label, i) => `
                    <div class="flex justify-between items-center p-2 bg-zinc-900 rounded">
                        <span class="text-sm">${label}</span>
                        <span class="text-sm font-bold text-blue-400">${values[i]}%</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Catalyst breakdown error:', error);
            }
        }
    </script>
</body>
</html>
